---
title: "IMC Pipeline - Adult"
author: "Sarah Bangerth"
date: "2023-06-09"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd('/users/sarahbangerth/Desktop/IMC/Adult IMC Output')

## Libraries
library(readr)
library(tidyverse)
library(cytofkit2)
library(ggplot2)
library(ggplotify)
library(dplyr)
library(lubridate)
library(cytomapper)
library(imcRtools)
library(Seurat)
library(raster)
library(bioimagetools)
library(cowplot)
library(CATALYST)
library(ComplexHeatmap)
library(ggpubr)
library(circlize)
library(scales)
library(BiocParallel)
library(ggridges)
library(glmnet)
library(pROC)
library(ROCR)
library(caTools)
library(tidymodels)
library(Rtsne)
library(caret)
library(igraph)
library(ggraph)
library(RColorBrewer)
```

# Read in data and get it analysis ready

```{r}
sce_adult = imcRtools::read_steinbock(path="/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/Mesmer",
                             intensities_folder = "intensities",
                             regionprops_folder = "regionprops",
                             graphs_folder = "neighbors",
                             pattern = NULL,
                             extract_cellid_from = "Object",
                             extract_coords_from = c("centroid-1", "centroid-0"),
                             image_file = "images.csv",
                             extract_imagemetadata_from = c("width_px", "height_px"),
                             panel_file = "panel.csv",
                             extract_names_from = "name",
                             return_as = "sce")
assay(sce_adult, "exprs") = asinh(counts(sce_adult)/5)

colData(sce_adult)

# Add unique column name identifiers
colnames(sce_adult) = str_c(colData(sce_adult)$sample_id, '_Cell_',
                              colData(sce_adult)$ObjectNumber)

dim(sce_adult)
unique(sce_adult$sample_id)

# Add patient label
colData(sce_adult)$Patient = as.vector(str_extract_all(sce_adult$sample_id, "SP_?[0-9]+_[0-9]+A?1?", simplify = TRUE))

### Adjust one sample
sce_adult[,sce_adult$sample_id == 'SP21_414_A1_001']$Patient = 'SP21_414_A1'

# Add group label
group_label = read_csv("/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/sample_metadata.csv")
head(group_label)

sce_adult$group = group_label$group[match(sce_adult$Patient, group_label$Patient)]
unique(sce_adult[,is.na(sce_adult$group)]$Patient)
unique(sce_adult$group)

sce_adult[,sce_adult$group == 'NO REJ']$group = 'NR'

# Checking to make sure all ROIs were assigned a group label
unique(sce_adult[,is.na(sce_adult$group)]$sample_id)

# Set group order for plots
sce_adult$group = factor(sce_adult$group, levels=c('NR','TCMR','CR'))
sce_adult$group

# Number of ROIs
unique(sce_adult$sample_id)

unique(sce_adult[,sce_adult$group=='NR']$sample_id)
unique(sce_adult[,sce_adult$group=='TCMR']$sample_id)
unique(sce_adult[,sce_adult$group=='CR']$sample_id)

# Number of cells per ROI
plotCounts(sce_adult, group_by = "sample_id", color_by='group') + 
  xlab('ROI') + ylab('# of cells') +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=20),
        plot.title=element_text(size = 20, hjust = 0.5),
        aspect.ratio=0.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5))

# Number of cells per Patient
plotCounts(sce_adult, group_by = "Patient", color_by='group') +
  xlab('Patient') + ylab('# of cells') +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=20),
        plot.title=element_text(size = 20, hjust = 0.5),
        aspect.ratio=0.4,
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5))
```

# Data Standardization by Marker

Standardize data so that each marker has a mean of 0 and a SD of 1.

```{r}
assay(sce_adult,'exprs') = t(scale(t(assay(sce_adult,'exprs'))))
```

# Clustering into Metaclusters

```{r}
markers_to_include = c('CD66b','CD20','CD28','CD16','CD163','CD11b','CD45',
                       'CD4','CD31','CD279','CD68','Foxp3',
                       'CK7','Ki67','CD8',
                       'CD3','CD138','HLADR','GranzymeB')


scaled_sce_adult = as.data.frame((t(assay(sce_adult[rownames(sce_adult) %in%
                                                                     markers_to_include,],'exprs'))))
head(scaled_sce_adult)

scaled_sce_adult = scaled_sce_adult[,c('CD4','CD8','CD20','CD11b','CD68','CD163','CD66b','CD31','CK7','CD138', #Lineage
                                             'CD28','CD16','CD45',
                                             'CD279','Foxp3','Ki67',
                                             'CD3','HLADR','GranzymeB')]
head(scaled_sce_adult)

scaled_sce_adult %>% summary()

# Identify lineage marker as well as top 3 highest expressing markers for each cell
maxn = function(n) function(x) base::order(x, decreasing = TRUE)[!is.na(x)][n]
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Lineage=apply(.[1:10], 1, function(x) names(x)[maxn(1)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Highest=apply(.[1:19], 1, function(x) names(x)[maxn(1)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Second_Highest=apply(.[1:19], 1, function(x) names(x)[maxn(2)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Third_Highest=apply(.[1:19], 1, function(x) names(x)[maxn(3)(x)]))

head(scaled_sce_adult)

# Assign cells to one of 10 meta-clusters (supervised clustering)
scaled_sce_adult = scaled_sce_adult %>% mutate(Label = case_when(

   ((Lineage=='CD31')&(CD31>0)) ~ 'Endothelial cells',

  ((Lineage=='CK7')&(CK7>0)) ~ 'Cholangiocytes',

  #####

  ((Lineage=='CD163')&(CD163>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7')))) ~ 'Macrophages',

  ((Lineage=='CD68')&(CD68>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7')))) ~ 'Macrophages',

  ((Lineage=='CD11b')&(CD68>-1)&(Second_Highest=='CD68')&(CD16<0)) ~ 'Macrophages',
  ((Lineage=='CD11b')&(CD163>-1)&(Second_Highest=='CD163')&(CD16<0)) ~ 'Macrophages',

  ####

  ((Lineage=='CD11b')&(CD11b>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163')))) ~ 'Monocytes',

  ####

  ((Lineage=='CD8')&(CD8>0)&(CD3>-1)&
     ((!Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',
  ((Lineage=='CD11b')&(CD8>0)&(Second_Highest=='CD8')) ~ 'CD8+ T-cells',

  ((Lineage %in% c('CD8','CD68','CD163'))&(CD8>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',

  ((Lineage %in% c('CD8','CD4'))&(CD8>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',

  ###

  ((Lineage=='CD4')&(CD4>0)&(CD3>-1)&
     ((!Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB')))) ~ 'CD4+ T-cells',
  ((Lineage=='CD11b')&(CD4>0)&(Second_Highest=='CD4')) ~ 'CD4+ T-cells',

  ((Lineage %in% c('CD4','CD68','CD163'))&(CD4>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB')))) ~ 'CD4+ T-cells',

  ###

  ((Lineage=='CD20')&(CD20>0)&
     ((!Highest %in% c('CD4','CD8','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD4','CD8','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD4','CD8','CD68','CD163','CD31','CK7','GranzymeB')))) ~ 'B cells',

  ((Lineage=='CD66b')&(CD66b>0)&
     ((!Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163')))) ~ 'Neutrophils',

  ((CD4<0)&(CD8<0)&(CD20<0)&(CD11b<0)&(CD68<0)&(CD163<0)&(CD66b<0)&(CD31<0)&(CK7<0)&
     (CD28<0)&(CD16<0)&(CD45<0)&(CD279<0)&(Foxp3<0)&(CD3<0)&(HLADR<0)&(GranzymeB<0)) ~ 'Hepatocytes',

  ((Lineage=='CD138')&(CD138>0)&((CD45>0)|(HLADR>0))&
     ((Highest %in% c('CD138','CD45','HLADR'))&
        (Second_Highest %in% c('CD138','CD45','HLADR')))) ~ 'Plasma cells',

  (Lineage=='CD138') ~ 'Hepatocytes',

  T ~ 'Hepatocytes'
))

# Include labels into SCE object
sce_adult$Clusters = scaled_sce_adult$Label

unique(sce_adult$Clusters)

# Create SCE labelled object and set cluster factors and levels
sce_adult_labelled = sce_adult[,sce_adult$Clusters!='Other']

sce_adult_labelled$Clusters = factor(sce_adult_labelled$Clusters,
                                           levels=c('B cells', 'CD4+ T-cells', 'CD8+ T-cells', 'Monocytes',
                                                    'Macrophages', "Neutrophils","Plasma cells",
                                                    "Endothelial cells","Cholangiocytes","Hepatocytes"))
unique(sce_adult_labelled$Clusters)
```

# Temporary metacluster heatmap

```{r}
markers_to_include = c('CD66b','CD20','CD163','CD11b',#'CD45','CD3',
                       'CD4','CD31','CD68','CK7','CD8','CD138')

marker_expression <- data.frame(t(assay(sce_adult_labelled[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(sce_adult_labelled)[,"Clusters"])
colnames(dat) = "Clusters"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Clusters) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Clusters) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Clusters
dat_sum = dat_sum[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
                    'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Clusters

m = m[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
        'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

m = m[,c('CK7','CD31','CD4','CD8','CD68','CD163','CD11b','CD66b','CD20','CD138')]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,numbers_gp = gpar(fontsize = 20),
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))


col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10), 
                     c("lightblue","#C04000","#313695","#FFEA00", "orange","#0096FF","green","#ae017e","#bf812d", "#CCCCFF"))
ha_left = HeatmapAnnotation(Metaclusters = 1:10, col = list(Metaclusters = col_fun), annotation_name_rot=45, 
                            annotation_name_gp=gpar(fontsize=25),gp = gpar(col = "black"), 
                            which='row', show_legend = FALSE)

metaclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23), #23
                                  row_names_gp = gpar(fontsize = 25),
                                  column_names_gp = gpar(fontsize = 25),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  # col = colorRamp2(c(-1, 0, 2), c("blue", "white", "red")),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=12),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(metaclusters, heatmap_legend_side = "top")
```

# Tissue Visualizations

```{r}
##################################################
################# Read in Masks ##################
##################################################

# Set path and load masks
path.to.mask = "/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/Mesmer/masks"
all_masks = loadImages(path.to.mask, pattern = ".tiff", as.is = TRUE)

# Load the metadata for the images
image_mat = as.data.frame(read.csv(file = "Data/Final/Mesmer/images.csv",stringsAsFactors = FALSE))

# Extract only the FileNames of the masks as they are in the all_masks object
cur_df = data.frame(cellmask = image_mat$image
)

# Set the rownames of the extracted data to be equal to the names of all_masks
rownames(cur_df) <- gsub(pattern = ".tiff",replacement = "",cur_df$cellmask)
cur_df$sample_id <- gsub(pattern = ".tiff",replacement = "",cur_df$cellmask)

# Add the extracted information via mcols in the order of the all_masks object
mcols(all_masks) <- cur_df[names(all_masks),]
```

```{r}
##################################################
################# Read in Images #################
##################################################

path.to.imgs = "/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/Mesmer/external"
images = loadImages(path.to.imgs, pattern = "SP13_5725_CR_001.tiff")
channelNames(images) = c("La139","Nd142","Nd144","Nd146","Sm147","Sm149","Sm152","Eu153","Sm154","Gd156","Tb159",
                         "Gd160",
                         "Dy164","Er167","Er168","Tm169","Er170","Yb172","Yb174","Lu175","Ir191","Ir193")
names(images) = 'SP13_5725'
mcols(images)$Metadata_acname = 'SP13_5725'
```


```{r}
#############################################
############ Visualize Markers ##############
#############################################

cur_images = cytomapper::normalize(scaleImages(images, 2^16-1), 
                       separateChannels = TRUE, separateImages = TRUE,
                       inputRange=list(Gd160 = c(0,15),
                                       Tb159 = c(0,400), #NR:50; TCMR:100; CR:400
                                       Eu153 = c(0,15),
                                       La139 = c(0,15),
                                       Sm149 = c(0,15),
                                       Yb172 = c(0,15),
                                       Tm169 = c(0,100),
                                       Er170 = c(0,15),
                                       Er168 = c(0,15), 
                                       Nd146 = c(0,40),
                                       Nd142 = c(0,5),
                                       Nd144 = c(0,10),
                                       Sm154 = c(0,15),
                                       Sm152 = c(0,15),
                                       Sm147 = c(0,50),
                                       Gd156 = c(0,15),
                                       Dy164 = c(0,7),
                                       Lu175 = c(0,15),
                                       Yb174 = c(0,50),
                                       Er167 = c(0,10),
                                       Ir191 = c(0,70)))

plotPixels(image=cur_images,mask=NULL, object=NULL,
           img_id = "Metadata_acname", cell_id = "ObjectNumber",
           colour_by = c("Dy164"),
           outline_by = NULL,
           colour=list(Dy164 = c("black", "yellow")),
           legend=list(colour_by.title.font=1.3,
                       colour_by.title.cex=0.6,
                       colour_by.labels.cex=1.3,
                       colour_by.legend.cex=0.6,
                       margin=0), 
           display = "single"
)
```


```{r}
#############################################
############ Visualize Clusters #############
#############################################

# All
plotCells(mask = all_masks[c(84)], #CR:9; NR:17; TCMR:84
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c(''),colour='darkgray'),
          colour = list(Clusters = c('Hepatocytes' = "lightblue",
                                     'B cells' = "#bf812d",
                                     'CD4+ T-cells' = "#FFEA00",
                                     'CD8+ T-cells' = "orange",
                                     'Monocytes' = "green",
                                     'Macrophages' = "#0096FF",
                                     'Neutrophils' = "#ae017e",
                                     'Plasma cells' = "#CCCCFF",
                                     'Endothelial cells' = "#313695",
                                     'Cholangiocytes' = "#C04000"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Tissue_ALL.tiff'),
          display = "single")

# Immune
plotCells(mask = all_masks[c(87)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c(''),colour='darkgray'),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "#bf812d",
                                     'CD4+ T-cells' = "#FFEA00",
                                     'CD8+ T-cells' = "orange",
                                     'Monocytes' = "green",
                                     'Macrophages' = "#0096FF",
                                     'Neutrophils' = "#ae017e",
                                     'Plasma cells' = "#CCCCFF",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Tissue_Immune.tiff'),
          display = "single")

# Non-Immune
plotCells(mask = all_masks[c(87)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c(''),colour='darkgray'),
          colour = list(Clusters = c('Hepatocytes' = "lightblue",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "#313695",
                                     'Cholangiocytes' = "#C04000"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Tissue_NonImmune.tiff'),
          display = "single")

# B Cells
plotCells(mask = all_masks[c(47)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "red",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/BCells.tiff'),
          display = "single")

# CD4 Cells
plotCells(mask = all_masks[c(1)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "red",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/CD4_Cells.tiff'),
          display = "single")

# CD8 Cells
plotCells(mask = all_masks[c(1)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "red",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/CD8_Cells.tiff'),
          display = "single")

# Monocytes
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "red",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Monocytes.tiff'),
          display = "single")

# Macrophages
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "red",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Macrophages.tiff'),
          display = "single")

# Neutro
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "red",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Neutro.tiff'),
          display = "single")

# Plasma Cells
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "red",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Plasma_Cells.tiff'),
          display = "single")

# Hepatocytes
plotCells(mask = all_masks[c(1,36,39)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "red",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Hepatocytes.tiff'),
          display = "single")


# Endothelial
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "red",
                                     'Cholangiocytes' = "white"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Endo.tiff'),
          display = "single")

# Cholangiocytes
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(Clusters = c('Hepatocytes' = "white",
                                     'B cells' = "white",
                                     'CD4+ T-cells' = "white",
                                     'CD8+ T-cells' = "white",
                                     'Monocytes' = "white",
                                     'Macrophages' = "white",
                                     'Neutrophils' = "white",
                                     'Plasma cells' = "white",
                                     'Endothelial cells' = "white",
                                     'Cholangiocytes' = "red"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Chol.tiff'),
          display = "single")
```

# SUB-CLUSTERING

CD4+ T Cell Population

```{r}
cd4_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD4+ T-cells']

############################################
# First separate into CD3 high and CD3 low #
############################################

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

df_cd4_cluster = as.data.frame((t(assay(cd4_cluster[rownames(cd4_cluster) %in% markers,],'exprs'))))
head(df_cd4_cluster)

df_cd4_cluster = df_cd4_cluster %>% mutate(Label = case_when(
  (CD3>0) ~ 'CD3+',
  T ~ 'CD3-'
))

head(df_cd4_cluster)

cd4_cluster$cluster_id = df_cd4_cluster$Label


# add marker expression to cells
marker_expression <- data.frame(t(assay(cd4_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd4_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")

# plot heatmap
cd4_subclusters_flowsom =  Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(cd4_subclusters_flowsom, heatmap_legend_side = "bottom")

sce_adult_labelled$CD3_expression = NA
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$cluster_id=='CD3-'])]$CD3_expression = 'CD3 Low'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$cluster_id=='CD3+'])]$CD3_expression = 'CD3 High'
sce_adult_labelled[,!colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster)]$CD3_expression = 'Non-CD4'

# Visualize on tissue
plotCells(mask = all_masks[c(14)],  # NR:14, TCMR:84
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'CD3_expression',
          outline_by = 'group',
          image_title = list(text=c('')),
          colour = list(CD3_expression = c('CD3 High' = "red",
                                     'CD3 Low' = "blue",
                                     'Non-CD4' = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/CD4_Cells.tiff'),
          display = "single")

############
# CD3-HIGH #
############
cd3high_cluster = cd4_cluster[, cd4_cluster$cluster_id == 'CD3+']

cd3high_cluster[,cd3high_cluster$group=='NR'] 
cd3high_cluster[,cd3high_cluster$group=='TCMR']
cd3high_cluster[,cd3high_cluster$group=='CR']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

set.seed(88)
cd3high_cluster = CATALYST::cluster(cd3high_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(cd3high_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd3high_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
cd3high_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd3high_subclusters_flowsom, heatmap_legend_side = "bottom")

###########
# CD3-LOW #
###########
cd3low_cluster = cd4_cluster[, cd4_cluster$cluster_id == 'CD3-']

cd3low_cluster[,cd3low_cluster$group=='NR']
cd3low_cluster[,cd3low_cluster$group=='TCMR'] 
cd3low_cluster[,cd3low_cluster$group=='CR']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

set.seed(88)
cd3low_cluster = CATALYST::cluster(cd3low_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)


# add marker expression to cells
marker_expression <- data.frame(t(assay(cd3low_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd3low_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
cd3low_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd3low_subclusters_flowsom, heatmap_legend_side = "bottom")

#################################
# Annotate clusters and combine #
#################################

cd3high_cluster$Label = NA

cd3high_cluster[,cd3high_cluster$cluster_id == 1]$Label = "HLADR+ CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id %in% c(4,7,8,9)]$Label = "CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 3]$Label = "CD4 Treg cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 2]$Label = "Proliferating CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 5]$Label = "PD1+ CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 6]$Label = "CD28+ CD3-high CD4 T cells"

unique(cd3high_cluster$Label)


cd3low_cluster$Label = NA

cd3low_cluster[,cd3low_cluster$cluster_id == 2]$Label = "HLADR+ CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id %in% c(1,4,5,8,9)]$Label = "CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id == 7]$Label = "PD1+ CD28+ CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id %in% c(3,6)]$Label = "CD16+ CD3-low CD4 T cells"

unique(cd3low_cluster$Label)


# add marker expression to cells
markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

marker_expression <- data.frame(t(assay(cd3low_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd3low_cluster)[,"Label"])
colnames(dat) = "Label"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Label) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Label) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Label

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
cd4_subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(cd4_subclusters_labelled, heatmap_legend_side = "bottom")


############################
# COMBINE CD3-HIGH AND LOW #
############################

unique(cd3high_cluster$Label)

cd4_cluster$Label = NA
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD3-high CD4 T cells')])]$Label = 'CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('Proliferating CD3-high CD4 T cells')])]$Label = 'Ki67+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('PD1+ CD3-high CD4 T cells')])]$Label = 'PD1+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD28+ CD3-high CD4 T cells')])]$Label = 'Naive CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('HLADR+ CD3-high CD4 T cells')])]$Label = 'Activated CD4+ T-cells'


unique(cd3low_cluster$Label)

cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('CD3-low CD4 T cells')])]$Label = 'Resident memory CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('PD1+ CD28+ CD3-low CD4 T cells')])]$Label = 'CD4+ Tregs'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('CD16+ CD3-low CD4 T cells')])]$Label = 'CD16+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('HLADR+ CD3-low CD4 T cells')])]$Label = 'Activated CD4+ T-cells'


unique(cd4_cluster$Label)
```


CD8+ T Cell Population

```{r}
cd8_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD8+ T-cells']

markers = c('CD28','CD16','CD11b','CD45','CD8','CD279','Foxp3',
            'Ki67','CD3','HLADR','GranzymeB')

set.seed(88)
cd8_cluster = CATALYST::cluster(cd8_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)


# add marker expression to cells
marker_expression <- data.frame(t(assay(cd8_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd8_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
cd8_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd8_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

cd8_cluster$Label = NA
cd8_cluster[,cd8_cluster$cluster_id == 1]$Label = "CD4+ Tregs"
cd8_cluster[,cd8_cluster$cluster_id %in% c(2,3,5,7)]$Label = "CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 4]$Label = "PD1+CD28+ CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 6]$Label = "Cytotoxic T cells"
cd8_cluster[,cd8_cluster$cluster_id == 8]$Label = "PD1+ CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 9]$Label = "Proliferating CD8 T cells"

unique(cd8_cluster$Label)
```

B Cell Population

```{r}
bcell_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'B cells']

markers = c('CD45','CD20','CD279','Foxp3','Ki67','HLADR')

set.seed(88)
bcell_cluster = CATALYST::cluster(bcell_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)


# add marker expression to cells
marker_expression <- data.frame(t(assay(bcell_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(bcell_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
bcell_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(bcell_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

bcell_cluster$Label = NA
bcell_cluster[,bcell_cluster$cluster_id %in% c(1,5)]$Label = "CD4+ Tregs"
bcell_cluster[,bcell_cluster$cluster_id %in% c(4,7)]$Label = "PD1+ B cells"
bcell_cluster[,bcell_cluster$cluster_id == 8]$Label = "Proliferating B cells"
bcell_cluster[,bcell_cluster$cluster_id %in% c(2,3,6,9)]$Label = "B cells"

unique(bcell_cluster$Label)
```

Macrophage Population

```{r}
macrophages_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Macrophages']

#################################
# First separate into M1 and M2 #
#################################

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

scaled_macrophages_cluster = as.data.frame(scale(t(assay(macrophages_cluster[rownames(macrophages_cluster) %in% 
                                                                     markers,],'exprs'))))
head(scaled_macrophages_cluster)

scaled_macrophages_cluster = scaled_macrophages_cluster %>% mutate(Label = case_when(
  (CD163>0) ~ 'M2 Macrophages',
  T ~ 'M1 Macrophages'
))

head(scaled_macrophages_cluster)

macrophages_cluster$cluster_id = scaled_macrophages_cluster$Label


# add marker expression to cells
marker_expression <- data.frame(t(assay(macrophages_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(macrophages_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")

# plot heatmap
macrophages_subclusters_flowsom =  Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(macrophages_subclusters_flowsom, heatmap_legend_side = "bottom")

####################
# M1 SUBCLUSTERING #
####################

m1_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M1 Macrophages')]

markers = c('CD16','CD11b','CD45','Foxp3','CD68','Ki67','HLADR')

set.seed(88)
m1_clusters = CATALYST::cluster(m1_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(m1_clusters[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m1_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
m1_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m1_subclusters_flowsom, heatmap_legend_side = "bottom")

####################
# M2 SUBCLUSTERING #
####################

m2_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M2 Macrophages')]

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

set.seed(88)
m2_clusters = CATALYST::cluster(m2_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)


# add marker expression to cells
marker_expression <- data.frame(t(assay(m2_clusters[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m2_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
m2_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m2_subclusters_flowsom, heatmap_legend_side = "bottom")

#################################
# Annotate clusters and combine #
#################################

m1_clusters$Label = NA

m1_clusters[,m1_clusters$cluster_id == 1]$Label = "CD16+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id %in% c(2,3,4,8,9)]$Label = "M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 5]$Label = "CD4 Treg cells"
m1_clusters[,m1_clusters$cluster_id == 6]$Label = "CD11b+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 7]$Label = "Proliferating M1 macrophages"

unique(m1_clusters$Label)


m2_clusters$Label = NA

m2_clusters[,m2_clusters$cluster_id == 1]$Label = "CD4 Treg cells"
m2_clusters[,m2_clusters$cluster_id %in% c(2,3)]$Label = "M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 4]$Label = "Proliferating M2 macrophages"
m2_clusters[,m2_clusters$cluster_id %in% c(5,7,8)]$Label = "CD16+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 6]$Label = "CD11b+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 9]$Label = "HLADR+ M2 macrophages"

unique(m2_clusters$Label)

# add marker expression to cells
markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

marker_expression <- data.frame(t(assay(m2_clusters[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m2_clusters)[,"Label"])
colnames(dat) = "Label"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Label) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Label) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Label

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
macrophages_subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(macrophages_subclusters_labelled, heatmap_legend_side = "bottom")


#####################
# COMBINE M1 AND M2 #
#####################

unique(m1_clusters$Label)

macrophages_cluster$Label = NA
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('M1 macrophages')])]$Label = 'M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('Proliferating M1 macrophages')])]$Label = 'Proliferating M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD11b+ M1 macrophages')])]$Label = 'CD11b+ M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD16+ M1 macrophages')])]$Label = 'CD16+ M1 macrophages'

unique(m2_clusters$Label)

macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('M2 macrophages')])]$Label = 'M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('Proliferating M2 macrophages')])]$Label = 'Proliferating M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD11b+ M2 macrophages')])]$Label = 'CD11b+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD16+ M2 macrophages')])]$Label = 'CD16+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('HLADR+ M2 macrophages')])]$Label = 'HLADR+ M2 macrophages'

unique(macrophages_cluster$Label)
```

Monocyte Population

```{r}
monocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Monocytes']

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

set.seed(88)
monocytes_cluster = CATALYST::cluster(monocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 5, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(monocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(monocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
monocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(monocytes_subclusters_flowsom, heatmap_legend_side = "bottom")


# Annotate clusters and combine

monocytes_cluster$Label = NA
monocytes_cluster[,monocytes_cluster$cluster_id %in% c(1,2,5,6,9)]$Label = "Classical monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 3]$Label = "CD4+ Tregs"
monocytes_cluster[,monocytes_cluster$cluster_id == 4]$Label = "Intermediate monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 7]$Label = "Non-classical monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 8]$Label = "Activated monocytes"

unique(monocytes_cluster$Label)
```

Non-immune Population
Hepatocytes

```{r}
hepatocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Hepatocytes']

markers = c('Ki67','HLADR')

set.seed(88)
hepatocytes_cluster = CATALYST::cluster(hepatocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(hepatocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(hepatocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
hepatocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(hepatocytes_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

hepatocytes_cluster$Label = NA
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(6,7,8)]$Label = "Proliferating Hepatocytes"
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(1,2,4,5)]$Label = "HLADR+ Hepatocytes"
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(3,9)]$Label = "Hepatocytes"

unique(hepatocytes_cluster$Label)
```

Cholangiocytes

```{r}
cholangiocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Cholangiocytes']

markers = c('CK7','Ki67','HLADR')

set.seed(88)
cholangiocytes_cluster = CATALYST::cluster(cholangiocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(cholangiocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cholangiocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
cholangiocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(cholangiocytes_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

cholangiocytes_cluster$Label = NA
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(2)]$Label = "Proliferating Cholangiocytes"
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(6)]$Label = "HLADR+ Cholangiocytes"
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(1,3,4,5,7,8,9)]$Label = "Cholangiocytes"

unique(cholangiocytes_cluster$Label)
```

Endothelial cells

```{r}
endothelial_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Endothelial cells']

markers = c('CD31','Ki67','HLADR')

set.seed(88)
endothelial_cluster = CATALYST::cluster(endothelial_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# add marker expression to cells
marker_expression <- data.frame(t(assay(endothelial_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(endothelial_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

# plot heatmap
endothelial_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(endothelial_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

endothelial_cluster$Label = NA
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(9)]$Label = "Proliferating Endothelial cells"
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(5,8)]$Label = "HLADR+ Endothelial cells"
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(1,2,3,4,6,7)]$Label = "Endothelial cells"

unique(endothelial_cluster$Label)
```

# Incorporate subclusters into main SCE object

```{r}
sce_adult_labelled$Subcluster = NA

# CD4 Sub-clusters
unique(cd4_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD4+ T-cells'])]$Subcluster = 'CD3+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Ki67+ CD4+ T-cells'])]$Subcluster = 'Proliferating CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='PD1+ CD4+ T-cells'])]$Subcluster = 'PD1+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Naive CD4+ T-cells'])]$Subcluster = 'Naive CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Activated CD4+ T-cells'])]$Subcluster = 'Activated CD4+ T-cells'

sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Resident memory CD4+ T-cells'])]$Subcluster = 'Resident memory CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD16+ CD4+ T-cells'])]$Subcluster = 'CD16+ CD4+ T-cells'


# CD8 Sub-clusters
unique(cd8_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD8 T cells'])]$Subcluster = 'CD3+ CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Proliferating CD8 T cells'])]$Subcluster = 'Proliferating CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Cytotoxic T cells'])]$Subcluster = 'Cytotoxic T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='PD1+ CD8 T cells'])]$Subcluster = 'PD1+ CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='PD1+CD28+ CD8 T cells'])]$Subcluster = 'PD1+CD28+ CD8+ T-cells'


# B Cells Sub-clusters
unique(bcell_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='B cells'])]$Subcluster = 'B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='Proliferating B cells'])]$Subcluster = 'Proliferating B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='PD1+ B cells'])]$Subcluster = 'PD1+ B cells'


# Macrophage Sub-clusters
unique(macrophages_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M1 macrophages'])]$Subcluster = 'M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M2 macrophages'])]$Subcluster = 'M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating M1 macrophages'])]$Subcluster = 'Proliferating M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating M2 macrophages'])]$Subcluster = 'Proliferating M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD11b+ M1 macrophages'])]$Subcluster = 'CD11b+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD11b+ M2 macrophages'])]$Subcluster = 'CD11b+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD16+ M1 macrophages'])]$Subcluster = 'CD16+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD16+ M2 macrophages'])]$Subcluster = 'CD16+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='HLADR+ M2 macrophages'])]$Subcluster = 'HLADR+ M2 macrophages'


# Monocytes Sub-clusters
unique(monocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Non-classical monocytes'])]$Subcluster = 'Non-classical monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Classical monocytes'])]$Subcluster = 'Classical monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Intermediate monocytes'])]$Subcluster = 'Intermediate monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Activated monocytes'])]$Subcluster = 'Activated monocytes'

unique(sce_adult_labelled$Subcluster)


# Hepatocytes Sub-clusters
unique(hepatocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='Hepatocytes'])]$Subcluster = 'Hepatocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='HLADR+ Hepatocytes'])]$Subcluster = 'HLADR+ Hepatocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='Proliferating Hepatocytes'])]$Subcluster = 'Proliferating Hepatocytes'


# Cholangiocytes Sub-clusters
unique(cholangiocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='Cholangiocytes'])]$Subcluster = 'Cholangiocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='Proliferating Cholangiocytes'])]$Subcluster = 'Proliferating Cholangiocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='HLADR+ Cholangiocytes'])]$Subcluster = 'HLADR+ Cholangiocytes'


# Endothelial cells Sub-clusters
unique(endothelial_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Endothelial cells'])]$Subcluster = 'Endothelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='HLADR+ Endothelial cells'])]$Subcluster = 'HLADR+ Endothelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Proliferating Endothelial cells'])]$Subcluster = 'Proliferating Endothelial cells'


# Add remaining clusters
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Neutrophils']$Subcluster = 'Neutrophils'
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Plasma cells']$Subcluster = 'Plasma cells'

colData(sce_adult_labelled)
unique(sce_adult_labelled$Subcluster)

# Change Cluster for those CD4+ Tregs that weren't identified as CD4 cells
colData(sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs'])
sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs']$Clusters = 'CD4+ T-cells'
```

Separate CD4+ Tregs into HLADR+ and HLADR-

```{r}
tregs_cluster = sce_adult_labelled[, sce_adult_labelled$Subcluster == 'CD4+ Tregs']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

#Separate into HLADR high and HLADR low
df_treg_cluster = as.data.frame((t(assay(tregs_cluster[rownames(tregs_cluster) %in% markers,],'exprs'))))
head(df_treg_cluster)

df_treg_cluster = df_treg_cluster %>% mutate(Label = case_when(
  (HLADR>0) ~ 'HLADR+',
  T ~ 'HLADR-'
))

head(df_treg_cluster)

tregs_cluster$cluster_id = df_treg_cluster$Label


# add marker expression to cells
marker_expression <- data.frame(t(assay(tregs_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(tregs_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$cluster_id

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")

# plot heatmap
tregs_subclusters_flowsom =  Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(tregs_subclusters_flowsom, heatmap_legend_side = "bottom")

# Incorporate into main SCE object
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(tregs_cluster[,tregs_cluster$cluster_id=='HLADR+'])]$Subcluster = 'HLADR+ CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(tregs_cluster[,tregs_cluster$cluster_id=='HLADR-'])]$Subcluster = 'HLADR- CD4+ Tregs'

unique(sce_adult_labelled$Subcluster)
```

# FINAL METACLUSTER HEATMAP

```{r}
markers_to_include = c('CD66b','CD20','CD163','CD11b','CD4','CD31','CD68','CK7','CD8','CD138')

marker_expression <- data.frame(t(assay(sce_adult_labelled[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(sce_adult_labelled)[,"Clusters"])
colnames(dat) = "Clusters"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Clusters) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Clusters) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Clusters
dat_sum = dat_sum[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
                    'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Clusters

m = m[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
        'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

m = m[,c('CK7','CD31','CD4','CD8','CD68','CD163','CD11b','CD66b','CD20','CD138')]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,numbers_gp = gpar(fontsize = 20),
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))


col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10), 
                     c("lightblue","#C04000","#313695",
                      "#FFEA00", "orange","#0096FF","green",
                       "#ae017e","#bf812d", "#CCCCFF"))
ha_left = HeatmapAnnotation(Metaclusters = 1:10, col = list(Metaclusters = col_fun), annotation_name_rot=45, 
                            annotation_name_gp=gpar(fontsize=25),gp = gpar(col = "black"), 
                            which='row', show_legend = FALSE)

metaclusters_2 = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23), #23
                                  row_names_gp = gpar(fontsize = 25),
                                  column_names_gp = gpar(fontsize = 25),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=12),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(metaclusters_2, heatmap_legend_side = "top")
```

# Heatmap Visualization of Subclusters

```{r}
###################
# All subclusters #
###################

markers_to_include = c('CD66b','CD20','CD28','CD16','CD163','CD11b','CD45',
                       'CD4','CD31','CD279','CD68','Foxp3',
                       'CK7','Ki67','CD8',
                       'CD3','CD138','HLADR','GranzymeB')

# Non-immune

subclusters_nonimmune = sce_adult_labelled[,sce_adult_labelled$Subcluster %in% 
                                             c('Hepatocytes','Endothelial cells','Cholangiocytes')]

marker_expression <- data.frame(t(assay(subclusters_nonimmune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_nonimmune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3),
                     c("#C04000","#313695","lightblue"))

ha_left = HeatmapAnnotation(Metaclusters = 1:3, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 20),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(1.5, "cm"),
                                  width = unit(18,"cm"),
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_nonimmune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()

# Immune

subclusters_immune = sce_adult_labelled[,!sce_adult_labelled$Subcluster %in% 
                                             c('Hepatocytes','Endothelial cells','Cholangiocytes')]

marker_expression <- data.frame(t(assay(subclusters_immune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_immune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Subcluster
dat_sum = dat_sum[c('B cells','Proliferating B cells','PD1+ B cells',
        'CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

m = m[c('B cells','Proliferating B cells','PD1+ B cells',
        'CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells'),]

dat_sum[,1]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,35000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32),
                     c("#bf812d","#bf812d","#bf812d",
                       "#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00",
                       "orange","orange","orange","orange","orange",
                       "#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF",
                       "green","green","green","green","#ae017e","#CCCCFF"))
                   
ha_left = HeatmapAnnotation(Metaclusters = 1:32, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(18, "cm"), 
                                  width = unit(20,"cm")
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_immune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()


###############
# CD4 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD4+ T-cells']
markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# CD8 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD8+ T-cells']
markers = c('CD28','CD16','CD11b','CD45','CD8','CD279','Foxp3','Ki67','CD3','HLADR','GranzymeB')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###########
# B cells #
###########

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='B cells']
markers = c('CD45','CD20','CD279','Foxp3','Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# Macrophages #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Macrophages']
markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

#############
# Monocytes #
#############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Monocytes']
markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")


###############
# Hepatocytes #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Hepatocytes']
# markers = c('CD138','Ki67','HLADR')
markers = c('Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

##################
# Cholangiocytes #
##################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Cholangiocytes']
markers = c('CK7','Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

#####################
# Endothelial cells #
#####################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Endothelial cells']
markers = c('CD31','Ki67','HLADR')

# add marker expression to cells
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# aggregate the groups
dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

# number of cells per group
dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# create matrix
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

# number annotation
ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
# plot heatmap
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")
```

# T-SNE Visualization

```{r}
################
# METACLUSTERS #
################

markers_to_include = c('CD66b','CD20','CD28','CD16','CD163','CD11b','CD45','CD4','CD31','CD279','CD68','Foxp3',
                       'CK7','Ki67','CD8','CD3','CD138','HLADR','GranzymeB')

set.seed(88)
sce_adult_labelled = runDR(sce_adult_labelled, "TSNE", features = markers_to_include) 


# All groups together
plotDR(sce_adult_labelled, "TSNE", color_by = "group") +
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=20),
        plot.title=element_text(size = 20, hjust = 0.5,),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=16)) +
  scale_color_manual(values=c("#E0B0FF","#DA70D6","#800080"))

# Color by patient; Facet by patient ID
plotDR(sce_adult_labelled, "TSNE", color_by = "Patient", facet_by = 'Patient') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        aspect.ratio=1,
        legend.position='none',
        legend.title=element_blank(),
        legend.text=element_text(size=20))

# Facet by clinical group
plotDR(sce_adult_labelled, "TSNE", color_by = "Clusters", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  scale_color_manual(values=c("#bf812d","#FFEA00","orange","green","#0096FF",
                              "#ae017e","#CCCCFF","#313695","#C04000","lightblue"))

# Facet by clinical group, excluding Hepatocytes
sce_adult_labelled_noHep = sce_adult_labelled[,sce_adult_labelled$Clusters != 'Hepatocytes']

plotDR(sce_adult_labelled_noHep, "TSNE", color_by = "Clusters", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  scale_color_manual(values=c("#bf812d","#FFEA00","orange","green","#0096FF",
                              "#ae017e","#CCCCFF","#313695","#C04000"))
```

```{r}
#####################
# MARKER EXPRESSION #
#####################

# 'CD66b','CD20','CD28','CD16','CD163','CD11b','CD45','CD4','CD31','CD279','CD68','Foxp3',
# 'CK7','Ki67','CD8','CD3','CD138','HLADR','GranzymeB'

plotDR(sce_adult_labelled_noHep, "TSNE", color_by = "GranzymeB", 
       a_pal = rev(hcl.colors(5, "YlOrRd"))) +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='right',
        legend.title=element_blank(),
        legend.text=element_text(size=20))
```

```{r}
###############
# SUBCLUSTERS #
###############

# CD4+ Cells #
plotDR(sce_adult_labelled[,sce_adult_labelled$Clusters=='CD4+ T-cells'], "TSNE", 
       color_by = "Subcluster", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 4), nrow=5)) +
  scale_color_manual(values=c("#bf812d","#00ffff","#FFEA00", 
                              "#7F00FF","#ae017e","#6a87a3","#0096FF","#ff77ff",'orange'))

# CD8+ Cells #
plotDR(sce_adult_labelled[,sce_adult_labelled$Clusters=='CD8+ T-cells'], "TSNE", 
       color_by = "Subcluster", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 4), nrow=2)) +
  scale_color_manual(values=c("#FFEA00","#ae017e","#bf812d","#0096FF","#ff77ff"))

# B Cells #
plotDR(sce_adult_labelled[,sce_adult_labelled$Clusters=='B cells'], "TSNE", 
       color_by = "Subcluster", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 4))) +
  scale_color_manual(values=c("#FFEA00","#0096FF","#ff77ff"))

# Macrophages #
plotDR(sce_adult_labelled[,sce_adult_labelled$Clusters=='Macrophages'], "TSNE", 
       color_by = "Subcluster", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 4), nrow=5)) +
  scale_color_manual(values=c("#dfc27d","#bf812d","#6a87a3","#ccff00","#FFEA00", 
                              "#0096FF","#313695","#8b008b","#ff77ff"))
                              
# Monocytes #
plotDR(sce_adult_labelled[,sce_adult_labelled$Clusters=='Monocytes'], "TSNE", 
       color_by = "Subcluster", facet_by = 'group') +
  xlab("tSNE 1") + ylab("tSNE 2") +
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(size=20),
        strip.text=element_text(size = 28, hjust = 0.5),
        aspect.ratio=1,
        legend.position='bottom',
        legend.title=element_blank(),
        legend.text=element_text(size=20)) +
  guides(color = guide_legend(override.aes = list(size = 4), nrow=2)) +
  scale_color_manual(values=c("#0096FF","#bf812d","#ae017e","#FFEA00"))
```

# TISSUE VISUALIZATION

```{r}
############################################
####### Visualize Metaclusters #############
############################################

# All
plotCells(mask = all_masks[c(71)], #CR:9; NR:17; ACR:84, 87
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Clusters',
          outline_by = 'group',
          image_title = list(text=c(''),colour='darkgray'),
          colour = list(Clusters = c('Hepatocytes' = "lightblue",
                                     'B cells' = "#bf812d",
                                     'CD4+ T-cells' = "#FFEA00",
                                     'CD8+ T-cells' = "orange",
                                     'Monocytes' = "green",
                                     'Macrophages' = "#0096FF",
                                     'Neutrophils' = "#ae017e",
                                     'Plasma cells' = "#CCCCFF",
                                     'Endothelial cells' = "#313695",
                                     'Cholangiocytes' = "#C04000"),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Figures/Final/Tissues/Tissue_ALL.tiff'),
          display = "single")

############################################
######## Visualize Subclusters #############
############################################

unique(sce_adult_labelled$Subcluster)

# CD4 Subclusters
plotCells(mask = all_masks[c(84)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("CD3+ CD4+ T-cells" = "#FFEA00",
                                       "Resident memory CD4+ T-cells" = "orange",
                                       "Activated CD4+ T-cells" = "#bf812d",
                                       "Naive CD4+ T-cells" = "#6a87a3",
                                       "HLADR+ CD4+ Tregs" = "#ae017e",
                                       "HLADR- CD4+ Tregs" = "#7F00FF",
                                       "Proliferating CD4+ T-cells" = "#ff77ff",
                                       "PD1+ CD4+ T-cells" = "#0096FF",
                                       "CD16+ CD4+ T-cells" = "#00ffff",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "Endothelial cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_CD4_Subclusters.tiff'),
          display = "single")

#### CD3 high vs CD3 low CD4+ T-cells
plotCells(mask = all_masks[c(84)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("CD3+ CD4+ T-cells" = "blue",
                                       "Resident memory CD4+ T-cells" = "orange",
                                       "Activated CD4+ T-cells" = "blue",
                                       "Naive CD4+ T-cells" = "blue",
                                       "HLADR+ CD4+ Tregs" = "blue",
                                       "HLADR- CD4+ Tregs" = "blue",
                                       "Proliferating CD4+ T-cells" = "blue",
                                       "PD1+ CD4+ T-cells" = "blue",
                                       "CD16+ CD4+ T-cells" = "blue",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "Endothelial cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_CD4_Subclusters.tiff'),
          display = "single")

# CD8 Subclusters
plotCells(mask = all_masks[c(87)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("CD3+ CD8+ T-cells" = '#FFEA00',
                                        "Proliferating CD8+ T-cells" = '#ff77ff',
                                        "Cytotoxic T-cells" = '#ae017e',
                                        "PD1+ CD8+ T-cells" = '#bf812d',
                                        "PD1+CD28+ CD8+ T-cells" = '#0096FF',
                                       
                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "Endothelial Cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma Cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_CD8_Subclusters.tiff'),
          display = "single")

# Macrophage Subclusters 
plotCells(mask = all_masks[c(84)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("M1 macrophages" = '#0096FF',
                                        "M2 macrophages" = '#313695',
                                        "Proliferating M1 macrophages" = '#8b008b',
                                        "Proliferating M2 macrophages" = '#ff77ff',
                                        "CD11b+ M1 macrophages" = '#dfc27d',
                                        "CD11b+ M2 macrophages" = '#bf812d',
                                        "CD16+ M1 macrophages" = '#6a87a3',
                                        "CD16+ M2 macrophages" = '#ccff00',
                                        "HLADR+ M2 macrophages" = '#FFEA00',
                                       
                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "Endothelial Cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma Cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Tissue_Macro_Subclusters.tiff'),
          display = "single")

# Monocyte Subclusters
plotCells(mask = all_masks[c(84)],
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("Classical monocytes" = '#FFEA00',
                                        "Non-classical monocytes" = '#bf812d',
                                        "Intermediate monocytes" = '#ae017e',
                                        "Activated monocytes" = '#0096FF',
                                       
                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',

                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "Endothelial Cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma Cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_Mono_Subclusters.tiff'),
          display = "single")

# B cells Subclusters
plotCells(mask = all_masks[c(84)],
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("B cells" = '#FFEA00',
                                        "Proliferating B cells" = '#ff77ff',
                                        "PD1+ B cells" = '#0096FF',
                                       
                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "Hepatocytes" = 'white',
                                        "Endothelial cells" = 'white',
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white',
                                        "Cholangiocytes" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Tissue_B_Subclusters.tiff'),
          display = "single")

# Hepatocytes Subclusters
plotCells(mask = all_masks[c(57)],
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'), 
          colour = list(Subcluster = c("Hepatocytes" = '#FFEA00',
                                       "Proliferating Hepatocytes" = '#ff77ff',
                                      "HLADR+ Hepatocytes" = '#00ffff',

                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                       
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                                        
                                        "Endothelial cells" = 'white',
                                        "Proliferating Endothelial cells" = 'white',
                                        "HLADR+ Endothelial cells" = 'white',
                                       
                                        "Cholangiocytes" = 'white',
                                        "Proliferating Cholangiocytes" = 'white',
                                        "HLADR+ Cholangiocytes" = 'white',
                                       
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Tissue_Hep_Subclusters.tiff'),
          display = "single")

# Endothelial cells Subclusters
plotCells(mask = all_masks[c(71)], #57
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("Endothelial cells" = '#FFEA00',
                                       "Proliferating Endothelial cells" = '#ff77ff',
                                      "HLADR+ Endothelial cells" = '#00ffff',

                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                       
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                                        
                                        "Hepatocytes" = 'white',
                                        "Proliferating Hepatocytes" = 'white',
                                        "HLADR+ Hepatocytes" = 'white',
                                       
                                        "Cholangiocytes" = 'white',
                                        "Proliferating Cholangiocytes" = 'white',
                                        "HLADR+ Cholangiocytes" = 'white',
                                       
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Tissue_Endo_Subclusters.tiff'),
          display = "single")

# Cholangiocyte Subclusters
plotCells(mask = all_masks[c(87)],
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'),
          colour = list(Subcluster = c("Cholangiocytes" = '#FFEA00',
                                       "Proliferating Cholangiocytes" = '#ff77ff',
                                       "HLADR+ Cholangiocytes" = '#00ffff',

                                       "CD3+ CD4+ T-cells" = "white",
                                       "Resident memory CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "PD1+ CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        "CD16+ M2 macrophages" = 'white',
                                        "HLADR+ M2 macrophages" = 'white',
                                        
                                        "Non-classical monocytes" = 'white',
                                        "Classical monocytes" = 'white',
                                        "Intermediate monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                       
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                                        
                                        "Hepatocytes" = 'white',
                                        "Proliferating Hepatocytes" = 'white',
                                        "HLADR+ Hepatocytes" = 'white',

                                        "Endothelial cells" = 'white',
                                        "Proliferating Endothelial cells" = 'white',
                                        "HLADR+ Endothelial cells" = 'white',
                                       
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1,margin=1),
          # save_plot = list(filename='Tissue_Chol_Subclusters.tiff'),
          display = "single")
```

# STATISTICAL COMPARISON

```{r}
########################
### Create Dataframe ###
########################

colData(sce_adult_labelled)
labelled_data = cbind(as.data.frame(colData(sce_adult_labelled)$sample_id), as.data.frame(colData(sce_adult_labelled)$ObjectNumber))
colnames(labelled_data) = c('ImgID','CellID')

head(labelled_data)

labelled_data$CD66b = assay(sce_adult_labelled, "exprs")[1,]
labelled_data$CD20 = assay(sce_adult_labelled, "exprs")[2,]
labelled_data$CD28 = assay(sce_adult_labelled, "exprs")[3,]
labelled_data$CD16 = assay(sce_adult_labelled, "exprs")[4,]
labelled_data$CD163 = assay(sce_adult_labelled, "exprs")[5,]
labelled_data$CD11b = assay(sce_adult_labelled, "exprs")[6,]
labelled_data$CD45 = assay(sce_adult_labelled, "exprs")[7,]
labelled_data$CD4 = assay(sce_adult_labelled, "exprs")[8,]
labelled_data$CD31 = assay(sce_adult_labelled, "exprs")[9,]
labelled_data$CD279 = assay(sce_adult_labelled, "exprs")[10,]
labelled_data$CD68 = assay(sce_adult_labelled, "exprs")[11,]
labelled_data$Foxp3 = assay(sce_adult_labelled, "exprs")[12,]
labelled_data$CK7 = assay(sce_adult_labelled, "exprs")[13,]
labelled_data$Ki67 = assay(sce_adult_labelled, "exprs")[14,]
labelled_data$CD8 = assay(sce_adult_labelled, "exprs")[15,]
labelled_data$CollagenI = assay(sce_adult_labelled, "exprs")[16,]
labelled_data$CD3 = assay(sce_adult_labelled, "exprs")[17,]
labelled_data$CD138 = assay(sce_adult_labelled, "exprs")[18,]
labelled_data$HLADR = assay(sce_adult_labelled, "exprs")[19,]
labelled_data$GranzymeB = assay(sce_adult_labelled, "exprs")[20,]
labelled_data$group = colData(sce_adult_labelled)$group
labelled_data$Clusters = sce_adult_labelled$Clusters
labelled_data$ROI = sce_adult_labelled$sample_id
labelled_data$Patient = sce_adult_labelled$Patient

head(labelled_data)
dim(labelled_data)
```

Fold Change of channel expression

```{r}
data = labelled_data
no_rejection = data %>% filter(group == "NR")
acute = data %>% filter(group == "TCMR")
chronic = data %>% filter(group == "CR")

#calculate the mean of each gene per control group
no_rejection = apply(no_rejection[, c(3:22)], 2, mean)
acute = apply(acute[, c(3:22)], 2, mean) 
chronic = apply(chronic[, c(3:22)], 2, mean) 

# NR vs TCMR
df_1 = as.data.frame(cbind(acute, no_rejection))
colnames(df_1) = c('TCMR','NR')
head(df_1)

df_1$FoldChange = df_1$TCMR - df_1$NR
head(df_1)

df_1$marker = rownames(df_1)

df_1 = df_1 %>% dplyr::mutate(color = case_when(FoldChange > 0 ~ 'UP',
                                                FoldChange < 0 ~ 'DOWN',
                                                T ~ 'N'))

ggplot(data = df_1[df_1$marker != 'CollagenI',], aes(x = FoldChange, y = marker, fill=color)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + ylab(NULL) + xlab("Fold Change") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6"))

# TCMR vs CR
df_2 = as.data.frame(cbind(acute, chronic))
colnames(df_2) = c('TCMR','CR')
head(df_2)

df_2$FoldChange = df_2$CR - df_2$TCMR
head(df_2)

df_2$marker = rownames(df_2)

df_2 = df_2 %>% dplyr::mutate(color = case_when(FoldChange > 0 ~ 'UP',
                                                FoldChange < 0 ~ 'DOWN',
                                                T ~ 'N'))

ggplot(data = df_2[df_2$marker != 'CollagenI',], aes(x = FoldChange, y = marker, fill=color)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + ylab(NULL) + xlab("Fold Change") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("#DA70D6","#800080"))
```

```{r}
########################
##### METACLUSTERS #####
########################

# AVG. PROPORTION OF CELLS PER PATIENT
cells_per_Patient = labelled_data %>% subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = labelled_data %>% group_by(group) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','group','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)
cells_Patient = cells_Patient %>% mutate(Type = case_when(Clusters %in% c('Hepatocytes','Cholangiocytes',
                                                                  'Endothelial cells') ~ 'Non-Immune Cells',
                                                  T ~ 'Immune Cells'))
head(cells_Patient)
unique(cells_Patient$Type)

cells_Patient_avg = cells_Patient %>% group_by(group, Clusters) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_avg)

ggplot(data = cells_Patient_avg,
                       aes(x = Clusters, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells per Patient") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        # legend.position='none',
        legend.title=element_blank(),
        legend.text=element_text(size=30),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))


# Stacked Barplot
order_of_stack_patients = c("SP17_1753","SP17_5427","SP17_7659","SP17_9809","SP18_13566","SP18_7378","SP19_10094",
                          "SP19_13104","SP19_1689","SP19_2277","SP19_7279","SP20_11706","SP20_11758","SP20_6053",
                          "SP20_6085","SP20_8599","SP21_2370","SP21_2563","SP21_6217","SP21_6323","SP21_8054",
                          "SP21_8904","SP21_9015","SP21_9021", # NR
                        
                          "SP_18_14559","SP16_1902","SP18_2369A1","SP18_3825A1","SP19_10445","SP19_12144","SP19_13300",
                          "SP19_13381A1","SP19_1715A1","SP19_1892","SP19_2006","SP19_8069","SP19_9797","SP20_2886",
                          "SP20_3128","SP20_3382A1","SP20_3601","SP20_3668","SP20_4548","SP20_6708","SP20_7546",
                          "SP20_7572","SP20_7880","SP20_928","SP21_1320","SP21_1610","SP21_1786","SP21_1931",
                          "SP21_2168","SP21_2461","SP21_2495","SP21_2603","SP21_2829","SP21_301","SP21_336",
                          "SP21_3546","SP21_3775","SP21_414_A1","SP21_6623","SP21_712","SP21_725", # TCMR
                        
                          "SP00_1543","SP01_3915","SP03_2432","SP04_5797","SP04_6177","SP08_8","SP09_259","SP11_1305",
                          "SP13_5321","SP13_5725","SP17_8628","SP18_13009","SP18_213","SP18_4465") # CR

stack_data_meta = labelled_data %>% group_by(Patient,Clusters,group) %>% dplyr::summarise(Count = n())
head(stack_data_meta)

stack_plot_meta = ggplot(stack_data_meta, aes(fill=Clusters, y=Count, x=Patient, reverse=TRUE)) + 
    geom_bar(position = position_fill(reverse = TRUE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Proportion") +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#bf812d","#FFEA00","orange","green","#0096FF",
                              "#ae017e","#CCCCFF","#313695","#C04000","lightblue"))
                              
tiff("Metaclusters_stacked.tiff", units="in", width=45, height=25, res=300)
stack_plot_meta
dev.off()

# Colored bar to determine which group each patient belongs to
group_bar = ggplot(stack_data_meta, aes(fill=group, y=Count, x=Patient, reverse=TRUE)) + 
    geom_bar(position = position_fill(reverse = TRUE), stat="identity", width=1) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Proportion") +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

tiff("Patient_group_bar.tiff", units="in", width=45, height=25, res=300)
group_bar
dev.off()

# Stacked Barplot
stack_data_meta_group = labelled_data %>% group_by(Clusters, group) %>% dplyr::summarise(Count = n())
head(stack_data_meta_group)

stack_plot_meta_group = ggplot(stack_data_meta_group, aes(fill=group, y=Count, x=Clusters)) + 
    geom_bar(position = position_fill(reverse = TRUE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Proportion") +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=10),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits=rev(c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
                    'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'))) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

tiff("Stackplot_all_clusters.tiff", units="in", width=13, height=10, res=300)
stack_plot_meta_group
dev.off()


### BY CELL TYPE ###

head(cells_Patient)
cells_Patient_type_temp = cells_Patient %>% group_by(group, Patient, Type) %>% dplyr::summarise(sum = sum(Count))
cells_Patient_type = merge(cells_Patient, cells_Patient_type_temp, all.y=TRUE, by=c('group','Patient','Type'))
head(cells_Patient_type)
cells_Patient_type = cells_Patient_type %>% subset(select=c('group','Patient','Type','CellTotal','sum'))
head(cells_Patient_type)
cells_Patient_type = cells_Patient_type[!duplicated(cells_Patient_type), ]
head(cells_Patient_type)
cells_Patient_type$Perc_Type_Patient = cells_Patient_type$sum / cells_Patient_type$CellTotal
head(cells_Patient_type)

# Count
summary((cells_Patient_type %>% filter(group=='NR') %>% filter(Type=='Immune Cells'))$sum)
summary((cells_Patient_type %>% filter(group=='TCMR') %>% filter(Type=='Immune Cells'))$sum)
summary((cells_Patient_type %>% filter(group=='CR') %>% filter(Type=='Immune Cells'))$sum)

summary((cells_Patient_type %>% filter(group=='NR') %>% filter(Type=='Non-Immune Cells'))$sum)
summary((cells_Patient_type %>% filter(group=='TCMR') %>% filter(Type=='Non-Immune Cells'))$sum)
summary((cells_Patient_type %>% filter(group=='CR') %>% filter(Type=='Non-Immune Cells'))$sum)

# Avg
ggplot(data = cells_Patient_type, 
              aes(x = Type, y = Perc_Type_Patient,
                  fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(NULL) + xlab(NULL) + ylab("Cell % per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=33),
        plot.title=element_text(size = 30, hjust = 0.5),
        # legend.title=element_blank(),
        # legend.text=element_text(size=24),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(labels = c('Immune','Non-Immune')) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,1)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.95, size=8,
                     aes(label = sprintf("Overall p = %5.2f", as.numeric(..p.format..))))


## BY CELL POPULATION - NON-IMMUNE CELLS ONLY

cells_per_Patient_nonimmune = labelled_data %>% filter(Clusters %in% c('Hepatocytes','Cholangiocytes',
                                                                   'Endothelial cells')) %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_nonimmune = labelled_data %>% filter(Clusters %in% c('Hepatocytes','Cholangiocytes',
                                                                      'Endothelial cells')) %>%
  group_by(group) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient_nonimmune = merge(cells_per_Patient_nonimmune, cellType_per_Patient_nonimmune, all.x=TRUE, by='Patient')
head(cells_Patient_nonimmune)
colnames(cells_Patient_nonimmune) = c('Patient','group','CellTotal','Clusters','Count')
cells_Patient_nonimmune$Perc_CellType_Patient = cells_Patient_nonimmune$Count / cells_Patient_nonimmune$CellTotal
cells_Patient_nonimmune$Perc_CellType_Patient_per_1000cells = cells_Patient_nonimmune$Perc_CellType_Patient * 1000
head(cells_Patient_nonimmune)
unique(cells_Patient_nonimmune)

# COUNTS 
summary((cells_Patient_nonimmune %>% filter(group=='NR') %>% filter(Clusters=='Hepatocytes'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='TCMR') %>% filter(Clusters=='Hepatocytes'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='CR') %>% filter(Clusters=='Hepatocytes'))$Count)

summary((cells_Patient_nonimmune %>% filter(group=='NR') %>% filter(Clusters=='Cholangiocytes'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='TCMR') %>% filter(Clusters=='Cholangiocytes'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='CR') %>% filter(Clusters=='Cholangiocytes'))$Count)

summary((cells_Patient_nonimmune %>% filter(group=='NR') %>% filter(Clusters=='Endothelial cells'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='TCMR') %>% filter(Clusters=='Endothelial cells'))$Count)
summary((cells_Patient_nonimmune %>% filter(group=='CR') %>% filter(Clusters=='Endothelial cells'))$Count)

# AVG PROPORTION
cells_Patient_nonimmune_avg = cells_Patient_nonimmune %>% group_by(group, Clusters) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))

head(cells_Patient_nonimmune_avg)

ggplot(data = cells_Patient_nonimmune_avg,
                       aes(x = Clusters, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. % Cells per Patient\n(non-immune)") +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=30),
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# Obtain p-values for overall comparison
shapiro.test((cells_Patient)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient, method='kruskal.test', group.by='Clusters')

# Hepatocytes
shapiro.test((cells_Patient %>% filter(Clusters == 'Hepatocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Hepatocytes')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Hepatocytes')), 
                aes(x = group, y = Perc_CellType_Patient,
                    fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Hepatocytes") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,1)) +
  scale_fill_manual(values = c("lightblue","lightblue","lightblue")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 1, label.y = 0.9) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 1, label.y = 0.87) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 1, label.y = 0.94) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.98, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Endothelial cells
shapiro.test((cells_Patient %>% filter(Clusters == 'Endothelial cells'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Endothelial cells')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Endothelial cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Endothelial cells") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#313695","#313695","#313695")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.2) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# Cholangiocytes
shapiro.test((cells_Patient %>% filter(Clusters == 'Cholangiocytes'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Cholangiocytes')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Cholangiocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Cholangiocytes") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#C04000","#C04000","#C04000")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.2) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))



## BY CELL POPULATION - IMMUNE CELLS ONLY

cells_per_Patient_immune = labelled_data %>% filter(!Clusters %in% c('Hepatocytes','Cholangiocytes',
                                                                 'Endothelial cells')) %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_immune = labelled_data %>% filter(!Clusters %in% c('Hepatocytes','Cholangiocytes',
                                                                    'Endothelial cells')) %>%
  group_by(group) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient_immune = merge(cells_per_Patient_immune, cellType_per_Patient_immune, all.x=TRUE, by='Patient')
head(cells_Patient_immune)
colnames(cells_Patient_immune) = c('Patient','group','CellTotal','Clusters','Count')
cells_Patient_immune$Perc_CellType_Patient = cells_Patient_immune$Count / cells_Patient_immune$CellTotal
head(cells_Patient_immune)
unique(cells_Patient_immune)

# COUNTS 
summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='CD4+ T-cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='CD4+ T-cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='CD4+ T-cells'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='CD8+ T-cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='CD8+ T-cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='CD8+ T-cells'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='B cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='B cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='B cells'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='Macrophages'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='Macrophages'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='Macrophages'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='Monocytes'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='Monocytes'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='Monocytes'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='Neutrophils'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='Neutrophils'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='Neutrophils'))$Count)

summary((cells_Patient_immune %>% filter(group=='NR') %>% filter(Clusters=='Plasma Cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='TCMR') %>% filter(Clusters=='Plasma Cells'))$Count)
summary((cells_Patient_immune %>% filter(group=='CR') %>% filter(Clusters=='Plasma Cells'))$Count)

# AVG PROPORTION
cells_Patient_immune_avg = cells_Patient_immune %>% group_by(group, Clusters) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))

head(cells_Patient_immune_avg)

ggplot(data = cells_Patient_immune_avg,
                       aes(x = Clusters, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  # facet_grid(~group) +
  ggtitle(NULL) + xlab("") + ylab("Avg. % Cells per Patient\n(immune)") +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=30),
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))


# CD4+ Cells
shapiro.test((cells_Patient %>% filter(Clusters == 'CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'CD4+ T-cells')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.1", as.numeric(..p.format..))))

# Macrophages
shapiro.test((cells_Patient %>% filter(Clusters == 'Macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Macrophages')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# B Cells
shapiro.test((cells_Patient %>% filter(Clusters == 'B cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'B cells')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'B cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("B cells") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#bf812d","#bf812d","#bf812d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CD8+ Cells
shapiro.test((cells_Patient %>% filter(Clusters == 'CD8+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'CD8+ T-cells')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'CD8+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD8^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("orange","orange","orange")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Monocytes
shapiro.test((cells_Patient %>% filter(Clusters == 'Monocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Monocytes')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Monocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Monocytes") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("green","green","green")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Plasma Cells
shapiro.test((cells_Patient %>% filter(Clusters == 'Plasma cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Plasma cells')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Plasma cells')), 
                aes(x = group, y = Perc_CellType_Patient,
                    fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Plasma cells") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#CCCCFF","#CCCCFF","#CCCCFF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Neutrophils
shapiro.test((cells_Patient %>% filter(Clusters == 'Neutrophils'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient %>% filter(Clusters == 'Neutrophils')))

ggplot(data = (cells_Patient %>% filter(Clusters == 'Neutrophils')), 
                aes(x = group, y = Perc_CellType_Patient,
                    fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Neutrophils") + xlab(NULL) + ylab("Cell % per Patient\n(overall population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#ae017e","#ae017e","#ae017e")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.91", as.numeric(..p.format..))))
```

```{r}
#############################
######## SUBCLUSTERS ########
# Within cluster population #
#############################

labelled_data$Subcluster = sce_adult_labelled$Subcluster
head(labelled_data)

# Stacked Barplot
stack_data = labelled_data %>% group_by(Subcluster, group) %>% dplyr::summarise(Count = n())
head(stack_data)
temp=stack_data

stack_plot = ggplot(stack_data, aes(fill=group, y=Count, x=Subcluster)) + 
    geom_bar(position = position_fill(reverse = TRUE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Proportion") +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=10),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits=rev(c('B cells','Proliferating B cells','PD1+ B cells',
                            'CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells'))) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values =  c("#E0B0FF","#DA70D6","#800080"))

tiff("Stackplot_all_subclusters.tiff", units="in", width=13, height=10, res=300)
stack_plot
dev.off()

################
# CD4+ T Cells #
################

cells_per_Patient_cd4 = labelled_data %>% filter(Clusters == 'CD4+ T-cells') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_cd4 = labelled_data %>% filter(Clusters == 'CD4+ T-cells') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_cd4 = merge(cells_per_Patient_cd4, cellType_per_Patient_cd4, all.x=TRUE, by='Patient')
head(cells_Patient_cd4)
colnames(cells_Patient_cd4) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_cd4$Perc_CellType_Patient = cells_Patient_cd4$Count / cells_Patient_cd4$CellTotal
head(cells_Patient_cd4)

cells_Patient_cd4_avg = cells_Patient_cd4 %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_cd4_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_cd4_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within CD4 population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='CD3+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='CD3+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='CD3+ CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='HLADR+ CD4+ Tregs'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR+ CD4+ Tregs'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='HLADR+ CD4+ Tregs'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='HLADR- CD4+ Tregs'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR- CD4+ Tregs'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='HLADR- CD4+ Tregs'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='PD1+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='PD1+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='PD1+ CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='CD16+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='CD16+ CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='CD16+ CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='Naive CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='Naive CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='Naive CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='Activated CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='Activated CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='Activated CD4+ T-cells'))$Count)

summary((cells_Patient_cd4 %>% filter(group=='NR') %>% filter(Subcluster=='Resident memory CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='TCMR') %>% filter(Subcluster=='Resident memory CD4+ T-cells'))$Count)
summary((cells_Patient_cd4 %>% filter(group=='CR') %>% filter(Subcluster=='Resident memory CD4+ T-cells'))$Count)

# Stacked Barplot
stack_data_cd4 = labelled_data %>% filter(Clusters=='CD4+ T-cells') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_cd4)
unique(stack_data_cd4$Subcluster)

stack_data_cd4$Subcluster = factor(stack_data_cd4$Subcluster,
                                   levels=c("CD3+ CD4+ T-cells","Resident memory CD4+ T-cells",
                                            "Activated CD4+ T-cells","Naive CD4+ T-cells","CD16+ CD4+ T-cells",
                                            "PD1+ CD4+ T-cells","HLADR+ CD4+ Tregs","Proliferating CD4+ T-cells",
                                            "HLADR- CD4+ Tregs"))

cells_Patient_cd4 = cells_Patient_cd4 %>% mutate(Helper = case_when(Subcluster=="CD3+ CD4+ T-cells" ~ 1,
                                             T ~ 0))
cells_Patient_cd4 = cells_Patient_cd4 %>% mutate(Helper2 = case_when(group=="NR" ~ 0,
                                                               group=="TCMR" ~ 1,
                                                               group=="CR" ~ 2))

cells_Patient_cd4 = cells_Patient_cd4[order(cells_Patient_cd4$Helper2,-cells_Patient_cd4$Helper,
                                            cells_Patient_cd4$Perc_CellType_Patient),]
head(cells_Patient_cd4)
unique(cells_Patient_cd4$Patient)

stack_plot_cd4 = ggplot(stack_data_cd4, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","orange","#bf812d","#6a87a3","#00ffff",
                               "#0096FF","#ae017e","#ff77ff","#7F00FF"))

tiff("Metaclusters_stacked_CD4.tiff", units="in", width=45, height=25, res=300)
stack_plot_cd4
dev.off()

unique(cells_Patient_cd4$Subcluster)

# Overall p-values
shapiro.test((cells_Patient_cd4)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_cd4, method='kruskal.test', group.by='Subcluster')


# CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'CD3+ CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'CD3+ CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'CD3+ CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression(CD3^"+" ~ CD4^"+" ~ "T-cells")) + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.4) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# HLADR+ CD4 Treg cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'HLADR+ CD4+ Tregs'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'HLADR+ CD4+ Tregs')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'HLADR+ CD4+ Tregs')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(HLADR^"+" ~ CD4^"+" ~ "Tregs") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ae017e","#ae017e","#ae017e")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# HLADR- CD4 Treg cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'HLADR- CD4+ Tregs'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'HLADR- CD4+ Tregs')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'HLADR- CD4+ Tregs')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(HLADR^"-" ~ CD4^"+" ~ "Tregs") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#7F00FF","#7F00FF","#7F00FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.95", as.numeric(..p.format..))))

# Proliferating CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'Proliferating CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'Proliferating CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'Proliferating CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Proliferating" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.95", as.numeric(..p.format..))))

# PD1+ CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'PD1+ CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'PD1+ CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'PD1+ CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(PD1^"+" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.03", as.numeric(..p.format..))))

# Activated CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'Activated CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'Activated CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'Activated CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Activated" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#bf812d","#bf812d","#bf812d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CD16+ CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'CD16+ CD4+ T-cells'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'CD16+ CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'CD16+ CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD16^"+" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#00ffff","#00ffff","#00ffff")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.2", as.numeric(..p.format..))))

# Resident memory CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'Resident memory CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'Resident memory CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'Resident memory CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Resident memory" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("orange","orange","orange")) 
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.4) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  # stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
  #                    aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Naive CD4 T cells
shapiro.test((cells_Patient_cd4 %>% filter(Subcluster == 'Naive CD4+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd4 %>% filter(Subcluster == 'Naive CD4+ T-cells')))

ggplot(data = (cells_Patient_cd4 %>% filter(Subcluster == 'Naive CD4+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Naive" ~ CD4^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD4 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#6a87a3","#6a87a3","#6a87a3")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.08", as.numeric(..p.format..))))


################
# CD8+ T Cells #
################

cells_per_Patient_cd8 = labelled_data %>% filter(Clusters == 'CD8+ T-cells') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_cd8 = labelled_data %>% filter(Clusters == 'CD8+ T-cells') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_cd8 = merge(cells_per_Patient_cd8, cellType_per_Patient_cd8, all.x=TRUE, by='Patient')
head(cells_Patient_cd8)
colnames(cells_Patient_cd8) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_cd8$Perc_CellType_Patient = cells_Patient_cd8$Count / cells_Patient_cd8$CellTotal
head(cells_Patient_cd8)

cells_Patient_cd8_avg = cells_Patient_cd8 %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_cd8_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_cd8_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within CD8 population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_cd8 %>% filter(group=='NR') %>% filter(Subcluster=='CD3+ CD8+ Tcells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='TCMR') %>% filter(Subcluster=='CD3+ CD8+ T-cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='CR') %>% filter(Subcluster=='CD3+ CD8+ T-cells'))$Count)

summary((cells_Patient_cd8 %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating CD8 T cells'))$Count)

summary((cells_Patient_cd8 %>% filter(group=='NR') %>% filter(Subcluster=='PD1+CD28+ CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='TCMR') %>% filter(Subcluster=='PD1+CD28+ CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='CR') %>% filter(Subcluster=='PD1+CD28+ CD8 T cells'))$Count)

summary((cells_Patient_cd8 %>% filter(group=='NR') %>% filter(Subcluster=='PD1+ CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='TCMR') %>% filter(Subcluster=='PD1+ CD8 T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='CR') %>% filter(Subcluster=='PD1+ CD8 T cells'))$Count)

summary((cells_Patient_cd8 %>% filter(group=='NR') %>% filter(Subcluster=='Cytotoxic T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='TCMR') %>% filter(Subcluster=='Cytotoxic T cells'))$Count)
summary((cells_Patient_cd8 %>% filter(group=='CR') %>% filter(Subcluster=='Cytotoxic T cells'))$Count)

# Stacked Barplot
stack_data_cd8 = labelled_data %>% filter(Clusters=='CD8+ T-cells') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_cd8)

cells_Patient_cd8 = cells_Patient_cd8 %>% mutate(Helper = case_when(Subcluster=="CD3+ CD8+ T-cells" ~ 1,
                                             T ~ 0))
cells_Patient_cd8 = cells_Patient_cd8 %>% mutate(Helper2 = case_when(group=="NR" ~ 0,
                                                               group=="TCMR" ~ 1,
                                                               group=="CR" ~ 2))

cells_Patient_cd8 = cells_Patient_cd8[order(cells_Patient_cd8$Helper2,-cells_Patient_cd8$Helper,
                                            cells_Patient_cd8$Perc_CellType_Patient),]
head(cells_Patient_cd8)
unique(cells_Patient_cd8$Patient)

stack_plot_cd8 = ggplot(stack_data_cd8, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","#ae017e","#bf812d","#0096FF","#ff77ff"))

tiff("Metaclusters_stacked_CD8.tiff", units="in", width=45, height=25, res=300)
stack_plot_cd8
dev.off()

unique(cells_Patient_cd8$Subcluster)


shapiro.test((cells_Patient_cd8)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_cd8, method='kruskal.test', group.by='Subcluster')

# CD8 T cells
shapiro.test((cells_Patient_cd8 %>% filter(Subcluster == 'CD3+ CD8+ T-cells'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd8 %>% filter(Subcluster == 'CD3+ CD8+ T-cells')))

ggplot(data = (cells_Patient_cd8 %>% filter(Subcluster == 'CD3+ CD8+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD3^"+" ~ CD8^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD8 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) 
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  # stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
  #                    aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Proliferating CD8 T cells
shapiro.test((cells_Patient_cd8 %>% filter(Subcluster == 'Proliferating CD8+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd8 %>% filter(Subcluster == 'Proliferating CD8+ T-cells')))

ggplot(data = (cells_Patient_cd8 %>% filter(Subcluster == 'Proliferating CD8+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Proliferating" ~ CD8^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD8 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.06", as.numeric(..p.format..))))

# Cytotoxic T cells
shapiro.test((cells_Patient_cd8 %>% filter(Subcluster == 'Cytotoxic T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd8 %>% filter(Subcluster == 'Cytotoxic T-cells')))

ggplot(data = (cells_Patient_cd8 %>% filter(Subcluster == 'Cytotoxic T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Cytotoxic" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD8 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ae017e","#ae017e","#ae017e")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.12", as.numeric(..p.format..))))

# PD1+ CD8 T cells
shapiro.test((cells_Patient_cd8 %>% filter(Subcluster == 'PD1+ CD8+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd8 %>% filter(Subcluster == 'PD1+ CD8+ T-cells')))

ggplot(data = (cells_Patient_cd8 %>% filter(Subcluster == 'PD1+ CD8+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(PD1^"+" ~ CD8^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD8 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#bf812d","#bf812d","#bf812d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.05", as.numeric(..p.format..))))

# PD1+CD28+ CD8 T cells
shapiro.test((cells_Patient_cd8 %>% filter(Subcluster == 'PD1+CD28+ CD8+ T-cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_cd8 %>% filter(Subcluster == 'PD1+CD28+ CD8+ T-cells')))

ggplot(data = (cells_Patient_cd8 %>% filter(Subcluster == 'PD1+CD28+ CD8+ T-cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(PD1^"+"~CD28^"+" ~ CD8^"+" ~ "T-cells") + xlab(NULL) + ylab("Cell % per Patient\n(within CD8 population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.12", as.numeric(..p.format..))))


###############
# Macrophages #
###############

cells_per_Patient_macrophages = labelled_data %>% filter(Clusters == 'Macrophages') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_macrophages = labelled_data %>% filter(Clusters == 'Macrophages') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_macrophages = merge(cells_per_Patient_macrophages, cellType_per_Patient_macrophages, all.x=TRUE, by='Patient')
head(cells_Patient_macrophages)
colnames(cells_Patient_macrophages) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_macrophages$Perc_CellType_Patient = cells_Patient_macrophages$Count / cells_Patient_macrophages$CellTotal
head(cells_Patient_macrophages)

cells_Patient_macrophages_avg = cells_Patient_macrophages %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_macrophages_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_macrophages_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within macrophage population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='M1 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='M2 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating M1 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating M2 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='CD11b+ M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='CD11b+ M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='CD11b+ M1 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='CD11b+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='CD11b+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='CD11b+ M2 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='CD16+ M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='CD16+ M1 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='CD16+ M1 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='CD16+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='CD16+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='CD16+ M2 macrophages'))$Count)

summary((cells_Patient_macrophages %>% filter(group=='NR') %>% filter(Subcluster=='HLADR+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR+ M2 macrophages'))$Count)
summary((cells_Patient_macrophages %>% filter(group=='CR') %>% filter(Subcluster=='HLADR+ M2 macrophages'))$Count)

# Stacked Barplot
stack_data_macro = labelled_data %>% filter(Clusters=='Macrophages') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_macro)

stack_data_macro$Subcluster = factor(stack_data_macro$Subcluster,
                                     levels=c("CD11b+ M1 macrophages","CD11b+ M2 macrophages",
                                              "CD16+ M1 macrophages",
                                              "CD16+ M2 macrophages",
                                              "M1 macrophages","M2 macrophages","HLADR+ M2 macrophages",
                                              "Proliferating M1 macrophages","Proliferating M2 macrophages"
                                              ))

cells_Patient_macrophages = cells_Patient_macrophages %>% mutate(Helper = case_when(Subcluster=="M1 macrophages" ~ 1,
                                             T ~ 0))
cells_Patient_macrophages = cells_Patient_macrophages %>% mutate(Helper2 = case_when(group=="NR" ~ 0,
                                                               group=="TCMR" ~ 1,
                                                               group=="CR" ~ 2))

cells_Patient_macrophages = cells_Patient_macrophages[order(cells_Patient_macrophages$Helper2,
                                                            -cells_Patient_macrophages$Helper,
                                            cells_Patient_macrophages$Perc_CellType_Patient),]
head(cells_Patient_macrophages)
unique(cells_Patient_macrophages$Patient)

stack_plot_macro = ggplot(stack_data_macro, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#dfc27d","#bf812d","#6a87a3","#ccff00",
                               "#0096FF","#313695","#FFEA00","#8b008b","#ff77ff"))

tiff("Metaclusters_stacked_Macro.tiff", units="in", width=45, height=25, res=300)
stack_plot_macro
dev.off()

unique(cells_Patient_macrophages$Subcluster)


shapiro.test((cells_Patient_macrophages)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_macrophages, method='kruskal.test', group.by='Subcluster')

# M1 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'M1 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'M1 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'M1 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("M1 macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.92) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.85) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.89) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# M2 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'M2 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'M2 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'M2 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("M2 macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#313695","#313695","#313695")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.8) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.6) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.7) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# Proliferating M1 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M1 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M1 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M1 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Proliferating M1 macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#8b008b","#8b008b","#8b008b")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Proliferating M2 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M2 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M2 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'Proliferating M2 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Proliferating M2 macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.17", as.numeric(..p.format..))))

# CD11b+ M1 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M1 macrophages'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M1 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M1 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD11b^"+" ~ "M1 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#dfc27d","#dfc27d","#dfc27d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.86", as.numeric(..p.format..))))

# CD11b+ M2 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M2 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M2 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD11b+ M2 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD11b^"+" ~ "M2 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#bf812d","#bf812d","#bf812d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# CD16+ M1 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M1 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M1 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M1 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD16^"+" ~ "M1 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#6a87a3","#6a87a3","#6a87a3")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CD16+ M2 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M2 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M2 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'CD16+ M2 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(CD16^"+" ~ "M2 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#ccff00","#ccff00","#ccff00")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.9) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.7) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.8) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# HLADR+ M2 macrophages
shapiro.test((cells_Patient_macrophages %>% filter(Subcluster == 'HLADR+ M2 macrophages'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_macrophages %>% filter(Subcluster == 'HLADR+ M2 macrophages')))

ggplot(data = (cells_Patient_macrophages %>% filter(Subcluster == 'HLADR+ M2 macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(HLADR^"+" ~ "M2 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))


#############
# Monocytes #
#############

cells_per_Patient_monocytes = labelled_data %>% filter(Clusters == 'Monocytes') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_monocytes = labelled_data %>% filter(Clusters == 'Monocytes') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_monocytes = merge(cells_per_Patient_monocytes, cellType_per_Patient_monocytes, all.x=TRUE, by='Patient')
head(cells_Patient_monocytes)
colnames(cells_Patient_monocytes) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_monocytes$Perc_CellType_Patient = cells_Patient_monocytes$Count / cells_Patient_monocytes$CellTotal
head(cells_Patient_monocytes)

cells_Patient_monocytes_avg = cells_Patient_monocytes %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_monocytes_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_monocytes_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within monocyte population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_monocytes %>% filter(group=='NR') %>% filter(Subcluster=='Non-classical monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Non-classical monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='CR') %>% filter(Subcluster=='Non-classical monocytes'))$Count)

summary((cells_Patient_monocytes %>% filter(group=='NR') %>% filter(Subcluster=='Classical monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Classical monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='CR') %>% filter(Subcluster=='Classical monocytes'))$Count)

summary((cells_Patient_monocytes %>% filter(group=='NR') %>% filter(Subcluster=='Intermediate monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Intermediate monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='CR') %>% filter(Subcluster=='Intermediate monocytes'))$Count)

summary((cells_Patient_monocytes %>% filter(group=='NR') %>% filter(Subcluster=='Activated monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Activated monocytes'))$Count)
summary((cells_Patient_monocytes %>% filter(group=='CR') %>% filter(Subcluster=='Activated monocytes'))$Count)

# Stacked Barplot
stack_data_mono = labelled_data %>% filter(Clusters=='Monocytes') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_mono)

cells_Patient_monocytes = cells_Patient_monocytes %>% 
  mutate(Helper = case_when(Subcluster=="Non-classical monocytes" ~ 1,
                                             T ~ 0))
cells_Patient_monocytes = cells_Patient_monocytes %>% mutate(Helper2 = case_when(group=="NR" ~ 0,
                                                               group=="TCMR" ~ 1,
                                                               group=="CR" ~ 2))

cells_Patient_monocytes = cells_Patient_monocytes[order(cells_Patient_monocytes$Helper2,
                                                        -cells_Patient_monocytes$Helper,
                                            cells_Patient_monocytes$Perc_CellType_Patient),]
head(cells_Patient_monocytes)
unique(cells_Patient_monocytes$Patient)

stack_data_mono$Subcluster = factor(stack_data_mono$Subcluster,
                                    levels=c('Activated monocytes','Non-classical monocytes',
                                             'Intermediate monocytes','Classical monocytes'))

stack_plot_mono = ggplot(stack_data_mono, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = TRUE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#0096FF","#bf812d","#ae017e","#FFEA00"))

tiff("Metaclusters_stacked_Mono.tiff", units="in", width=45, height=25, res=300)
stack_plot_mono
dev.off()

unique(cells_Patient_monocytes$Subcluster)


shapiro.test((cells_Patient_monocytes)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_monocytes, method='kruskal.test', group.by='Subcluster')

# Classical monocytes
shapiro.test((cells_Patient_monocytes %>% filter(Subcluster == 'Classical monocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_monocytes %>% filter(Subcluster == 'Classical monocytes')))

ggplot(data = (cells_Patient_monocytes %>% filter(Subcluster == 'Classical monocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Classical monocytes") + xlab(NULL) + ylab("Cell % per Patient\n(within monocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.02, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

# Non-classical monocytes
shapiro.test((cells_Patient_monocytes %>% filter(Subcluster == 'Non-classical monocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_monocytes %>% filter(Subcluster == 'Non-classical monocytes')))

ggplot(data = (cells_Patient_monocytes %>% filter(Subcluster == 'Non-classical monocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Non-classical monocytes") + xlab(NULL) + ylab("Cell % per Patient\n(within monocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#bf812d","#bf812d","#bf812d")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.16", as.numeric(..p.format..))))

# Intermediate monocytes
shapiro.test((cells_Patient_monocytes %>% filter(Subcluster == 'Intermediate monocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_monocytes %>% filter(Subcluster == 'Intermediate monocytes')))

ggplot(data = (cells_Patient_monocytes %>% filter(Subcluster == 'Intermediate monocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Intermediate monocytes") + xlab(NULL) + ylab("Cell % per Patient\n(within monocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ae017e","#ae017e","#ae017e")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8, label.x='TCMR',
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Activated monocytes
shapiro.test((cells_Patient_monocytes %>% filter(Subcluster == 'Activated monocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_monocytes %>% filter(Subcluster == 'Activated monocytes')))

ggplot(data = (cells_Patient_monocytes %>% filter(Subcluster == 'Activated monocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Activated monocytes") + xlab(NULL) + ylab("Cell % per Patient\n(within monocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 1", as.numeric(..p.format..))))

###########
# B Cells #
###########

cells_per_Patient_bcells = labelled_data %>% filter(Clusters == 'B cells') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_bcells = labelled_data %>% filter(Clusters == 'B cells') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_bcells = merge(cells_per_Patient_bcells, cellType_per_Patient_bcells, all.x=TRUE, by='Patient')
head(cells_Patient_bcells)
colnames(cells_Patient_bcells) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_bcells$Perc_CellType_Patient = cells_Patient_bcells$Count / cells_Patient_bcells$CellTotal
head(cells_Patient_bcells)

cells_Patient_bcells_avg = cells_Patient_bcells %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_bcells_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_bcells_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within B Cell population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_bcells %>% filter(group=='NR') %>% filter(Subcluster=='B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='TCMR') %>% filter(Subcluster=='B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='CR') %>% filter(Subcluster=='B cells'))$Count)

summary((cells_Patient_bcells %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating B cells'))$Count)

summary((cells_Patient_bcells %>% filter(group=='NR') %>% filter(Subcluster=='PD1+ B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='TCMR') %>% filter(Subcluster=='PD1+ B cells'))$Count)
summary((cells_Patient_bcells %>% filter(group=='CR') %>% filter(Subcluster=='PD1+ B cells'))$Count)

# Stacked Barplot
stack_data_b = labelled_data %>% filter(Clusters=='B cells') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_b)

cells_Patient_bcells = cells_Patient_bcells %>% mutate(Helper = case_when(Subcluster=="B cells" ~ 1,
                                             T ~ 0))
cells_Patient_bcells = cells_Patient_bcells %>% mutate(Helper2 = case_when(group=="NR" ~ 0,
                                                               group=="TCMR" ~ 1,
                                                               group=="CR" ~ 2))

cells_Patient_bcells = cells_Patient_bcells[order(cells_Patient_bcells$Helper2,
                                                        -cells_Patient_bcells$Helper,
                                            cells_Patient_bcells$Perc_CellType_Patient),]
head(cells_Patient_bcells)
unique(cells_Patient_bcells$Patient)

stack_plot_b = ggplot(stack_data_b, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","#0096FF","#ff77ff"))

tiff("Metaclusters_stacked_Bcells.tiff", units="in", width=45, height=25, res=300)
stack_plot_b
dev.off()

unique(cells_Patient_bcells$Subcluster)


shapiro.test((cells_Patient_bcells)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_bcells, method='kruskal.test', group.by='Subcluster')

# B cells
shapiro.test((cells_Patient_bcells %>% filter(Subcluster == 'B cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_bcells %>% filter(Subcluster == 'B cells')))

ggplot(data = (cells_Patient_bcells %>% filter(Subcluster == 'B cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("B cells") + xlab(NULL) + ylab("Cell % per Patient\n(within B Cell population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.02, size=8,
                     aes(label = sprintf("Overall p = 0.02", as.numeric(..p.format..))))

# Proliferating B cells
shapiro.test((cells_Patient_bcells %>% filter(Subcluster == 'Proliferating B cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_bcells %>% filter(Subcluster == 'Proliferating B cells')))

ggplot(data = (cells_Patient_bcells %>% filter(Subcluster == 'Proliferating B cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Proliferating B cells") + xlab(NULL) + ylab("Cell % per Patient\n(within B Cell population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_x_discrete(limits = c('NR','TCMR','CR')) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.23", as.numeric(..p.format..))))

# PD1+ B cells
shapiro.test((cells_Patient_bcells %>% filter(Subcluster == 'PD1+ B cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_bcells %>% filter(Subcluster == 'PD1+ B cells')))

ggplot(data = (cells_Patient_bcells %>% filter(Subcluster == 'PD1+ B cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(PD1^"+" ~ "B cells") + xlab(NULL) + ylab("Cell % per Patient\n(within B Cell population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#0096FF","#0096FF","#0096FF")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.68", as.numeric(..p.format..))))



###############
# Hepatocytes #
###############

cells_per_Patient_hepatocytes = labelled_data %>% filter(Clusters == 'Hepatocytes') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_hepatocytes = labelled_data %>% filter(Clusters == 'Hepatocytes') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_hepatocytes = merge(cells_per_Patient_hepatocytes, cellType_per_Patient_hepatocytes, all.x=TRUE, by='Patient')
head(cells_Patient_hepatocytes)
colnames(cells_Patient_hepatocytes) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_hepatocytes$Perc_CellType_Patient = cells_Patient_hepatocytes$Count / cells_Patient_hepatocytes$CellTotal
head(cells_Patient_hepatocytes)

cells_Patient_hepatocytes_avg = cells_Patient_hepatocytes %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_hepatocytes_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_hepatocytes_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within Hepatocyte population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_hepatocytes %>% filter(group=='NR') %>% filter(Subcluster=='Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='CR') %>% filter(Subcluster=='Hepatocytes'))$Count)

summary((cells_Patient_hepatocytes %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating Hepatocytes'))$Count)

summary((cells_Patient_hepatocytes %>% filter(group=='NR') %>% filter(Subcluster=='HLADR+ Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR+ Hepatocytes'))$Count)
summary((cells_Patient_hepatocytes %>% filter(group=='CR') %>% filter(Subcluster=='HLADR+ Hepatocytes'))$Count)


# Stacked Barplot
stack_data_hepatocytes = labelled_data %>% filter(Clusters=='Hepatocytes') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_hepatocytes)
unique(stack_data_hepatocytes$Subcluster)

stack_data_hepatocytes$Subcluster = factor(stack_data_hepatocytes$Subcluster,
                                   levels=c("Hepatocytes","Proliferating Hepatocytes",
                                            "HLADR+ Hepatocytes"))

stack_plot_hepatocytes = ggplot(stack_data_hepatocytes, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","#ff77ff","#00ffff"))

tiff("Metaclusters_stacked_Hepatocytes.tiff", units="in", width=45, height=25, res=300)
stack_plot_hepatocytes
dev.off()

unique(cells_Patient_hepatocytes$Subcluster)


shapiro.test((cells_Patient_hepatocytes)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_hepatocytes, method='kruskal.test', group.by='Subcluster')


# Hepatocytes
shapiro.test((cells_Patient_hepatocytes %>% filter(Subcluster == 'Hepatocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'Hepatocytes')))

ggplot(data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'Hepatocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Hepatocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Hepatocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.09, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Proliferating Hepatocytes
shapiro.test((cells_Patient_hepatocytes %>% filter(Subcluster == 'Proliferating Hepatocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'Proliferating Hepatocytes')))

ggplot(data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'Proliferating Hepatocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Proliferating Hepatocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Hepatocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# HLADR+ Hepatocytes
shapiro.test((cells_Patient_hepatocytes %>% filter(Subcluster == 'HLADR+ Hepatocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'HLADR+ Hepatocytes')))

ggplot(data = (cells_Patient_hepatocytes %>% filter(Subcluster == 'HLADR+ Hepatocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("HLADR+ Hepatocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Hepatocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#00ffff","#00ffff","#00ffff")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))


#####################
# Endothelial cells #
#####################

cells_per_Patient_endothelial = labelled_data %>% filter(Clusters == 'Endothelial cells') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_endothelial = labelled_data %>% filter(Clusters == 'Endothelial cells') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_endothelial = merge(cells_per_Patient_endothelial, cellType_per_Patient_endothelial, all.x=TRUE, by='Patient')
head(cells_Patient_endothelial)
colnames(cells_Patient_endothelial) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_endothelial$Perc_CellType_Patient = cells_Patient_endothelial$Count / cells_Patient_endothelial$CellTotal
head(cells_Patient_endothelial)

cells_Patient_endothelial_avg = cells_Patient_endothelial %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_endothelial_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_endothelial_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within Endothelial population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_endothelial %>% filter(group=='NR') %>% filter(Subcluster=='Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='TCMR') %>% filter(Subcluster=='Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='CR') %>% filter(Subcluster=='Endothelial cells'))$Count)

summary((cells_Patient_endothelial %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating Endothelial cells'))$Count)

summary((cells_Patient_endothelial %>% filter(group=='NR') %>% filter(Subcluster=='HLADR+ Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR+ Endothelial cells'))$Count)
summary((cells_Patient_endothelial %>% filter(group=='CR') %>% filter(Subcluster=='HLADR+ Endothelial cells'))$Count)


# Stacked Barplot
stack_data_endothelial = labelled_data %>% filter(Clusters=='Endothelial cells') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_endothelial)
unique(stack_data_endothelial$Subcluster)

stack_data_endothelial$Subcluster = factor(stack_data_endothelial$Subcluster,
                                   levels=c("Endothelial cells","Proliferating Endothelial cells",
                                            "HLADR+ Endothelial cells"))

stack_plot_endothelial = ggplot(stack_data_endothelial, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","#ff77ff","#00ffff"))

tiff("Metaclusters_stacked_Endothelial.tiff", units="in", width=45, height=25, res=300)
stack_plot_endothelial
dev.off()

unique(cells_Patient_endothelial$Subcluster)


shapiro.test((cells_Patient_endothelial)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_endothelial, method='kruskal.test', group.by='Subcluster')


# Endothelial cells
shapiro.test((cells_Patient_endothelial %>% filter(Subcluster == 'Endothelial cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_endothelial %>% filter(Subcluster == 'Endothelial cells')))

ggplot(data = (cells_Patient_endothelial %>% filter(Subcluster == 'Endothelial cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Endothelial cells")) + xlab(NULL) + ylab("Cell % per Patient\n(within Endothelial population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.09, size=8,
                     aes(label = sprintf("Overall p = 0.06", as.numeric(..p.format..))))

# Proliferating Endothelial cells
shapiro.test((cells_Patient_endothelial %>% filter(Subcluster == 'Proliferating Endothelial cells'))$Perc_CellType_Patient) 
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_endothelial %>% filter(Subcluster == 'Proliferating Endothelial cells')))

ggplot(data = (cells_Patient_endothelial %>% filter(Subcluster == 'Proliferating Endothelial cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Proliferating Endothelial cells")) + xlab(NULL) + ylab("Cell % per Patient\n(within Endothelial population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.07", as.numeric(..p.format..))))

# HLADR+ Endothelial cells
shapiro.test((cells_Patient_endothelial %>% filter(Subcluster == 'HLADR+ Endothelial cells'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_endothelial %>% filter(Subcluster == 'HLADR+ Endothelial cells')))

ggplot(data = (cells_Patient_endothelial %>% filter(Subcluster == 'HLADR+ Endothelial cells')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("HLADR+ Endothelial cells")) + xlab(NULL) + ylab("Cell % per Patient\n(within Endothelial population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#00ffff","#00ffff","#00ffff")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.42) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.47, size=8,
                     aes(label = sprintf("Overall p = 0.11", as.numeric(..p.format..))))


##################
# Cholangiocytes #
##################

cells_per_Patient_chol = labelled_data %>% filter(Clusters == 'Cholangiocytes') %>% 
  subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient_chol = labelled_data %>% filter(Clusters == 'Cholangiocytes') %>%
  group_by(group) %>% subset(select=c('Patient','Subcluster')) %>%
  group_by(Patient,Subcluster) %>% dplyr::summarise(n = n())

cells_Patient_chol = merge(cells_per_Patient_chol, cellType_per_Patient_chol, all.x=TRUE, by='Patient')
head(cells_Patient_chol)
colnames(cells_Patient_chol) = c('Patient','group','CellTotal','Subcluster','Count')
cells_Patient_chol$Perc_CellType_Patient = cells_Patient_chol$Count / cells_Patient_chol$CellTotal
head(cells_Patient_chol)

cells_Patient_chol_avg = cells_Patient_chol %>% group_by(group, Subcluster) %>% dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_Patient_chol_avg)

# DISTRIBUTION
ggplot(data = cells_Patient_chol_avg,
                       aes(x = Subcluster, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within Cholangiocyte population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_Patient_chol %>% filter(group=='NR') %>% filter(Subcluster=='Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='TCMR') %>% filter(Subcluster=='Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='CR') %>% filter(Subcluster=='Cholangiocytes'))$Count)

summary((cells_Patient_chol %>% filter(group=='NR') %>% filter(Subcluster=='Proliferating Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='TCMR') %>% filter(Subcluster=='Proliferating Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='CR') %>% filter(Subcluster=='Proliferating Cholangiocytes'))$Count)

summary((cells_Patient_chol %>% filter(group=='NR') %>% filter(Subcluster=='HLADR+ Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='TCMR') %>% filter(Subcluster=='HLADR+ Cholangiocytes'))$Count)
summary((cells_Patient_chol %>% filter(group=='CR') %>% filter(Subcluster=='HLADR+ Cholangiocytes'))$Count)



# Stacked Barplot
stack_data_chol = labelled_data %>% filter(Clusters=='Cholangiocytes') %>% 
  group_by(Patient,Subcluster,group) %>% dplyr::summarise(Count = n())
head(stack_data_chol)
unique(stack_data_chol$Subcluster)

stack_data_chol$Subcluster = factor(stack_data_chol$Subcluster,
                                   levels=c("Cholangiocytes","Proliferating Cholangiocytes",'HLADR+ Cholangiocytes'))

stack_plot_chol = ggplot(stack_data_chol, aes(fill=Subcluster, y=Count, x=Patient)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab(NULL) + ylab(NULL) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # coord_flip() +
  scale_fill_manual(values = c("#FFEA00","#ff77ff","#00ffff"))

tiff("Metaclusters_stacked_Cholangiocytes.tiff", units="in", width=45, height=25, res=300)
stack_plot_chol
dev.off()

unique(cells_Patient_chol$Subcluster)


shapiro.test((cells_Patient_chol)$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = cells_Patient_chol, method='kruskal.test', group.by='Subcluster')


# Cholangiocytes
shapiro.test((cells_Patient_chol %>% filter(Subcluster == 'Cholangiocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_chol %>% filter(Subcluster == 'Cholangiocytes')))

ggplot(data = (cells_Patient_chol %>% filter(Subcluster == 'Cholangiocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Cholangiocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Cholangiocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#FFEA00","#FFEA00","#FFEA00")) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.09, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# Proliferating Cholangiocytes
shapiro.test((cells_Patient_chol %>% filter(Subcluster == 'Proliferating Cholangiocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_chol %>% filter(Subcluster == 'Proliferating Cholangiocytes')))

ggplot(data = (cells_Patient_chol %>% filter(Subcluster == 'Proliferating Cholangiocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("Proliferating Cholangiocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Cholangiocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#ff77ff","#ff77ff","#ff77ff")) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.17", as.numeric(..p.format..))))

# HLADR+ Cholangiocytes
shapiro.test((cells_Patient_chol %>% filter(Subcluster == 'HLADR+ Cholangiocytes'))$Perc_CellType_Patient)
compare_means(Perc_CellType_Patient ~ group, data = (cells_Patient_chol %>% filter(Subcluster == 'HLADR+ Cholangiocytes')))

ggplot(data = (cells_Patient_chol %>% filter(Subcluster == 'HLADR+ Cholangiocytes')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle(expression("HLADR+ Cholangiocytes")) + xlab(NULL) + ylab("Cell % per Patient\n(within Cholangiocyte population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,0.5)) +
  scale_fill_manual(values = c("#00ffff","#00ffff","#00ffff")) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.49, size=8,
                     aes(label = sprintf("Overall p = 0.01", as.numeric(..p.format..))))
```

```{r}
####################################
# M1 vs M2 MACROPHAGE DISTRIBUTION #
####################################

########
# within macrophages
########

head(cells_Patient_macrophages)

cells_Patient_macrophages = cells_Patient_macrophages %>% mutate(Type = case_when(
  Subcluster %in% c("M1 macrophages","Proliferating M1 macrophages",
                    "CD11b+ M1 macrophages (M3)","CD16+ M1 macrophages (M5)") ~ 'All M1 Macrophages',
  Subcluster %in% c("M2 macrophages","Proliferating M2 macrophages",
                    "CD11b+ M2 macrophages (M4)","CD16+ M2 macrophages (M6)",
                    "HLADR+ M2 macrophages (M7)") ~ 'All M2 Macrophages'
))

cells_Patient_macrophagestotal = unique(cells_Patient_macrophages %>% subset(select=c('Patient','group','CellTotal')))
cells_patient_macrophages_M1_M2_total = cells_Patient_macrophages %>% 
  group_by(group, Patient, Type) %>% 
  dplyr::summarise(Total = sum(Count))
cells_patient_macro_M1_M2 = merge(cells_Patient_macrophagestotal,cells_patient_macrophages_M1_M2_total,
                                  by=c('Patient','group'))
head(cells_patient_macro_M1_M2)
cells_patient_macro_M1_M2$Perc_CellType_Patient = cells_patient_macro_M1_M2$Total / cells_patient_macro_M1_M2$CellTotal

cells_patient_macro_M1_M2_avg = cells_patient_macro_M1_M2 %>% group_by(group, Type) %>% 
  dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_patient_macro_M1_M2_avg)

# DISTRIBUTION
ggplot(data = cells_patient_macro_M1_M2_avg,
                       aes(x = Type, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within macrophage population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# M1
ggplot(data = (cells_patient_macro_M1_M2 %>% filter(Type=='All M1 Macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("All M1 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=24),
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.92) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.85) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.89) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p = %5.2f", as.numeric(..p.format..))))

# M2
ggplot(data = (cells_patient_macro_M1_M2 %>% filter(Type=='All M2 Macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("All M2 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(within macrophage population)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=24),
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.92) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.85) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 0.89) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.99, size=8,
                     aes(label = sprintf("Overall p = %5.2f", as.numeric(..p.format..))))




##########
# Within immune population
##########

head(cells_Patient_immune_subcluster)

cells_Patient_immune_subcluster = cells_Patient_immune_subcluster %>% mutate(Type = case_when(
  Subcluster %in% c("M1 macrophages","Proliferating M1 macrophages",
                    "CD11b+ M1 macrophages (M3)","CD16+ M1 macrophages (M5)") ~ 'All M1 Macrophages',
  Subcluster %in% c("M2 macrophages","Proliferating M2 macrophages",
                    "CD11b+ M2 macrophages (M4)","CD16+ M2 macrophages (M6)",
                    "HLADR+ M2 macrophages (M7)") ~ 'All M2 Macrophages'
))

cells_patient_immunetotal = unique(cells_Patient_immune_subcluster %>% subset(select=c('Patient','group','CellTotal')))
cells_patient_M1_M2_total = cells_Patient_immune_subcluster %>% filter(Cluster == 'Macrophages') %>% 
  group_by(group, Patient, Type) %>% 
  dplyr::summarise(Total = sum(Count))
cells_patient_M1_M2 = merge(cells_patient_immunetotal,cells_patient_M1_M2_total, by=c('Patient','group'))
head(cells_patient_M1_M2)
cells_patient_M1_M2$Perc_CellType_Patient = cells_patient_M1_M2$Total / cells_patient_M1_M2$CellTotal

cells_patient_M1_M2_avg = cells_patient_M1_M2 %>% group_by(group, Type) %>% 
  dplyr::summarise(Avg.Percent = mean(Perc_CellType_Patient))
head(cells_patient_M1_M2_avg)

# DISTRIBUTION
ggplot(data = cells_patient_M1_M2_avg,
                       aes(x = Type, y = Avg.Percent,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Avg. Percent of Cells\n(within immune population)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

# COUNTS
summary((cells_patient_M1_M2 %>% filter(group=='NR') %>% filter(Type=='All M1 Macrophages'))$Total)
summary((cells_patient_M1_M2 %>% filter(group=='TCMR') %>% filter(Type=='All M1 Macrophages'))$Total)
summary((cells_patient_M1_M2 %>% filter(group=='CR') %>% filter(Type=='All M1 Macrophages'))$Total)

summary((cells_patient_M1_M2 %>% filter(group=='NR') %>% filter(Type=='All M2 Macrophages'))$Total)
summary((cells_patient_M1_M2 %>% filter(group=='TCMR') %>% filter(Type=='All M2 Macrophages'))$Total)
summary((cells_patient_M1_M2 %>% filter(group=='CR') %>% filter(Type=='All M2 Macrophages'))$Total)

# M1
ggplot(data = (cells_patient_M1_M2 %>% filter(Type=='All M1 Macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("All M1 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(overall immune)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=24),
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
                                                                c("NR","TCMR"),
                                                                c("CR","TCMR")),
                     size = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.9, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))

# M2
ggplot(data = (cells_patient_M1_M2 %>% filter(Type=='All M2 Macrophages')), 
               aes(x = group, y = Perc_CellType_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("All M2 Macrophages") + xlab(NULL) + ylab("Cell % per Patient\n(overall immune)") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=24),
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(0,1)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 7, label.y = 0.7) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 7, label.y = 0.5) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 7, label.y = 0.6) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.9, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))
```

PROPORTIONS / RATIOS

```{r}
########################
# IMMUNE VS NON-IMMUNE #
########################

head(cells_Patient_type)

cells_nonimmune = cells_Patient_type %>% subset(select=c('Patient','group','Type','sum')) %>% 
  filter(Type == 'Non-Immune Cells')
cells_immune = cells_Patient_type %>% subset(select=c('Patient','group','Type','sum')) %>% 
  filter(Type == 'Immune Cells')

immune_nonimmune = merge(cells_immune,cells_nonimmune, by=c('Patient','group'))
head(immune_nonimmune)
colnames(immune_nonimmune) = c('Patient','group','Type1','Count1','Type2','Count2')
head(immune_nonimmune)
immune_nonimmune$Ratio = immune_nonimmune$Count1 / immune_nonimmune$Count2
head(immune_nonimmune)

# MEDIAN RATIO
summary((immune_nonimmune %>% filter(group=='NR'))$Ratio)
summary((immune_nonimmune %>% filter(group=='TCMR'))$Ratio)
summary((immune_nonimmune %>% filter(group=='CR'))$Ratio)

immune_nonimmune_avg = immune_nonimmune %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(immune_nonimmune_avg)

compare_means(Ratio ~ group, data=immune_nonimmune, method='kruskal.test')
compare_means(Ratio ~ group, data=immune_nonimmune)

# DISTRIBUTION
ggplot(data = immune_nonimmune_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("Immune:Non-Immune") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = immune_nonimmune, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Immune:Non-Immune") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 2.6) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 1.8) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 2.3) +
  stat_compare_means(method = 'kruskal.test', label.y = 3, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))


#################
# Meta-Clusters #
#################

head(cells_Patient)

cells_cd4 = cells_Patient %>% subset(select=c('Patient','group','Clusters','Count')) %>% 
  filter(Clusters == 'CD4+ T-cells')
cells_cd8 = cells_Patient %>% subset(select=c('Patient','group','Clusters','Count')) %>% 
  filter(Clusters == 'CD8+ T-cells')
cells_macro = cells_Patient %>% subset(select=c('Patient','group','Clusters','Count')) %>% 
  filter(Clusters == 'Macrophages')
cells_mono = cells_Patient %>% subset(select=c('Patient','group','Clusters','Count')) %>% 
  filter(Clusters == 'Monocytes')

## CD8 : CD4
cd8_cd4 = merge(cells_cd8,cells_cd4, by=c('Patient','group'))
head(cd8_cd4)
colnames(cd8_cd4) = c('Patient','group','Cluster1','Count1','Cluster2','Count2')
head(cd8_cd4)
cd8_cd4$Ratio = cd8_cd4$Count1 / cd8_cd4$Count2
head(cd8_cd4)

# MEDIAN RATIO
summary((cd8_cd4 %>% filter(group=='NR'))$Ratio)
summary((cd8_cd4 %>% filter(group=='TCMR'))$Ratio)
summary((cd8_cd4 %>% filter(group=='CR'))$Ratio)

cd8_cd4_avg = cd8_cd4 %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_cd4_avg)

compare_means(Ratio ~ group, data=cd8_cd4, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_cd4)

# DISTRIBUTION
ggplot(data = cd8_cd4_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("CD8:CD4") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,3)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_cd4, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD8:CD4") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 13) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 10) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 12) +
  stat_compare_means(method = 'kruskal.test', label.y = 15, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

## Macrophages : Monocytes
macro_mono = merge(cells_macro,cells_mono, by=c('Patient','group'))
head(macro_mono)
colnames(macro_mono) = c('Patient','group','Cluster1','Count1','Cluster2','Count2')
head(macro_mono)
macro_mono$Ratio = macro_mono$Count1 / macro_mono$Count2
head(macro_mono)

# MEDIAN RATIO
summary((macro_mono %>% filter(group=='NR'))$Ratio)
summary((macro_mono %>% filter(group=='TCMR'))$Ratio)
summary((macro_mono %>% filter(group=='CR'))$Ratio)

macro_mono_avg = macro_mono %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(macro_mono_avg)

compare_means(Ratio ~ group, data=macro_mono, method='kruskal.test')
compare_means(Ratio ~ group, data=macro_mono)

# DISTRIBUTION
ggplot(data = macro_mono_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("Macrophage:Monocyte") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,40)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = macro_mono, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Macrophage:Monocyte") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 150) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 110) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 130) +
  stat_compare_means(method = 'kruskal.test', label.y = 170, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

## CD8 : Macrophages
cd8_macro = merge(cells_cd8,cells_macro, by=c('Patient','group'))
head(cd8_macro)
colnames(cd8_macro) = c('Patient','group','Cluster1','Count1','Cluster2','Count2')
head(cd8_macro)
cd8_macro$Ratio = cd8_macro$Count1 / cd8_macro$Count2
head(cd8_macro)

# MEDIAN RATIO
summary((cd8_macro %>% filter(group=='NR'))$Ratio)
summary((cd8_macro %>% filter(group=='TCMR'))$Ratio)
summary((cd8_macro %>% filter(group=='CR'))$Ratio)

cd8_macro_avg = cd8_macro %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_macro_avg)

compare_means(Ratio ~ group, data=cd8_macro, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_macro)

# DISTRIBUTION
ggplot(data = cd8_macro_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("CD8:Macrophage") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,1.5)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_macro, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD8:Macrophage") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 8) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 6) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 10, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

## CD4 : Macrophages
cd4_macro = merge(cells_cd4,cells_macro, by=c('Patient','group'))
head(cd4_macro)
colnames(cd4_macro) = c('Patient','group','Cluster1','Count1','Cluster2','Count2')
head(cd4_macro)
cd4_macro$Ratio = cd4_macro$Count1 / cd4_macro$Count2
head(cd4_macro)

# MEDIAN RATIO
summary((cd4_macro %>% filter(group=='NR'))$Ratio)
summary((cd4_macro %>% filter(group=='TCMR'))$Ratio)
summary((cd4_macro %>% filter(group=='CR'))$Ratio)

cd4_macro_avg = cd4_macro %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd4_macro_avg)

compare_means(Ratio ~ group, data=cd4_macro, method='kruskal.test')
compare_means(Ratio ~ group, data=cd4_macro)

# DISTRIBUTION
ggplot(data = cd4_macro_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("CD4:Macrophage") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd4_macro, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD4:Macrophage") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 6) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 5) +
  stat_compare_means(method = 'kruskal.test', label.y = 7, size=8,
                     aes(label = sprintf("Overall p = 0.02", as.numeric(..p.format..))))

##############
# CD4+ Cells #
##############

head(cells_Patient_cd4)

cd4_treg_HLADRpos = cells_Patient_cd4 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'HLADR+ CD4+ Tregs')
cd4_treg_HLADRneg = cells_Patient_cd4 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'HLADR- CD4+ Tregs')
prolif_cd4 = cells_Patient_cd4 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'Proliferating CD4+ T-cells')
pd1_cd4 = cells_Patient_cd4 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'PD1+ CD4+ T-cells')

## HLADR+ CD4 Treg cells : Proliferating CD4 T cells
cd4_treg_HLADRpos_prolif = merge(cd4_treg_HLADRpos,prolif_cd4, by=c('Patient','group'))
head(cd4_treg_HLADRpos_prolif)
colnames(cd4_treg_HLADRpos_prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd4_treg_HLADRpos_prolif)
cd4_treg_HLADRpos_prolif$Ratio = cd4_treg_HLADRpos_prolif$Count1 / cd4_treg_HLADRpos_prolif$Count2
head(cd4_treg_HLADRpos_prolif)

# MEDIAN RATIO
summary((cd4_treg_HLADRpos_prolif %>% filter(group=='NR'))$Ratio)
summary((cd4_treg_HLADRpos_prolif %>% filter(group=='TCMR'))$Ratio)
summary((cd4_treg_HLADRpos_prolif %>% filter(group=='CR'))$Ratio)

cd4_treg_HLADRpos_prolif_avg = cd4_treg_HLADRpos_prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd4_treg_HLADRpos_prolif_avg)

compare_means(Ratio ~ group, data=cd4_treg_HLADRpos_prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=cd4_treg_HLADRpos_prolif)

# DISTRIBUTION
ggplot(data = cd4_treg_HLADRpos_prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nProliferating CD4+ T-cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd4_treg_HLADRpos_prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nProliferating CD4+ T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 15) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 11) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 13) +
  stat_compare_means(method = 'kruskal.test', label.y = 19, size=8,
                     aes(label = sprintf("Overall p = 0.47", as.numeric(..p.format..))))

## HLADR- CD4 Treg cells : Proliferating CD4 T cells
cd4_treg_HLADRneg_prolif = merge(cd4_treg_HLADRneg,prolif_cd4, by=c('Patient','group'))
head(cd4_treg_HLADRneg_prolif)
colnames(cd4_treg_HLADRneg_prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd4_treg_HLADRneg_prolif)
cd4_treg_HLADRneg_prolif$Ratio = cd4_treg_HLADRneg_prolif$Count1 / cd4_treg_HLADRneg_prolif$Count2
head(cd4_treg_HLADRneg_prolif)

# MEDIAN RATIO
summary((cd4_treg_HLADRneg_prolif %>% filter(group=='NR'))$Ratio)
summary((cd4_treg_HLADRneg_prolif %>% filter(group=='TCMR'))$Ratio)
summary((cd4_treg_HLADRneg_prolif %>% filter(group=='CR'))$Ratio)

cd4_treg_HLADRneg_prolif_avg = cd4_treg_HLADRneg_prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd4_treg_HLADRneg_prolif_avg)

compare_means(Ratio ~ group, data=cd4_treg_HLADRneg_prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=cd4_treg_HLADRneg_prolif)

# DISTRIBUTION
ggplot(data = cd4_treg_HLADRneg_prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR- CD4+ Tregs\nto\nProliferating CD4+ T-cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  scale_x_discrete(limits = c('NR','TCMR','CR'),
                   labels = c('NR','TCMR','CR'))

ggplot(data = cd4_treg_HLADRneg_prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR- CD4+ Tregs\nto\nProliferating CD4+ T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(limits=c(0,5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 15) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 11) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
  #                    size = 3, label.y = 13) +
  # stat_compare_means(method = 'kruskal.test', label.y = 19, size=8,
  #                    aes(label = sprintf("Overall p = 0.02", as.numeric(..p.format..)))) +
  scale_x_discrete(limits = c('NR','TCMR','CR'),
                   labels = c('NR','TCMR','CR'))

## PD1+ CD4 cells : Proliferating CD4 T cells
cd4_pd1_prolif = merge(pd1_cd4,prolif_cd4, by=c('Patient','group'))
head(cd4_pd1_prolif)
colnames(cd4_pd1_prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd4_pd1_prolif)
cd4_pd1_prolif$Ratio = cd4_pd1_prolif$Count1 / cd4_pd1_prolif$Count2
head(cd4_pd1_prolif)

# MEDIAN RATIO
summary((cd4_pd1_prolif %>% filter(group=='NR'))$Ratio)
summary((cd4_pd1_prolif %>% filter(group=='TCMR'))$Ratio)
summary((cd4_pd1_prolif %>% filter(group=='CR'))$Ratio)

cd4_pd1_prolif_avg = cd4_pd1_prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd4_pd1_prolif_avg)

compare_means(Ratio ~ group, data=cd4_pd1_prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=cd4_pd1_prolif)

# DISTRIBUTION
ggplot(data = cd4_pd1_prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("PD1+ CD4 T cells\nto\nProliferating CD4 T cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  scale_x_discrete(limits = c('NR','TCMR','CR'),
                   labels = c('NR','TCMR','CR'))

ggplot(data = cd4_pd1_prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("PD1+ CD4 T cells\nto\nProliferating CD4 T cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(limits=c(0,17)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  # stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
  #                                                               c("NR","TCMR"),
  #                                                               c("CR","TCMR")),
  #                    size = 7) +
  # stat_compare_means(method = 'kruskal.test', label.y = 100, size=7,
  #                    aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..)))) +
  scale_x_discrete(limits = c('NR','TCMR','CR'),
                   labels = c('NR','TCMR','CR'))


##############
# CD8+ Cells #
##############

head(cells_Patient_cd8)

cd8_cyto = cells_Patient_cd8 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'Cytotoxic T-cells')
prolif_cd8 = cells_Patient_cd8 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'Proliferating CD8+ T-cells')
pd1cd28_cd8 = cells_Patient_cd8 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'PD1+CD28+ CD8+ T-cells')
pd1_cd8 = cells_Patient_cd8 %>% subset(select=c('Patient','group','Subcluster','Count')) %>% 
  filter(Subcluster == 'PD1+ CD8+ T-cells')

## PD1+ CD8 T cells : Proliferating CD8 T cells
cd8_pd1_prolif = merge(pd1_cd8,prolif_cd8, by=c('Patient','group'))
head(cd8_pd1_prolif)
colnames(cd8_pd1_prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd8_pd1_prolif)
cd8_pd1_prolif$Ratio = cd8_pd1_prolif$Count1 / cd8_pd1_prolif$Count2
head(cd8_pd1_prolif)

# MEDIAN RATIO
summary((cd8_pd1_prolif %>% filter(group=='NR'))$Ratio)
summary((cd8_pd1_prolif %>% filter(group=='TCMR'))$Ratio)
summary((cd8_pd1_prolif %>% filter(group=='CR'))$Ratio)

cd8_pd1_prolif_avg = cd8_pd1_prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_pd1_prolif_avg)

compare_means(Ratio ~ group, data=cd8_pd1_prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_pd1_prolif)

# DISTRIBUTION
ggplot(data = cd8_pd1_prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("PD1+ CD8 T cells\nto\nProliferating CD8 T cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,1)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_pd1_prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("PD1+ CD8 T cells\nto\nProliferating CD8 T cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 25) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 17) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 21) +
  stat_compare_means(method = 'kruskal.test', label.y = 30, size=8,
                     aes(label = sprintf("Overall p = 0.1", as.numeric(..p.format..))))

## PD1+ CD8 T cells : Cytotoxic T cells
cd8_pd1_cyto = merge(pd1_cd8,cd8_cyto, by=c('Patient','group'))
head(cd8_pd1_cyto)
colnames(cd8_pd1_cyto) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd8_pd1_cyto)
cd8_pd1_cyto$Ratio = cd8_pd1_cyto$Count1 / cd8_pd1_cyto$Count2
head(cd8_pd1_cyto)

# MEDIAN RATIO
summary((cd8_pd1_cyto %>% filter(group=='NR'))$Ratio)
summary((cd8_pd1_cyto %>% filter(group=='TCMR'))$Ratio)
summary((cd8_pd1_cyto %>% filter(group=='CR'))$Ratio)

cd8_pd1_cyto_avg = cd8_pd1_cyto %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_pd1_cyto_avg)

compare_means(Ratio ~ group, data=cd8_pd1_cyto, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_pd1_cyto)

# DISTRIBUTION
ggplot(data = cd8_pd1_cyto_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("PD1+ CD8 T cells\nto\nCytotoxic T cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,15)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_pd1_cyto, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("PD1+ CD8 T cells\nto\nCytotoxic CD8 T cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 65) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 50) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 58) +
  stat_compare_means(method = 'kruskal.test', label.y = 80, size=8,
                     aes(label = sprintf("Overall p = 0.02", as.numeric(..p.format..))))

## PD1+CD28+ CD8 T cells : Proliferating CD8 T cells
cd8_pd1cd28_prolif = merge(pd1cd28_cd8,prolif_cd8, by=c('Patient','group'))
head(cd8_pd1cd28_prolif)
colnames(cd8_pd1cd28_prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd8_pd1cd28_prolif)
cd8_pd1cd28_prolif$Ratio = cd8_pd1cd28_prolif$Count1 / cd8_pd1cd28_prolif$Count2
head(cd8_pd1cd28_prolif)

# MEDIAN RATIO
summary((cd8_pd1cd28_prolif %>% filter(group=='NR'))$Ratio)
summary((cd8_pd1cd28_prolif %>% filter(group=='TCMR'))$Ratio)
summary((cd8_pd1cd28_prolif %>% filter(group=='CR'))$Ratio)

cd8_pd1cd28_prolif_avg = cd8_pd1cd28_prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_pd1cd28_prolif_avg)

compare_means(Ratio ~ group, data=cd8_pd1cd28_prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_pd1cd28_prolif)

# DISTRIBUTION
ggplot(data = cd8_pd1cd28_prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("PD1+CD28+ CD8 T cells\nto\nProliferating CD8 T cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,5)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_pd1cd28_prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("PD1+CD28+ CD8 T cells\nto\nProliferating CD8 T cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 65) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 50) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 58) +
  stat_compare_means(method = 'kruskal.test', label.y = 80, size=8,
                     aes(label = sprintf("Overall p = 0.02", as.numeric(..p.format..))))

## PD1+CD28+ CD8 T cells : Cytotoxic T cells
cd8_pd1cd28_cyto = merge(pd1cd28_cd8,cd8_cyto, by=c('Patient','group'))
head(cd8_pd1cd28_cyto)
colnames(cd8_pd1cd28_cyto) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(cd8_pd1cd28_cyto)
cd8_pd1cd28_cyto$Ratio = cd8_pd1cd28_cyto$Count1 / cd8_pd1cd28_cyto$Count2
head(cd8_pd1cd28_cyto)

# MEDIAN RATIO
summary((cd8_pd1cd28_cyto %>% filter(group=='NR'))$Ratio)
summary((cd8_pd1cd28_cyto %>% filter(group=='TCMR'))$Ratio)
summary((cd8_pd1cd28_cyto %>% filter(group=='CR'))$Ratio)

cd8_pd1cd28_cyto_avg = cd8_pd1cd28_cyto %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_pd1cd28_cyto_avg)

# DISTRIBUTION
ggplot(data = cd8_pd1cd28_cyto_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("PD1+CD28+ CD8 T cells\nto\nCytotoxic T cells") + xlab("") + ylab("Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_pd1cd28_cyto, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("PD1+CD28+ CD8 T cells\nto\nCytotoxic CD8 T cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
                                                                c("NR","TCMR"),
                                                                c("CR","TCMR")),
                     size = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 110, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))


###############
# Macrophages #
###############

head(cells_Patient_macrophages)

macro_m1 = cells_Patient_macrophages %>% subset(select=c('Patient','group','Type','Count')) %>% 
  filter(Type=='All M1 Macrophages')
macro_m2 = cells_Patient_macrophages %>% subset(select=c('Patient','group','Type','Count')) %>% 
  filter(Type=='All M2 Macrophages')

m2_m1 = merge(macro_m2,macro_m1, by=c('Patient','group'))
head(m2_m1)
colnames(m2_m1) = c('Patient','group','Type1','Count1','Type2','Count2')
head(m2_m1)
m2_m1$Ratio = m2_m1$Count1 / m2_m1$Count2
head(m2_m1)

# MEDIAN RATIO
summary((m2_m1 %>% filter(group=='NR'))$Ratio)
summary((m2_m1 %>% filter(group=='TCMR'))$Ratio)
summary((m2_m1 %>% filter(group=='CR'))$Ratio)

m2_m1_avg = m2_m1 %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(m2_m1_avg)

compare_means(Ratio ~ group, data=m2_m1, method='kruskal.test')
compare_means(Ratio ~ group, data=m2_m1)

# DISTRIBUTION
ggplot(data = m2_m1_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("M2:M1 macrophages") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_y_continuous(limits=c(0,25)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = m2_m1, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("M2:M1 macrophages") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 300) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 260) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 280) +
  stat_compare_means(method = 'kruskal.test', label.y = 400, size=8,
                     aes(label = sprintf("Overall p = 0.05", as.numeric(..p.format..))))

#############
# CD8 to M1 #
#############

cd8_m1 = merge(cells_cd8,macro_m1, by=c('Patient','group'))
head(cd8_m1)
colnames(cd8_m1) = c('Patient','group','Cluster1','Count1','Type2','Count2')
head(cd8_m1)
cd8_m1$Ratio = cd8_m1$Count1 / cd8_m1$Count2
head(cd8_m1)

# MEDIAN RATIO
summary((cd8_m1 %>% filter(group=='NR'))$Ratio)
summary((cd8_m1 %>% filter(group=='TCMR'))$Ratio)
summary((cd8_m1 %>% filter(group=='CR'))$Ratio)

cd8_m1_avg = cd8_m1 %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_m1_avg)

compare_means(Ratio ~ group, data=cd8_m1, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_m1)

# DISTRIBUTION
ggplot(data = cd8_m1_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("CD8+ T-cells:M1 macrophages") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,25)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_m1, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD8+ T-cells:M1 macrophages") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 1000) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 800) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 900) +
  stat_compare_means(method = 'kruskal.test', label.y = 1200, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))


#############
# CD8 to M2 #
#############

cd8_m2 = merge(cells_cd8,macro_m2, by=c('Patient','group'))
head(cd8_m2)
colnames(cd8_m2) = c('Patient','group','Cluster1','Count1','Type2','Count2')
head(cd8_m2)
cd8_m2$Ratio = cd8_m2$Count1 / cd8_m2$Count2
head(cd8_m2)

# MEDIAN RATIO
summary((cd8_m2 %>% filter(group=='NR'))$Ratio)
summary((cd8_m2 %>% filter(group=='TCMR'))$Ratio)
summary((cd8_m2 %>% filter(group=='CR'))$Ratio)

cd8_m2_avg = cd8_m2 %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(cd8_m2_avg)

compare_means(Ratio ~ group, data=cd8_m2, method='kruskal.test')
compare_means(Ratio ~ group, data=cd8_m2)

# DISTRIBUTION
ggplot(data = cd8_m2_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("CD8+ T-cells:M2 macrophages") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,25)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = cd8_m2, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD8+ T-cells:M2 macrophages") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # scale_y_continuous(limits=c(0,0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 1400) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 1200) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 1300) +
  stat_compare_means(method = 'kruskal.test', label.y = 1600, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

####################################
# HLADR+ Treg to Proliferating CD8 #
####################################

head(cd4_treg)
head(prolif_cd8)

treg_HLADRpos_cd8prolif = merge(cd4_treg_HLADRpos,prolif_cd8, by=c('Patient','group'))
head(treg_HLADRpos_cd8prolif)
colnames(treg_HLADRpos_cd8prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(treg_HLADRpos_cd8prolif)
treg_HLADRpos_cd8prolif$Ratio = treg_HLADRpos_cd8prolif$Count1 / treg_HLADRpos_cd8prolif$Count2
head(treg_HLADRpos_cd8prolif)

# MEDIAN RATIO
summary((treg_HLADRpos_cd8prolif %>% filter(group=='NR'))$Ratio)
summary((treg_HLADRpos_cd8prolif %>% filter(group=='TCMR'))$Ratio)
summary((treg_HLADRpos_cd8prolif %>% filter(group=='CR'))$Ratio)

treg_HLADRpos_cd8prolif_avg = treg_HLADRpos_cd8prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(treg_HLADRpos_cd8prolif_avg)

# DISTRIBUTION
ggplot(data = treg_HLADRpos_cd8prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nProliferating CD8+ T-cells") + xlab("") + ylab("Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = treg_HLADRpos_cd8prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nProliferating CD8+ T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
                                                                c("NR","TCMR"),
                                                                c("CR","TCMR")),
                     size = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 10, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))

############################
# HLADR+ Treg to Cytotoxic #
############################

head(cd4_treg)
head(cd8_cyto)

treg_hladrpos_cyto = merge(cd4_treg_HLADRpos,cd8_cyto, by=c('Patient','group'))
head(treg_hladrpos_cyto)
colnames(treg_hladrpos_cyto) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(treg_hladrpos_cyto)
treg_hladrpos_cyto$Ratio = treg_hladrpos_cyto$Count1 / treg_hladrpos_cyto$Count2
head(treg_hladrpos_cyto)

# MEDIAN RATIO
summary((treg_hladrpos_cyto %>% filter(group=='NR'))$Ratio)
summary((treg_hladrpos_cyto %>% filter(group=='TCMR'))$Ratio)
summary((treg_hladrpos_cyto %>% filter(group=='CR'))$Ratio)

treg_hladrpos_cyto_avg = treg_hladrpos_cyto %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(treg_hladrpos_cyto_avg)

# DISTRIBUTION
ggplot(data = treg_hladrpos_cyto_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nCytotoxic T-cells") + xlab("") + ylab("Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = treg_hladrpos_cyto, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR+ CD4+ Tregs\nto\nCytotoxic T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
                                                                c("NR","TCMR"),
                                                                c("CR","TCMR")),
                     size = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 30, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))


####################################
# HLADR- Treg to Proliferating CD8 #
####################################

head(cd4_treg)
head(prolif_cd8)

treg_HLADRneg_cd8prolif = merge(cd4_treg_HLADRneg,prolif_cd8, by=c('Patient','group'))
head(treg_HLADRneg_cd8prolif)
colnames(treg_HLADRneg_cd8prolif) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(treg_HLADRneg_cd8prolif)
treg_HLADRneg_cd8prolif$Ratio = treg_HLADRneg_cd8prolif$Count1 / treg_HLADRneg_cd8prolif$Count2
head(treg_HLADRneg_cd8prolif)

# MEDIAN RATIO
summary((treg_HLADRneg_cd8prolif %>% filter(group=='NR'))$Ratio)
summary((treg_HLADRneg_cd8prolif %>% filter(group=='TCMR'))$Ratio)
summary((treg_HLADRneg_cd8prolif %>% filter(group=='CR'))$Ratio)

treg_HLADRneg_cd8prolif_avg = treg_HLADRneg_cd8prolif %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(treg_HLADRneg_cd8prolif_avg)

compare_means(Ratio ~ group, data=treg_HLADRneg_cd8prolif, method='kruskal.test')
compare_means(Ratio ~ group, data=treg_HLADRneg_cd8prolif)

# DISTRIBUTION
ggplot(data = treg_HLADRneg_cd8prolif_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR- CD4+ Tregs\nto\nProliferating CD8+ T-cells") + xlab("") + ylab("Avg. Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        panel.grid=element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  # scale_y_continuous(limits=c(0,5)) +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = treg_HLADRneg_cd8prolif, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR- CD4+ Tregs\nto\nProliferating CD8+ T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(limits=c(0,10)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 8) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 6) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 9.5, size=8,
                     aes(label = sprintf("Overall p = 0.06", as.numeric(..p.format..))))

############################
# HLADR- Treg to Cytotoxic #
############################

head(cd4_treg)
head(cd8_cyto)

treg_hladrneg_cyto = merge(cd4_treg_HLADRneg,cd8_cyto, by=c('Patient','group'))
head(treg_hladrneg_cyto)
colnames(treg_hladrneg_cyto) = c('Patient','group','Subcluster1','Count1','Subcluster2','Count2')
head(treg_hladrneg_cyto)
treg_hladrneg_cyto$Ratio = treg_hladrneg_cyto$Count1 / treg_hladrneg_cyto$Count2
head(treg_hladrneg_cyto)

# MEDIAN RATIO
summary((treg_hladrneg_cyto %>% filter(group=='NR'))$Ratio)
summary((treg_hladrneg_cyto %>% filter(group=='TCMR'))$Ratio)
summary((treg_hladrneg_cyto %>% filter(group=='CR'))$Ratio)

treg_hladrneg_cyto_avg = treg_hladrneg_cyto %>% group_by(group) %>% 
  dplyr::summarise(Avg.Ratio = mean(Ratio))
head(treg_hladrneg_cyto_avg)

# DISTRIBUTION
ggplot(data = treg_hladrneg_cyto_avg,
                       aes(x = group, y = Avg.Ratio,
                           fill=group)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle("HLADR- CD4+ Tregs\nto\nCytotoxic T-cells") + xlab("") + ylab("Ratio") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=25),
        plot.title=element_text(size = 25, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  # coord_flip() +
  scale_fill_manual(values = c("gray","gray","gray"))

ggplot(data = treg_hladrneg_cyto, aes(x = group, y = Ratio,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("HLADR- CD4+ Tregs\nto\nCytotoxic T-cells") + xlab(NULL) + ylab("Ratio") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position = 'none',
        aspect.ratio=1,
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("gray","gray","gray")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR"),
                                                                c("NR","TCMR"),
                                                                c("CR","TCMR")),
                     size = 7) +
  stat_compare_means(method = 'kruskal.test', label.y = 30, size=7,
                     aes(label = sprintf("Overall p = %5.3f", as.numeric(..p.format..))))
```

# Spatial Analysis

```{r}
sce_adult_labelled <- buildSpatialGraph(sce_adult_labelled, img_id = "sample_id",
                                 type = "knn",k = 10)

colPair(sce_adult_labelled, 'knn_interaction_graph')
```

```{r}
#########################
# NEIGHBORHOOD ANALYSIS #
##### METACLUSTERS ######
#########################

# NR
sce_adult_labelled_NR = sce_adult_labelled[,sce_adult_labelled$group=='NR']

out_NR_all = testInteractions(sce_adult_labelled_NR, 
                        group_by = "sample_id",
                        label = "Clusters", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029)
                        )

head(out_NR_all)

write_csv(as.data.frame(out_NR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/24)), # Divided by number of ROIs
    "NR_histocat_metaclusters_interactions_knn.csv")

out_NR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/24) %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),"blue",'gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('NR') +
        xlab(NULL) + ylab(NULL)

# TCMR
sce_adult_labelled_TCMR = sce_adult_labelled[,sce_adult_labelled$group=='TCMR']

out_TCMR_all = testInteractions(sce_adult_labelled_TCMR, 
                        group_by = "sample_id",
                        label = "Clusters", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029)
                        )

head(out_TCMR_all)

write_csv(as.data.frame(out_TCMR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/58)), # Divided by number of ROIs
    "TCMR_classic_metaclusters_interactions_knn.csv")

out_TCMR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/58) %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),"blue",'gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('TCMR') +
        xlab(NULL) + ylab(NULL)


# CR
sce_adult_labelled_CR = sce_adult_labelled[,sce_adult_labelled$group=='CR']

out_CR_all = testInteractions(sce_adult_labelled_CR, 
                        group_by = "sample_id",
                        label = "Clusters", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029)
                        )

head(out_CR_all)

write_csv(as.data.frame(out_CR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/14)), # Divided by number of ROIs
    "CR_classic_metaclusters_interactions_knn.csv")

out_CR_all %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/14)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('CR') +
        xlab(NULL) + ylab(NULL)
```

```{r}
#########################
# NEIGHBORHOOD ANALYSIS #
###### SUBCLUSTERS ######
#########################

# NR
unique(sce_adult_labelled$Subcluster)
sce_adult_labelled_NR = sce_adult_labelled[,sce_adult_labelled$group=='NR']

out_NR_subcluster = testInteractions(sce_adult_labelled_NR, 
                        group_by = "sample_id",
                        label = "Subcluster", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_NR_subcluster)

write_csv(as.data.frame(out_NR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/24)), # Divided by number of ROIs
    "NR_classic_subcluster_interactions_knn.csv")

tiff("Subcluster knn Interactions NR.tiff", units="in", width=20, height=18, res=200)
out_NR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/24)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('NR') +
        xlab(NULL) + ylab(NULL) +
        scale_x_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','Proliferating B cells','PD1+ B cells',
            'Neutrophils','Plasma cells')) +
        scale_y_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','Proliferating B cells','PD1+ B cells',
            'Neutrophils','Plasma cells'))
dev.off()

# TCMR
unique(sce_adult_labelled$Subcluster)
sce_adult_labelled_TCMR = sce_adult_labelled[,sce_adult_labelled$group=='TCMR']

out_TCMR_subcluster = testInteractions(sce_adult_labelled_TCMR, 
                        group_by = "sample_id",
                        label = "Subcluster", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_TCMR_subcluster)

write_csv(as.data.frame(out_TCMR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/58)), # Divided by number of ROIs
    "TCMR_classic_subcluster_interactions_knn.csv")

tiff("Subcluster knn Interactions TCMR.tiff", units="in", width=20, height=18, res=200)
out_TCMR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/58)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('TCMR') +
        xlab(NULL) + ylab(NULL) +
        scale_x_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','Proliferating B cells','PD1+ B cells',
            'Neutrophils','Plasma cells')) +
        scale_y_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','Proliferating B cells','PD1+ B cells',
            'Neutrophils','Plasma cells'))
dev.off()

# CR
unique(sce_adult_labelled$Subcluster)
sce_adult_labelled_CR = sce_adult_labelled[,sce_adult_labelled$group=='CR']

out_CR_subcluster = testInteractions(sce_adult_labelled_CR, 
                        group_by = "sample_id",
                        label = "Subcluster", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_CR_subcluster)

write_csv(as.data.frame(out_CR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/14)), # Divided by number of ROIs
    "CR_classic_subcluster_interactions_knn.csv")

tiff("Subcluster knn Interactions CR.tiff", units="in", width=20, height=18, res=200)
out_CR_subcluster %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/14)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('CR') +
        xlab(NULL) + ylab(NULL) +
        scale_x_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','PD1+ B cells',
            'Neutrophils','Plasma cells')) +
        scale_y_discrete(limits = c('Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes',
            'Endothelial cells','Proliferating Endothelial cells','HLADR+ Endothelial cells',
            'Cholangiocytes','Proliferating Cholangiocytes','HLADR+ Cholangiocytes',
            'Resident memory CD4+ T-cells','CD3+ CD4+ T-cells','Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'Naive CD4+ T-cells','HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs',
            'PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'CD3+ CD8+ T-cells','Proliferating CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'B cells','PD1+ B cells',
            'Neutrophils','Plasma cells'))
dev.off()
```

Neighborhood analysis - PD1+ Population and Macrophages

```{r}
###################################
###### NEIGHBORHOOD ANALYSIS ######
# PD1+ Population and Macrophages #
###################################

head(labelled_data)
labelled_data = labelled_data %>% 
  mutate(Macro_Type = case_when(Subcluster %in% c('M1 macrophages','Proliferating M1 macrophages',
                                                  'CD11b+ M1 macrophages (M3)',
                                                  'CD16+ M1 macrophages (M5)') ~ 'M1 Macrophages',
                                Subcluster %in% c('M2 macrophages','Proliferating M2 macrophages',
                                                  'CD11b+ M2 macrophages (M4)',
                                                  'CD16+ M2 macrophages (M6)',
                                                  'HLADR+ M2 macrophages (M7)') ~ 'M2 Macrophages'))
head(labelled_data)
sce_adult_labelled$Macrophage_Type = labelled_data$Macro_Type

temp_sce = sce_adult_labelled[,sce_adult_labelled$Subcluster %in% 
                                                     c('PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
                                                       'PD1+ CD4+ T-cells','PD1+ B cells',
                                                       'M1 macrophages','M2 macrophages',
                                                       'Proliferating M1 macrophages','Proliferating M2 macrophages',
                                                       'CD11b+ M1 macrophages (M3)','CD11b+ M2 macrophages (M4)',
                                                       'CD16+ M1 macrophages (M5)','CD16+ M2 macrophages (M6)',
                                                       'HLADR+ M2 macrophages (M7)')]

colData(temp_sce)

temp_sce[,temp_sce$Subcluster %in% c('PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
                                     'PD1+ CD4+ T-cells','PD1+ B cells')]$Macrophage_Type = temp_sce[,temp_sce$Subcluster %in% c('PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells','PD1+ CD4+ T-cells','PD1+ B cells')]$Subcluster

colData(temp_sce)

# NR
temp_sce_NR = temp_sce[,temp_sce$group=='NR']
unique(temp_sce_NR$sample_id)

out_NR_temp = testInteractions(temp_sce_NR, 
                        group_by = "sample_id",
                        label = "Macrophage_Type", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph", # "expansion_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_NR_temp)

out_NR_temp %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/24)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('NR') +
        xlab(NULL) + ylab(NULL)

# TCMR
temp_sce_TCMR = temp_sce[,temp_sce$group=='TCMR']
unique(temp_sce_TCMR$sample_id)

out_TCMR_temp = testInteractions(temp_sce_TCMR, 
                        group_by = "sample_id",
                        label = "Macrophage_Type", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_TCMR_temp)

out_TCMR_temp %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/58)  %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('TCMR') +
        xlab(NULL) + ylab(NULL)

# CR
temp_sce_CR = temp_sce[,temp_sce$group=='CR']
unique(temp_sce_CR$sample_id)

out_CR_temp = testInteractions(temp_sce_CR, 
                        group_by = "sample_id",
                        label = "Macrophage_Type", 
                        method = 'classic',
                        colPairName = "knn_interaction_graph",
                        BPPARAM = SerialParam(RNGseed = 221029))

head(out_CR_temp)

out_CR_temp %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    dplyr::summarize(sum_sigval = (sum(sigval, na.rm = TRUE))/14)   %>% # Divided by number of ROIs
    dplyr::mutate(Direction = case_when(sum_sigval>0 ~ 'Attraction',
                                        sum_sigval<0 ~ 'Avoidance',
                                        sum_sigval==0 ~ 'None')) %>%
    ggplot(aes(from_label, to_label)) +
        geom_tile(colour= "black", fill= "white", size = 0.1 ) +
        geom_point(aes(color = Direction, size = abs(sum_sigval))) +
        scale_color_manual(values=c(muted("red"),'blue','gray')) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              axis.text = element_text(size=20),
              axis.ticks = element_blank(),
              plot.title = element_text(size=30, hjust=0.5),
              legend.title=element_blank(),
              legend.text=element_text(size=20)) + 
        guides(color = guide_legend(override.aes = list(size = 6))) +
        ggtitle('CR') +
        xlab(NULL) + ylab(NULL)
```

PLOT NEIGHBORHOOD INTERACTION AS CORRELATION PLOT

```{r}
#############################
# CORRELATION NETWORK PLOTS #
#############################

head(labelled_data)
exprs_median = labelled_data %>% group_by(Subcluster) %>% 
dplyr::summarise(median(CD66b),median(CD20),median(CD28),median(CD16),median(CD163),median(CD11b),median(CD45),
                 median(CD4),median(CD31),median(CD279),median(CD68),median(Foxp3),median(CK7),median(Ki67),
                 median(CD8),median(CD3),median(CD138),median(HLADR),median(GranzymeB))
head(exprs_median)

library(Rtsne)
library(caret)
X_all = exprs_median[,c(-1)]
set.seed(202305) 
tsne = Rtsne((X_all), dims = 2, verbose=TRUE, check_duplicates = F, perplexity = 5)
tsne_plot <- data.frame(x = tsne$Y[,1], y = tsne$Y[,2])
ggplot(tsne_plot) + geom_point(aes(x=x, y=y))  + theme_classic()
```

```{r}
#############################
# CORRELATION NETWORK PLOTS #
####### NO REJECTION ########
#############################

graph_data_nr = read_csv('NR_classic_subcluster_interactions_knn_forNetwork.csv')

head(graph_data_nr)

graph_data_nr = graph_data_nr %>% filter(!from_label == to_label)

graph_data_nr$sum_sigval
graph_data_nr[(graph_data_nr$sum_sigval>-0.2)&(graph_data_nr$sum_sigval<0.2),]$sum_sigval = 0.1
graph_data_nr$sum_sigval

network_nr = graph_from_data_frame(graph_data_nr, directed=FALSE)

# Add median number of cells per patient (for node size)
vlabel_nr=V(network_nr)$name
vlabel_nr[vlabel_nr == "Activated monocytes"] = 2
vlabel_nr[vlabel_nr == "Intermediate monocytes"] = 2
vlabel_nr[vlabel_nr == "Non-classical monocytes"] = 2
vlabel_nr[vlabel_nr == "Classical monocytes"] = 12
vlabel_nr[vlabel_nr == "B cells"] = 4
vlabel_nr[vlabel_nr == "Proliferating B cells"] = 2
vlabel_nr[vlabel_nr == "PD1+ B cells"] = 1
vlabel_nr[vlabel_nr == "CD3+ CD4+ T-cells"] = 13
vlabel_nr[vlabel_nr == "Activated CD4+ T-cells"] = 6
vlabel_nr[vlabel_nr == "CD16+ CD4+ T-cells"] = 12
vlabel_nr[vlabel_nr == "HLADR- CD4+ Tregs"] = 1
vlabel_nr[vlabel_nr == "HLADR+ CD4+ Tregs"] = 1
vlabel_nr[vlabel_nr == "Naive CD4+ T-cells"] = 2
vlabel_nr[vlabel_nr == "PD1+ CD4+ T-cells"] = 1
vlabel_nr[vlabel_nr == "Proliferating CD4+ T-cells"] = 1
vlabel_nr[vlabel_nr == "Resident memory CD4+ T-cells"] = 211
vlabel_nr[vlabel_nr == "CD3+ CD8+ T-cells"] = 71
vlabel_nr[vlabel_nr == "Cytotoxic T-cells"] = 1
vlabel_nr[vlabel_nr == "PD1+ CD8+ T-cells"] = 1
vlabel_nr[vlabel_nr == "PD1+CD28+ CD8+ T-cells"] = 4
vlabel_nr[vlabel_nr == "Proliferating CD8+ T-cells"] = 3
vlabel_nr[vlabel_nr == "M1 macrophages"] = 143
vlabel_nr[vlabel_nr == "M2 macrophages"] = 68
vlabel_nr[vlabel_nr == "Proliferating M1 macrophages"] = 2
vlabel_nr[vlabel_nr == "Proliferating M2 macrophages"] = 2
vlabel_nr[vlabel_nr == "CD11b+ M1 macrophages"] = 2
vlabel_nr[vlabel_nr == "CD11b+ M2 macrophages"] = 2
vlabel_nr[vlabel_nr == "CD16+ M1 macrophages"] = 14
vlabel_nr[vlabel_nr == "CD16+ M2 macrophages"] = 121
vlabel_nr[vlabel_nr == "HLADR+ M2 macrophages"] = 9
vlabel_nr[vlabel_nr == "Hepatocytes"] = 3464
vlabel_nr[vlabel_nr == "Proliferating Hepatocytes"] = 9
vlabel_nr[vlabel_nr == "HLADR+ Hepatocytes"] = 95
vlabel_nr[vlabel_nr == "Endothelial cells"] = 92
vlabel_nr[vlabel_nr == "Proliferating Endothelial cells"] = 1
vlabel_nr[vlabel_nr == "HLADR+ Endothelial cells"] = 14
vlabel_nr[vlabel_nr == "Cholangiocytes"] = 57
vlabel_nr[vlabel_nr == "Proliferating Cholangiocytes"] = 4
vlabel_nr[vlabel_nr == "HLADR+ Cholangiocytes"] = 3
vlabel_nr[vlabel_nr == "Neutrophils"] = 96
vlabel_nr[vlabel_nr == "Plasma cells"] = 72

V(network_nr)$Cells = as.numeric(vlabel_nr)

# Add type of interaction (edge color)
ecol_nr=E(network_nr)$sum_sigval
ecol_nr[ecol_nr > 0.1] = 'red'
ecol_nr[ecol_nr < 0.1] = 'blue'
ecol_nr[ecol_nr == 0.1] = 'transparent'

# Add meta-cluster grouping colors
vgroup_nr=V(network_nr)$name
vgroup_nr[vgroup_nr %in% c("Activated monocytes","Intermediate monocytes","Non-classical monocytes",
                     "Classical monocytes")] = "green"
vgroup_nr[vgroup_nr %in% c("B cells","Proliferating B cells","PD1+ B cells")] = "#bf812d"
vgroup_nr[vgroup_nr %in% c("Activated CD4+ T-cells","CD3+ CD4+ T-cells","CD16+ CD4+ T-cells","HLADR- CD4+ Tregs",
                           "HLADR+ CD4+ Tregs","Naive CD4+ T-cells","PD1+ CD4+ T-cells",
                           "Proliferating CD4+ T-cells","Resident memory CD4+ T-cells")] = "#FFEA00"
vgroup_nr[vgroup_nr %in% c("CD3+ CD8+ T-cells","Cytotoxic T-cells","PD1+ CD8+ T-cells","PD1+CD28+ CD8+ T-cells",
                           "Proliferating CD8+ T-cells")] = "orange"
vgroup_nr[vgroup_nr %in% c("CD16+ M1 macrophages","CD16+ M2 macrophages","HLADR+ M2 macrophages","M1 macrophages",
                     "M2 macrophages","Proliferating M1 macrophages","Proliferating M2 macrophages",
                     "CD11b+ M1 macrophages","CD11b+ M2 macrophages")] = "#0096FF"
vgroup_nr[vgroup_nr %in% c("Hepatocytes","Proliferating Hepatocytes","HLADR+ Hepatocytes")] = "lightblue"
vgroup_nr[vgroup_nr %in% c("Endothelial cells","Proliferating Endothelial cells","HLADR+ Endothelial cells")] = "#5e63ca"
vgroup_nr[vgroup_nr %in% c("Cholangiocytes","Proliferating Cholangiocytes","HLADR+ Cholangiocytes")] = "#C04000"
vgroup_nr[vgroup_nr %in% c("Neutrophils")] = "#ae017e"
vgroup_nr[vgroup_nr %in% c("Plasma cells")] = "#CCCCFF"

V(network_nr)$Group = vgroup_nr

# Add labels as numbers
vlabelnames_nr=V(network_nr)$name
vlabelnames_nr[vlabelnames_nr == "Activated monocytes"] = '33'
vlabelnames_nr[vlabelnames_nr == "Intermediate monocytes"] = '32'
vlabelnames_nr[vlabelnames_nr == "Classical monocytes"] = '30'
vlabelnames_nr[vlabelnames_nr == "Non-classical monocytes"] = '31'
vlabelnames_nr[vlabelnames_nr == "B cells"] = '4'
vlabelnames_nr[vlabelnames_nr == "Proliferating B cells"] = '5'
vlabelnames_nr[vlabelnames_nr == "PD1+ B cells"] = '6'
vlabelnames_nr[vlabelnames_nr == "CD3+ CD4+ T-cells"] = '7'
vlabelnames_nr[vlabelnames_nr == "Activated CD4+ T-cells"] = '14'
vlabelnames_nr[vlabelnames_nr == "CD16+ CD4+ T-cells"] = '15'
vlabelnames_nr[vlabelnames_nr == "HLADR- CD4+ Tregs"] = '11'
vlabelnames_nr[vlabelnames_nr == "HLADR+ CD4+ Tregs"] = '10'
vlabelnames_nr[vlabelnames_nr == "Naive CD4+ T-cells"] = '9'
vlabelnames_nr[vlabelnames_nr == "PD1+ CD4+ T-cells"] = '12'
vlabelnames_nr[vlabelnames_nr == "Proliferating CD4+ T-cells"] = '13'
vlabelnames_nr[vlabelnames_nr == "Resident memory CD4+ T-cells"] = '8'
vlabelnames_nr[vlabelnames_nr == "CD3+ CD8+ T-cells"] = '16'
vlabelnames_nr[vlabelnames_nr == "Cytotoxic T-cells"] = '17'
vlabelnames_nr[vlabelnames_nr == "PD1+ CD8+ T-cells"] = '19'
vlabelnames_nr[vlabelnames_nr == "PD1+CD28+ CD8+ T-cells"] = '20'
vlabelnames_nr[vlabelnames_nr == "Proliferating CD8+ T-cells"] = '18'
vlabelnames_nr[vlabelnames_nr == "M1 macrophages"] = '21'
vlabelnames_nr[vlabelnames_nr == "M2 macrophages"] = '22'
vlabelnames_nr[vlabelnames_nr == "Proliferating M1 macrophages"] = '23'
vlabelnames_nr[vlabelnames_nr == "Proliferating M2 macrophages"] = '24'
vlabelnames_nr[vlabelnames_nr == "CD11b+ M1 macrophages"] = '25'
vlabelnames_nr[vlabelnames_nr == "CD11b+ M2 macrophages"] = '26'
vlabelnames_nr[vlabelnames_nr == "CD16+ M1 macrophages"] = '27'
vlabelnames_nr[vlabelnames_nr == "CD16+ M2 macrophages"] = '28'
vlabelnames_nr[vlabelnames_nr == "HLADR+ M2 macrophages"] = '29'
vlabelnames_nr[vlabelnames_nr == "Hepatocytes"] = '3'
vlabelnames_nr[vlabelnames_nr == "Proliferating Hepatocytes"] = '36'
vlabelnames_nr[vlabelnames_nr == "HLADR+ Hepatocytes"] = '37'
vlabelnames_nr[vlabelnames_nr == "Endothelial cells"] = '2'
vlabelnames_nr[vlabelnames_nr == "Proliferating Endothelial cells"] = '38'
vlabelnames_nr[vlabelnames_nr == "HLADR+ Endothelial cells"] = '39'
vlabelnames_nr[vlabelnames_nr == "Cholangiocytes"] = '1'
vlabelnames_nr[vlabelnames_nr == "Proliferating Cholangiocytes"] = '40'
vlabelnames_nr[vlabelnames_nr == "HLADR+ Cholangiocytes"] = '41'
vlabelnames_nr[vlabelnames_nr == "Neutrophils"] = '34'
vlabelnames_nr[vlabelnames_nr == "Plasma cells"] = '35'

V(network_nr)$Labels = as.numeric(vlabelnames_nr)

plot(network_nr, 
    vertex.size = log(as.numeric(V(network_nr)$Cells)*1000),
    vertex.label = V(network_nr)$Labels,
    vertex.label.cex=1,
    vertex.color = V(network_nr)$Group,
    edge.color = ecol_nr,
    vertex.label.color="black",
    vertex.frame.color="black", 
    edge.width = 2 * abs(unlist(edge_attr(network_nr))),
    layout = as.matrix(tsne_plot), legend = T
    ) 
legend('bottomleft',legend=c(3,100,3500),pt.cex=c(2,3.5,5),col='black',bty='n',cex=1,
            pch=21, pt.bg='white', title='',horiz=F, y.intersp=0.9, x.intersp=1)
legend('topleft',
       legend = c('Attraction','Avoidance'),
       fill = colorRampPalette(colors = c("pink","black"))(2),
       border = NA,bty='n',cex=1.5,y.intersp = 0.5,x.intersp=0.5)
```

```{r}
#############################
# CORRELATION NETWORK PLOTS #
########### TCMR ############
#############################

graph_data_tcmr = read_csv('TCMR_classic_subcluster_interactions_knn_forNetwork.csv')
head(graph_data_tcmr)

graph_data_tcmr = graph_data_tcmr %>% filter(!from_label == to_label)

graph_data_tcmr$sum_sigval
graph_data_tcmr[(graph_data_tcmr$sum_sigval>-0.2)&(graph_data_tcmr$sum_sigval<0.2),]$sum_sigval = 0.1
graph_data_tcmr$sum_sigval

network_tcmr = graph_from_data_frame(graph_data_tcmr, directed=FALSE)

# Add median number of cells per patient (for node size)
vlabel_tcmr=V(network_tcmr)$name
vlabel_tcmr[vlabel_tcmr == "Activated monocytes"] = 9
vlabel_tcmr[vlabel_tcmr == "Intermediate monocytes"] = 2
vlabel_tcmr[vlabel_tcmr == "Non-classical monocytes"] = 2
vlabel_tcmr[vlabel_tcmr == "Classical monocytes"] = 41
vlabel_tcmr[vlabel_tcmr == "B cells"] = 28
vlabel_tcmr[vlabel_tcmr == "Proliferating B cells"] = 3
vlabel_tcmr[vlabel_tcmr == "PD1+ B cells"] = 8
vlabel_tcmr[vlabel_tcmr == "CD3+ CD4+ T-cells"] = 62
vlabel_tcmr[vlabel_tcmr == "Activated CD4+ T-cells"] = 24
vlabel_tcmr[vlabel_tcmr == "CD16+ CD4+ T-cells"] = 11
vlabel_tcmr[vlabel_tcmr == "HLADR- CD4+ Tregs"] = 3
vlabel_tcmr[vlabel_tcmr == "HLADR+ CD4+ Tregs"] = 9
vlabel_tcmr[vlabel_tcmr == "Naive CD4+ T-cells"] = 6
vlabel_tcmr[vlabel_tcmr == "PD1+ CD4+ T-cells"] = 7
vlabel_tcmr[vlabel_tcmr == "Proliferating CD4+ T-cells"] = 3
vlabel_tcmr[vlabel_tcmr == "Resident memory CD4+ T-cells"] = 36
vlabel_tcmr[vlabel_tcmr == "CD3+ CD8+ T-cells"] = 296
vlabel_tcmr[vlabel_tcmr == "Cytotoxic T-cells"] = 4
vlabel_tcmr[vlabel_tcmr == "PD1+ CD8+ T-cells"] = 31
vlabel_tcmr[vlabel_tcmr == "PD1+CD28+ CD8+ T-cells"] = 10
vlabel_tcmr[vlabel_tcmr == "Proliferating CD8+ T-cells"] = 25
vlabel_tcmr[vlabel_tcmr == "M1 macrophages"] = 196
vlabel_tcmr[vlabel_tcmr == "M2 macrophages"] = 80
vlabel_tcmr[vlabel_tcmr == "Proliferating M1 macrophages"] = 6
vlabel_tcmr[vlabel_tcmr == "Proliferating M2 macrophages"] = 6
vlabel_tcmr[vlabel_tcmr == "CD11b+ M1 macrophages"] = 4
vlabel_tcmr[vlabel_tcmr == "CD11b+ M2 macrophages"] = 2
vlabel_tcmr[vlabel_tcmr == "CD16+ M1 macrophages"] = 11
vlabel_tcmr[vlabel_tcmr == "CD16+ M2 macrophages"] = 58
vlabel_tcmr[vlabel_tcmr == "HLADR+ M2 macrophages"] = 23
vlabel_tcmr[vlabel_tcmr == "Hepatocytes"] = 2817
vlabel_tcmr[vlabel_tcmr == "Proliferating Hepatocytes"] = 27
vlabel_tcmr[vlabel_tcmr == "HLADR+ Hepatocytes"] = 289
vlabel_tcmr[vlabel_tcmr == "Endothelial cells"] = 123
vlabel_tcmr[vlabel_tcmr == "Proliferating Endothelial cells"] = 3
vlabel_tcmr[vlabel_tcmr == "HLADR+ Endothelial cells"] = 24
vlabel_tcmr[vlabel_tcmr == "Cholangiocytes"] = 64
vlabel_tcmr[vlabel_tcmr == "Proliferating Cholangiocytes"] = 4
vlabel_tcmr[vlabel_tcmr == "HLADR+ Cholangiocytes"] = 10
vlabel_tcmr[vlabel_tcmr == "Neutrophils"] = 247
vlabel_tcmr[vlabel_tcmr == "Plasma cells"] = 54

V(network_tcmr)$Cells = as.numeric(vlabel_tcmr)

# Add type of interaction (edge color)
ecol_tcmr=E(network_tcmr)$sum_sigval
ecol_tcmr[ecol_tcmr > 0.1] = 'red'
ecol_tcmr[ecol_tcmr < 0.1] = 'blue'
ecol_tcmr[ecol_tcmr == 0.1] = 'transparent'

# Add meta-cluster grouping colors
vgroup_tcmr=V(network_tcmr)$name
vgroup_tcmr[vgroup_tcmr %in% c("Activated monocytes","Intermediate monocytes","Non-classical monocytes",
                     "Classical monocytes")] = "green"
vgroup_tcmr[vgroup_tcmr %in% c("B cells","Proliferating B cells","PD1+ B cells")] = "#bf812d"
vgroup_tcmr[vgroup_tcmr %in% c("Activated CD4+ T-cells","CD3+ CD4+ T-cells","CD16+ CD4+ T-cells","HLADR- CD4+ Tregs",
                           "HLADR+ CD4+ Tregs","Naive CD4+ T-cells","PD1+ CD4+ T-cells",
                           "Proliferating CD4+ T-cells","Resident memory CD4+ T-cells")] = "#FFEA00"
vgroup_tcmr[vgroup_tcmr %in% c("CD3+ CD8+ T-cells","Cytotoxic T-cells","PD1+ CD8+ T-cells","PD1+CD28+ CD8+ T-cells",
                           "Proliferating CD8+ T-cells")] = "orange"
vgroup_tcmr[vgroup_tcmr %in% c("CD16+ M1 macrophages","CD16+ M2 macrophages","HLADR+ M2 macrophages","M1 macrophages",
                     "M2 macrophages","Proliferating M1 macrophages","Proliferating M2 macrophages",
                     "CD11b+ M1 macrophages","CD11b+ M2 macrophages")] = "#0096FF"
vgroup_tcmr[vgroup_tcmr %in% c("Hepatocytes","Proliferating Hepatocytes","HLADR+ Hepatocytes")] = "lightblue"
vgroup_tcmr[vgroup_tcmr %in% c("Endothelial cells","Proliferating Endothelial cells","HLADR+ Endothelial cells")] = "#5e63ca"
vgroup_tcmr[vgroup_tcmr %in% c("Cholangiocytes","Proliferating Cholangiocytes","HLADR+ Cholangiocytes")] = "#C04000"
vgroup_tcmr[vgroup_tcmr %in% c("Neutrophils")] = "#ae017e"
vgroup_tcmr[vgroup_tcmr %in% c("Plasma cells")] = "#CCCCFF"

V(network_tcmr)$Group = vgroup_tcmr

# Add labels as numbers
vlabelnames_tcmr=V(network_tcmr)$name
vlabelnames_tcmr[vlabelnames_tcmr == "Activated monocytes"] = '33'
vlabelnames_tcmr[vlabelnames_tcmr == "Intermediate monocytes"] = '32'
vlabelnames_tcmr[vlabelnames_tcmr == "Classical monocytes"] = '30'
vlabelnames_tcmr[vlabelnames_tcmr == "Non-classical monocytes"] = '31'
vlabelnames_tcmr[vlabelnames_tcmr == "B cells"] = '4'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating B cells"] = '5'
vlabelnames_tcmr[vlabelnames_tcmr == "PD1+ B cells"] = '6'
vlabelnames_tcmr[vlabelnames_tcmr == "CD3+ CD4+ T-cells"] = '7'
vlabelnames_tcmr[vlabelnames_tcmr == "Activated CD4+ T-cells"] = '14'
vlabelnames_tcmr[vlabelnames_tcmr == "CD16+ CD4+ T-cells"] = '15'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR- CD4+ Tregs"] = '11'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR+ CD4+ Tregs"] = '10'
vlabelnames_tcmr[vlabelnames_tcmr == "Naive CD4+ T-cells"] = '9'
vlabelnames_tcmr[vlabelnames_tcmr == "PD1+ CD4+ T-cells"] = '12'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating CD4+ T-cells"] = '13'
vlabelnames_tcmr[vlabelnames_tcmr == "Resident memory CD4+ T-cells"] = '8'
vlabelnames_tcmr[vlabelnames_tcmr == "CD3+ CD8+ T-cells"] = '16'
vlabelnames_tcmr[vlabelnames_tcmr == "Cytotoxic T-cells"] = '17'
vlabelnames_tcmr[vlabelnames_tcmr == "PD1+ CD8+ T-cells"] = '19'
vlabelnames_tcmr[vlabelnames_tcmr == "PD1+CD28+ CD8+ T-cells"] = '20'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating CD8+ T-cells"] = '18'
vlabelnames_tcmr[vlabelnames_tcmr == "M1 macrophages"] = '21'
vlabelnames_tcmr[vlabelnames_tcmr == "M2 macrophages"] = '22'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating M1 macrophages"] = '23'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating M2 macrophages"] = '24'
vlabelnames_tcmr[vlabelnames_tcmr == "CD11b+ M1 macrophages"] = '25'
vlabelnames_tcmr[vlabelnames_tcmr == "CD11b+ M2 macrophages"] = '26'
vlabelnames_tcmr[vlabelnames_tcmr == "CD16+ M1 macrophages"] = '27'
vlabelnames_tcmr[vlabelnames_tcmr == "CD16+ M2 macrophages"] = '28'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR+ M2 macrophages"] = '29'
vlabelnames_tcmr[vlabelnames_tcmr == "Hepatocytes"] = '3'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating Hepatocytes"] = '36'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR+ Hepatocytes"] = '37'
vlabelnames_tcmr[vlabelnames_tcmr == "Endothelial cells"] = '2'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating Endothelial cells"] = '38'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR+ Endothelial cells"] = '39'
vlabelnames_tcmr[vlabelnames_tcmr == "Cholangiocytes"] = '1'
vlabelnames_tcmr[vlabelnames_tcmr == "Proliferating Cholangiocytes"] = '40'
vlabelnames_tcmr[vlabelnames_tcmr == "HLADR+ Cholangiocytes"] = '41'
vlabelnames_tcmr[vlabelnames_tcmr == "Neutrophils"] = '34'
vlabelnames_tcmr[vlabelnames_tcmr == "Plasma cells"] = '35'

V(network_tcmr)$Labels = as.numeric(vlabelnames_tcmr)

plot(network_tcmr, 
    vertex.size = log(as.numeric(V(network_tcmr)$Cells)*1000),
    vertex.label = V(network_tcmr)$Labels,
    vertex.label.cex=1,
    vertex.color = V(network_tcmr)$Group,
    edge.color = ecol_acr,
    vertex.label.color="black",
    vertex.frame.color="black", 
    edge.width = 2 * abs(unlist(edge_attr(network_tcmr))),
    layout = as.matrix(tsne_plot), legend = T
    ) 
legend('bottomleft',legend=c(3,100,3500),pt.cex=c(2,3.5,5),col='black',bty='n',cex=1,
            pch=21, pt.bg='white', title='',horiz=F, y.intersp=0.9, x.intersp=1)
legend('topleft',
       legend = c('Attraction','Avoidance'),
       fill = colorRampPalette(colors = c("red","blue"))(2),
       border = NA,bty='n',cex=1.5,y.intersp = 0.5,x.intersp=0.5)
```

```{r}
#############################
# CORRELATION NETWORK PLOTS #
############ CR #############
#############################

graph_data_cr = read_csv('CR_classic_subcluster_interactions_knn_forNetwork.csv')
head(graph_data_cr)

graph_data_cr = graph_data_cr %>% filter(!from_label == to_label)

graph_data_cr$sum_sigval
graph_data_cr[(graph_data_cr$sum_sigval>-0.2)&(graph_data_cr$sum_sigval<0.2),]$sum_sigval = 0.1
graph_data_cr$sum_sigval

network_cr = graph_from_data_frame(graph_data_cr, directed=FALSE)

# Add median number of cells per patient (for node size)
vlabel_cr=V(network_cr)$name
vlabel_cr[vlabel_cr == "Activated monocytes"] = 14
vlabel_cr[vlabel_cr == "Intermediate monocytes"] = 2
vlabel_cr[vlabel_cr == "Non-classical monocytes"] = 6
vlabel_cr[vlabel_cr == "Classical monocytes"] = 81
vlabel_cr[vlabel_cr == "B cells"] = 2
vlabel_cr[vlabel_cr == "Proliferating B cells"] = 0.001
vlabel_cr[vlabel_cr == "PD1+ B cells"] = 1
vlabel_cr[vlabel_cr == "CD3+ CD4+ T-cells"] = 81
vlabel_cr[vlabel_cr == "Activated CD4+ T-cells"] = 9
vlabel_cr[vlabel_cr == "CD16+ CD4+ T-cells"] = 4
vlabel_cr[vlabel_cr == "HLADR- CD4+ Tregs"] = 1
vlabel_cr[vlabel_cr == "HLADR+ CD4+ Tregs"] = 2
vlabel_cr[vlabel_cr == "Naive CD4+ T-cells"] = 8
vlabel_cr[vlabel_cr == "PD1+ CD4+ T-cells"] = 1
vlabel_cr[vlabel_cr == "Proliferating CD4+ T-cells"] = 2
vlabel_cr[vlabel_cr == "Resident memory CD4+ T-cells"] = 36
vlabel_cr[vlabel_cr == "CD3+ CD8+ T-cells"] = 309
vlabel_cr[vlabel_cr == "Cytotoxic T-cells"] = 4
vlabel_cr[vlabel_cr == "PD1+ CD8+ T-cells"] = 5
vlabel_cr[vlabel_cr == "PD1+CD28+ CD8+ T-cells"] = 5
vlabel_cr[vlabel_cr == "Proliferating CD8+ T-cells"] = 1
vlabel_cr[vlabel_cr == "M1 macrophages"] = 1213
vlabel_cr[vlabel_cr == "M2 macrophages"] = 133
vlabel_cr[vlabel_cr == "Proliferating M1 macrophages"] = 3
vlabel_cr[vlabel_cr == "Proliferating M2 macrophages"] = 1
vlabel_cr[vlabel_cr == "CD11b+ M1 macrophages"] = 4
vlabel_cr[vlabel_cr == "CD11b+ M2 macrophages"] = 3
vlabel_cr[vlabel_cr == "CD16+ M1 macrophages"] = 5
vlabel_cr[vlabel_cr == "CD16+ M2 macrophages"] = 60
vlabel_cr[vlabel_cr == "HLADR+ M2 macrophages"] = 62
vlabel_cr[vlabel_cr == "Hepatocytes"] = 3716
vlabel_cr[vlabel_cr == "Proliferating Hepatocytes"] = 4
vlabel_cr[vlabel_cr == "HLADR+ Hepatocytes"] = 425
vlabel_cr[vlabel_cr == "Endothelial cells"] = 213
vlabel_cr[vlabel_cr == "Proliferating Endothelial cells"] = 1
vlabel_cr[vlabel_cr == "HLADR+ Endothelial cells"] = 13
vlabel_cr[vlabel_cr == "Cholangiocytes"] = 42
vlabel_cr[vlabel_cr == "Proliferating Cholangiocytes"] = 1
vlabel_cr[vlabel_cr == "HLADR+ Cholangiocytes"] = 2
vlabel_cr[vlabel_cr == "Neutrophils"] = 397
vlabel_cr[vlabel_cr == "Plasma cells"] = 2

V(network_cr)$Cells = as.numeric(vlabel_cr)

# Add type of interaction (edge color)
ecol_cr=E(network_cr)$sum_sigval
ecol_cr[ecol_cr > 0.1] = 'red'
ecol_cr[ecol_cr < 0.1] = 'blue'
ecol_cr[ecol_cr == 1] = 'transparent'

# Add meta-cluster grouping colors
vgroup_cr=V(network_cr)$name
vgroup_cr[vgroup_cr %in% c("Activated monocytes","Intermediate monocytes","Non-classical monocytes",
                     "Classical monocytes")] = "green"
vgroup_cr[vgroup_cr %in% c("B cells","PD1+ B cells","Proliferating B cells")] = "#bf812d"
vgroup_cr[vgroup_cr %in% c("Activated CD4+ T-cells","CD3+ CD4+ T-cells","CD16+ CD4+ T-cells","HLADR- CD4+ Tregs",
                           "HLADR+ CD4+ Tregs","Naive CD4+ T-cells","PD1+ CD4+ T-cells",
                           "Proliferating CD4+ T-cells","Resident memory CD4+ T-cells")] = "#FFEA00"
vgroup_cr[vgroup_cr %in% c("CD3+ CD8+ T-cells","Cytotoxic T-cells","PD1+ CD8+ T-cells","PD1+CD28+ CD8+ T-cells",
                           "Proliferating CD8+ T-cells")] = "orange"
vgroup_cr[vgroup_cr %in% c("CD16+ M1 macrophages","CD16+ M2 macrophages","HLADR+ M2 macrophages","M1 macrophages",
                     "M2 macrophages","Proliferating M1 macrophages","Proliferating M2 macrophages",
                     "CD11b+ M1 macrophages","CD11b+ M2 macrophages")] = "#0096FF"
vgroup_cr[vgroup_cr %in% c("Hepatocytes","Proliferating Hepatocytes","HLADR+ Hepatocytes")] = "lightblue"
vgroup_cr[vgroup_cr %in% c("Endothelial cells","Proliferating Endothelial cells","HLADR+ Endothelial cells")] = "#5e63ca"
vgroup_cr[vgroup_cr %in% c("Cholangiocytes","Proliferating Cholangiocytes","HLADR+ Cholangiocytes")] = "#C04000"
vgroup_cr[vgroup_cr %in% c("Neutrophils")] = "#ae017e"
vgroup_cr[vgroup_cr %in% c("Plasma cells")] = "#CCCCFF"

V(network_cr)$Group = vgroup_cr

# Add labels as numbers
vlabelnames_cr=V(network_cr)$name
vlabelnames_cr[vlabelnames_cr == "Activated monocytes"] = '33'
vlabelnames_cr[vlabelnames_cr == "Intermediate monocytes"] = '32'
vlabelnames_cr[vlabelnames_cr == "Classical monocytes"] = '30'
vlabelnames_cr[vlabelnames_cr == "Non-classical monocytes"] = '31'
vlabelnames_cr[vlabelnames_cr == "B cells"] = '4'
vlabelnames_cr[vlabelnames_cr == "Proliferating B cells"] = '5'
vlabelnames_cr[vlabelnames_cr == "PD1+ B cells"] = '6'
vlabelnames_cr[vlabelnames_cr == "CD3+ CD4+ T-cells"] = '7'
vlabelnames_cr[vlabelnames_cr == "Activated CD4+ T-cells"] = '14'
vlabelnames_cr[vlabelnames_cr == "CD16+ CD4+ T-cells"] = '15'
vlabelnames_cr[vlabelnames_cr == "HLADR- CD4+ Tregs"] = '11'
vlabelnames_cr[vlabelnames_cr == "HLADR+ CD4+ Tregs"] = '10'
vlabelnames_cr[vlabelnames_cr == "Naive CD4+ T-cells"] = '9'
vlabelnames_cr[vlabelnames_cr == "PD1+ CD4+ T-cells"] = '12'
vlabelnames_cr[vlabelnames_cr == "Proliferating CD4+ T-cells"] = '13'
vlabelnames_cr[vlabelnames_cr == "Resident memory CD4+ T-cells"] = '8'
vlabelnames_cr[vlabelnames_cr == "CD3+ CD8+ T-cells"] = '16'
vlabelnames_cr[vlabelnames_cr == "Cytotoxic T-cells"] = '17'
vlabelnames_cr[vlabelnames_cr == "PD1+ CD8+ T-cells"] = '19'
vlabelnames_cr[vlabelnames_cr == "PD1+CD28+ CD8+ T-cells"] = '20'
vlabelnames_cr[vlabelnames_cr == "Proliferating CD8+ T-cells"] = '18'
vlabelnames_cr[vlabelnames_cr == "M1 macrophages"] = '21'
vlabelnames_cr[vlabelnames_cr == "M2 macrophages"] = '22'
vlabelnames_cr[vlabelnames_cr == "Proliferating M1 macrophages"] = '23'
vlabelnames_cr[vlabelnames_cr == "Proliferating M2 macrophages"] = '24'
vlabelnames_cr[vlabelnames_cr == "CD11b+ M1 macrophages"] = '25'
vlabelnames_cr[vlabelnames_cr == "CD11b+ M2 macrophages"] = '26'
vlabelnames_cr[vlabelnames_cr == "CD16+ M1 macrophages"] = '27'
vlabelnames_cr[vlabelnames_cr == "CD16+ M2 macrophages"] = '28'
vlabelnames_cr[vlabelnames_cr == "HLADR+ M2 macrophages"] = '29'
vlabelnames_cr[vlabelnames_cr == "Hepatocytes"] = '3'
vlabelnames_cr[vlabelnames_cr == "Proliferating Hepatocytes"] = '36'
vlabelnames_cr[vlabelnames_cr == "HLADR+ Hepatocytes"] = '37'
vlabelnames_cr[vlabelnames_cr == "Endothelial cells"] = '2'
vlabelnames_cr[vlabelnames_cr == "Proliferating Endothelial cells"] = '38'
vlabelnames_cr[vlabelnames_cr == "HLADR+ Endothelial cells"] = '39'
vlabelnames_cr[vlabelnames_cr == "Cholangiocytes"] = '1'
vlabelnames_cr[vlabelnames_cr == "Proliferating Cholangiocytes"] = '40'
vlabelnames_cr[vlabelnames_cr == "HLADR+ Cholangiocytes"] = '41'
vlabelnames_cr[vlabelnames_cr == "Neutrophils"] = '34'
vlabelnames_cr[vlabelnames_cr == "Plasma cells"] = '35'

V(network_cr)$Labels = as.numeric(vlabelnames_cr)

plot(network_cr, 
    vertex.size = log(as.numeric(V(network_cr)$Cells)*1000),
    vertex.label = V(network_cr)$Labels,
    vertex.label.cex=1,
    vertex.color = V(network_cr)$Group,
    edge.color = ecol_cr,
    vertex.label.color="black",
    vertex.frame.color="black", 
    edge.width = 2 * abs(unlist(edge_attr(network_cr))),
    layout = as.matrix(tsne_plot), legend = T
    ) 
legend('bottomleft',legend=c(3,100,3500),pt.cex=c(2,3.5,5),col='black',bty='n',cex=1,
            pch=21, pt.bg='white', title='',horiz=F, y.intersp=0.9, x.intersp=1)
legend('topleft',
       legend = c('Attraction','Avoidance'),
       fill = colorRampPalette(colors = c("red","blue"))(2),
       border = NA,bty='n',cex=1.5,y.intersp = 0.5,x.intersp=0.5)
```

Visualize spatial interactions on tissue, colored by cell type (metaclusters)
KNN interaction graph; k=10

```{r}
# NR
plotSpatial(sce_adult_labelled[,sce_adult_labelled$Patient == "SP17_9809"],
            img_id = "sample_id",
            node_color_by = "Clusters",
            node_size_fix = 1.5,
            edge_width_fix = 0.2,
            edge_color_fix = "gray",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_manual(values = c("#bf812d", "#FFEA00", "orange","green","#0096FF",
                       "#ae017e","#CCCCFF","#313695","#C04000","darkgray")) 
                       
# TCMR
plotSpatial(sce_adult_labelled[,sce_adult_labelled$Patient == "SP21_336"],
            img_id = "sample_id",
            node_color_by = "Clusters",
            node_size_fix = 1.5,
            edge_width_fix = 0.2,
            edge_color_fix = "gray",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_manual(values = c("#bf812d", "#FFEA00", "orange","green","#0096FF",
                       "#ae017e","#CCCCFF","#313695","#C04000","darkgray")) 
                       
# CR
plotSpatial(sce_adult_labelled[,sce_adult_labelled$Patient == "SP11_1305"],
            img_id = "sample_id",
            node_color_by = "Clusters",
            node_size_fix = 1.5,
            edge_width_fix = 0.2,
            edge_color_fix = "gray",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph", 
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_manual(values = c("#bf812d", "#FFEA00", "orange","green","#0096FF",
                       "#ae017e","#313695","darkgray")) 
```

Cellular Neighborhood Analysis

```{r}
##################################
# Cellular Neighborhood Analysis #
##################################

sce_adult_labelled = aggregateNeighbors(sce_adult_labelled,colPairName = "knn_interaction_graph", 
                          aggregate_by = "metadata", count_by = "Clusters")

set.seed(220705)
cn_1 = kmeans(sce_adult_labelled$aggregatedNeighbors, centers = 10) 
sce_adult_labelled$cn_celltypes = as.factor(cn_1$cluster)

# Heatmap
library(tidyverse)
for_plot <- colData(sce_adult_labelled) %>% as_tibble() %>%
    group_by(cn_celltypes, Subcluster) %>%
    dplyr::summarize(count = n()) %>%
    mutate(freq = count / sum(count)) %>%
    pivot_wider(id_cols = cn_celltypes, names_from = Subcluster, 
                values_from = freq, values_fill = 0) %>%
    ungroup() %>%
    dplyr::select(-cn_celltypes)

rownames(for_plot) = c(1,2,3,4,5,6,7,8,9,10)

pheatmap(as.matrix(for_plot),  color = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'), 
         scale = "column", annotation_names_row=T, fontsize_row=12, fontsize_col=12,
         legend_breaks=c(-1,0,1,2))

# Add CN names
sce_adult_labelled$CN = NA
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==1]$CN = 'Hepatocytes'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==2]$CN = 'Vasculature'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==3]$CN = 'Granulocytes enriched'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==4]$CN = 'Activated macrophages'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==5]$CN = 'CD8 enriched'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==6]$CN = 'CD16+ T-helper enriched'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==7]$CN = 'Hepatocytes'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==8]$CN = 'T-helper enriched'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==9]$CN = 'Bile duct'
sce_adult_labelled[,sce_adult_labelled$cn_celltypes==10]$CN = 'B-cell and monocytes enriched'

sce_adult_labelled$CN = factor(sce_adult_labelled$CN,
                               c('Hepatocytes','Vasculature','Granulocytes enriched','Activated macrophages',
                                 'CD8 enriched','CD16+ T-helper enriched','T-helper enriched',
                                 'B-cell and monocytes enriched','Bile duct'))

# Visualize heatmap
for_plot <- colData(sce_adult_labelled) %>% as_tibble() %>%
    group_by(CN, Subcluster) %>%
    dplyr::summarize(count = n()) %>%
    mutate(freq = count / sum(count)) %>%
    pivot_wider(id_cols = CN, names_from = Subcluster, 
                values_from = freq, values_fill = 0) %>%
    ungroup() %>%
    dplyr::select(-CN)

rownames(for_plot) = c('Hepatocytes','Vasculature','Granulocytes enriched','Activated macrophages',
                                 'CD8 enriched','CD16+ T-helper enriched','T-helper enriched',
                                 'B-cell and monocytes enriched','Bile duct')

for_plot = for_plot[,c('Cholangiocytes','Endothelial cells','Hepatocytes','B cells','Proliferating B cells',
                      'PD1+ B cells','CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','M2 macrophages','Proliferating M1 macrophages','Proliferating M2 macrophages',
            'CD11b+ M1 macrophages','CD11b+ M2 macrophages',
            'CD16+ M1 macrophages','CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells')]

for_plot <- scale(for_plot) 
m <- as.matrix(for_plot)

rownames(m) = c('Hepatocytes','Vasculature','Granulocytes enriched','Activated macrophages',
                                 'CD8 enriched','CD16+ T-helper enriched','T-helper enriched',
                                 'B-cell and monocytes enriched','Bile duct')

col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35),
                     c("white","white","white","white","white","white","white","white","white","white"
                      ,"white","white","white","white","white","white","white","white","white","white"
                      ,"white","white","white","white","white","white","white","white","white","white"
                      ,"white","white","white","white","white"))
ha_left = HeatmapAnnotation(Metaclusters = 1:35, col = list(Metaclusters = col_fun), annotation_name_rot=0, 
                            gp = gpar(col = "black"), which='col', show_legend = FALSE)

cn_clusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  bottom_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_height = unit(3,"cm"),
                                                              direction="vertical", title_gp = gpar(fontsize=12),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(8, "cm"),
                                  width = unit(25,"cm")
                      )

draw(cn_clusters, heatmap_legend_side = "bottom")

# NR
plotSpatial(sce_adult_labelled[,(sce_adult_labelled$Patient == "SP17_9809")], 
            node_color_by = "CN", 
            img_id = "sample_id", 
            node_size_fix = 1.5) +
    scale_color_brewer(palette = "Paired")

# TCMR
plotSpatial(sce_adult_labelled[,(sce_adult_labelled$Patient == "SP21_336")],
            node_color_by = "CN", 
            img_id = "sample_id",
            node_size_fix = 1.5) +
    scale_color_manual(values = c("#A6CEE3","#1F78B4","#33A02C","#FB9A99",
                                  "#E31A1C","#FDBF6F","#FF7F00","#CAB2D6"))

# CR
plotSpatial(sce_adult_labelled[,(sce_adult_labelled$Patient == "SP11_1305")], 
            node_color_by = "CN", 
            img_id = "sample_id", 
            node_size_fix = 1.5) +
    scale_color_manual(values = c("#A6CEE3","#1F78B4","#33A02C","#FB9A99",
                                  "#E31A1C","#FDBF6F","#FF7F00","#CAB2D6"))

labelled_data$CN = sce_adult_labelled$CN

# Stacked Barplot
order_of_stack_patients = c("SP17_1753","SP17_5427","SP17_7659","SP17_9809","SP18_13566","SP18_7378","SP19_10094",
                          "SP19_13104","SP19_1689","SP19_2277","SP19_7279","SP20_11706","SP20_11758","SP20_6053",
                          "SP20_6085","SP20_8599","SP21_2370","SP21_2563","SP21_6217","SP21_6323","SP21_8054",
                          "SP21_8904","SP21_9015","SP21_9021", # NR
                        
                          "SP_18_14559","SP16_1902","SP18_2369A1","SP18_3825A1","SP19_10445","SP19_12144","SP19_13300",
                          "SP19_13381A1","SP19_1715A1","SP19_1892","SP19_2006","SP19_8069","SP19_9797","SP20_2886",
                          "SP20_3128","SP20_3382A1","SP20_3601","SP20_3668","SP20_4548","SP20_6708","SP20_7546",
                          "SP20_7572","SP20_7880","SP20_928","SP21_1320","SP21_1610","SP21_1786","SP21_1931",
                          "SP21_2168","SP21_2461","SP21_2495","SP21_2603","SP21_2829","SP21_301","SP21_336",
                          "SP21_3546","SP21_3775","SP21_414_A1","SP21_6623","SP21_712","SP21_725", # TCMR
                        
                          "SP00_1543","SP01_3915","SP03_2432","SP04_5797","SP04_6177","SP08_8","SP09_259","SP11_1305",
                          "SP13_5321","SP13_5725","SP17_8628","SP18_13009","SP18_213","SP18_4465") # CR

stack_data_cn = labelled_data %>% group_by(Patient,CN,group) %>% dplyr::summarise(Count = n())
head(stack_data_cn)

ggplot(stack_data_cn, aes(fill=CN, y=Count, x=Patient, reverse=TRUE)) + 
    geom_bar(position = position_fill(reverse = FALSE), stat="identity") +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Proportion") +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=0.3,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5)) +
  scale_x_discrete(limits = order_of_stack_patients) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_brewer(palette = "Paired")

##########################
# STATISTICAL COMPARISON #
##########################

cells_per_Patient = labelled_data %>% subset(select=c('group','Patient')) %>% group_by(group,Patient) %>% 
  dplyr::summarise(n = n())

CN_per_Patient = labelled_data %>% group_by(group) %>% subset(select=c('Patient','CN')) %>%
  group_by(Patient,CN) %>% dplyr::summarise(n = n())

cells_Patient_CN = merge(cells_per_Patient, CN_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient_CN)
colnames(cells_Patient_CN) = c('Patient','group','CellTotal','CN','Count')
cells_Patient_CN$Perc_CN_Patient = cells_Patient_CN$Count / cells_Patient_CN$CellTotal
head(cells_Patient_CN)

# DONUT CHART WITH CN PROPORTIONS BY CLINICAL GROUP
cells_Patient_CN_avg = cells_Patient_CN %>% group_by(group, CN) %>% dplyr::summarise(Avg.Percent = mean(Perc_CN_Patient))
head(cells_Patient_CN_avg)

cells_Patient_CN_avg$ymax = cumsum(cells_Patient_CN_avg$Avg.Percent)
cells_Patient_CN_avg$ymin = c(0, head(cells_Patient_CN_avg$ymax, n=-1))

ggplot(cells_Patient_CN_avg[cells_Patient_CN_avg$group=='NR',], aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=CN)) +
    geom_rect() +
    scale_fill_brewer(palette='Paired') +
    coord_polar(theta="y") +
    xlim(c(2, 4)) +
    theme_void() +
    theme(legend.position = "none")

ggplot(cells_Patient_CN_avg[cells_Patient_CN_avg$group=='TCMR',], aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=CN)) +
    geom_rect() +
    scale_fill_brewer(palette='Paired') +
    coord_polar(theta="y") +
    xlim(c(2, 4)) +
    theme_void() +
    theme(legend.position = "none")

ggplot(cells_Patient_CN_avg[cells_Patient_CN_avg$group=='CR',], aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=CN)) +
    geom_rect() +
    scale_fill_brewer(palette='Paired') +
    coord_polar(theta="y") +
    xlim(c(2, 4)) +
    theme_void() +
    theme(legend.position = "none")

# Get overall p-value
shapiro.test((cells_Patient_CN)$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = cells_Patient_CN, method='kruskal.test', group.by='CN')

# CN Hepatocytes
shapiro.test((cells_Patient_CN %>% filter(CN == 'Hepatocytes'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'Hepatocytes')), method='t.test')

ggplot(data = (cells_Patient_CN %>% filter(CN == 'Hepatocytes')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Hepatocytes CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#A6CEE3","#A6CEE3","#A6CEE3")) +
  # stat_compare_means(method = 't.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.4) +
  # stat_compare_means(method = 't.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.37) +
  stat_compare_means(method = 't.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.41) +
  stat_compare_means(method = 'anova', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.2", as.numeric(..p.format..))))

# CN Vasculature
shapiro.test((cells_Patient_CN %>% filter(CN == 'Vasculature'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'Vasculature')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'Vasculature')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Vasculature CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#1F78B4","#1F78B4","#1F78B4")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.93", as.numeric(..p.format..))))

# CN Granulocytes enriched
shapiro.test((cells_Patient_CN %>% filter(CN == 'Granulocytes enriched'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'Granulocytes enriched')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'Granulocytes enriched')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Granulocytes enriched CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#B2DF8A","#B2DF8A","#B2DF8A")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.7", as.numeric(..p.format..))))

# CN Activated macrophages
shapiro.test((cells_Patient_CN %>% filter(CN == 'Activated macrophages'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'Activated macrophages')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'Activated macrophages')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Activated macrophages CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#33A02C","#33A02C","#33A02C")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.7", as.numeric(..p.format..))))

# CN CD8 enriched
shapiro.test((cells_Patient_CN %>% filter(CN == 'CD8 enriched'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'CD8 enriched')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'CD8 enriched')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD8 enriched CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#FB9A99","#FB9A99","#FB9A99")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CN CD16+ T-helper enriched
shapiro.test((cells_Patient_CN %>% filter(CN == 'CD16+ T-helper enriched'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'CD16+ T-helper enriched')), method='t.test')

ggplot(data = (cells_Patient_CN %>% filter(CN == 'CD16+ T-helper enriched')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("CD16+ T-helper enriched CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#E31A1C","#E31A1C","#E31A1C")) +
  # stat_compare_means(method = 't.test', comparisons = list(c("NR","CR")),
  #                    size = 3, label.y = 0.02) +
  # stat_compare_means(method = 't.test', comparisons = list(c("NR","TCMR")),
  #                    size = 3, label.y = 0.3) +
  stat_compare_means(method = 't.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'anova', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CN T-helper enriched
shapiro.test((cells_Patient_CN %>% filter(CN == 'T-helper enriched'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'T-helper enriched')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'T-helper enriched')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("T-helper enriched CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#FDBF6F","#FDBF6F","#FDBF6F")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.31) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.7", as.numeric(..p.format..))))

# CN B-cell and monocytes enriched
shapiro.test((cells_Patient_CN %>% filter(CN == 'B-cell and monocytes enriched'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'B-cell and monocytes enriched')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'B-cell and monocytes enriched')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("B-cell and monocytes enriched CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#FF7F00","#FF7F00","#FF7F00")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.3) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p < 0.01", as.numeric(..p.format..))))

# CN Bile duct
shapiro.test((cells_Patient_CN %>% filter(CN == 'Bile duct'))$Perc_CN_Patient)
compare_means(Perc_CN_Patient ~ group, data = (cells_Patient_CN %>% filter(CN == 'Bile duct')))

ggplot(data = (cells_Patient_CN %>% filter(CN == 'Bile duct')), 
               aes(x = group, y = Perc_CN_Patient,
                   fill = group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  ggtitle("Bile duct CN") + xlab(NULL) + ylab("% per Patient") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0,0.5)) +
  scale_fill_manual(values = c("#CAB2D6","#CAB2D6","#CAB2D6")) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","CR")),
                     size = 3, label.y = 0.4) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("NR","TCMR")),
                     size = 3, label.y = 0.31) +
  stat_compare_means(method = 'wilcox.test', comparisons = list(c("CR","TCMR")),
                     size = 3, label.y = 0.35) +
  stat_compare_means(method = 'kruskal.test', label.y = 0.5, size=8,
                     aes(label = sprintf("Overall p = 0.93", as.numeric(..p.format..))))
```

```{r}
#####################################
# Min Distance to Endothelial Cells #
#####################################

sce_adult_labelled = minDistToCells(sce_adult_labelled,
               x_cells = (sce_adult_labelled$Clusters=='Endothelial cells'),
               img_id = 'sample_id')

plotSpatial(sce_adult_labelled[,sce_adult_labelled$Patient == 'SP21_336'], 
            node_color_by = "distToCells", 
            img_id = "sample_id", 
            node_size_fix = 1.5) +
    scale_color_gradient2(low = "dark blue", mid = "white", high = "dark red")

ggplot(as.data.frame(colData(sce_adult_labelled))) + 
    geom_density_ridges(aes(distToCells, Subcluster, fill = Clusters)) +
    geom_vline(xintercept = 0, color = "dark red", linewidth = 2) +
  xlab('Distance to Endothelial Cells') +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#bf812d", "#FFEA00", "orange","green","#0096FF",
                       "#ae017e","#CCCCFF","#313695","#C04000","lightblue"))
                       
ggplot(as.data.frame(colData(sce_adult_labelled[,sce_adult_labelled$group=='CR']))) + 
    geom_density_ridges(aes(distToCells, Clusters, fill = Clusters)) +
    geom_vline(xintercept = 0, color = "dark red", linewidth = 2) +
  xlab('Distance to Endothelial Cells') +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#bf812d", "#FFEA00", "orange","green","#0096FF",
                       "#ae017e","#CCCCFF","#313695","#C04000","lightblue"))
                       
ggplot(as.data.frame(colData(sce_adult_labelled))) + 
    geom_density_ridges(aes(distToCells, Clusters, fill = group), alpha=0.7) +
    geom_vline(xintercept = 0, color = "black", linewidth = 1.5) +
  xlab('Distance to Endothelial Cells') +
  theme_bw() +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))

ggplot(as.data.frame(colData(sce_adult_labelled))) + 
    geom_density_ridges(aes(distToCells, Subcluster, fill = group), alpha=0.7) +
    geom_vline(xintercept = 0, color = "black", linewidth = 1.5) +
  xlab('Distance to Endothelial Cells') +
  theme_bw() +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))


as.data.frame(colData(sce_adult_labelled)) %>% group_by(Clusters) %>% 
  dplyr::summarize(Dist = median(na.omit(as.numeric(distToCells))))

minDist_group = as.data.frame(colData(sce_adult_labelled)) %>% group_by(group,Clusters) %>% 
  dplyr::summarize(Dist = median(na.omit(as.numeric(distToCells))))

minDist_group_quantile = as.data.frame(colData(sce_adult_labelled)) %>% group_by(group,Clusters) %>% 
  dplyr::summarize(Dist = quantile(na.omit(as.numeric(distToCells))))

labelled_data$DistToEndoCells = sce_adult_labelled$distToCells

labelled_data %>% group_by(group,Clusters) %>% 
  dplyr::summarize(Dist = median(na.omit(as.numeric(DistToEndoCells))))

labelled_data %>% group_by(group,Clusters) %>% 
  dplyr::summarize(Dist = quantile(na.omit(as.numeric(DistToEndoCells))))

# Statistical difference across groups
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='B cells',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='CD4+ T-cells',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='CD8+ T-cells',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Monocytes',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Macrophages',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Neutrophils',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Plasma cells',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Endothelial cells',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Cholangiocytes',])
kruskal.test(DistToEndoCells ~ group, data=labelled_data[labelled_data$Clusters=='Hepatocytes',])
```

# Demographics Data

(Input files not provided for patient privacy/security reasons)

```{r}
dem_data = read_xlsx("/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/IMC biodata.xlsx")
head(dem_data)

dem_data$Group = factor(dem_data$Group, levels=c('NR','TCMR','CR'))

dem_data %>% group_by(Group) %>% dplyr::summarize(n())

###############
##### AGE #####
###############

kruskal.test(`Age at tx` ~ Group, data=dem_data)

summary((dem_data %>% dplyr::filter(Group=='NR'))$`Age at tx`)[3]
summary((dem_data %>% dplyr::filter(Group=='NR'))$`Age at tx`)[2]
summary((dem_data %>% dplyr::filter(Group=='NR'))$`Age at tx`)[5]

summary((dem_data %>% dplyr::filter(Group=='TCMR'))$`Age at tx`)[3]
summary((dem_data %>% dplyr::filter(Group=='TCMR'))$`Age at tx`)[2]
summary((dem_data %>% dplyr::filter(Group=='TCMR'))$`Age at tx`)[5]

summary((dem_data %>% dplyr::filter(Group=='CR'))$`Age at tx`)[3]
summary((dem_data %>% dplyr::filter(Group=='CR'))$`Age at tx`)[2]
summary((dem_data %>% dplyr::filter(Group=='CR'))$`Age at tx`)[5]

###############
##### Sex #####
###############

sex_data = dem_data %>% subset(select=c(Sex,Group))
fisher.test(table(sex_data$Sex, sex_data$Group),simulate.p.value=TRUE)

###############
##### Race ####
###############

race_data = dem_data %>% subset(select=c(Race,Group))
fisher.test(table(race_data$Race, race_data$Group),simulate.p.value=TRUE)

###############
## Ethnicity ##
###############

ethnicity_data = dem_data %>% subset(select=c(Ethnicity,Group))
fisher.test(table(ethnicity_data$Ethnicity, ethnicity_data$Group),simulate.p.value=TRUE)

###############
## Diagnosis ##
###############

dx_data = dem_data %>% subset(select=c(`Diagnosis Group`,Group))
# Rectify 2 patient diagnosis
dx_data[dx_data$`Diagnosis Group`=='other' & dx_data$Group=='NR',][1,]$`Diagnosis Group`='Acute Failure'
dx_data[dx_data$`Diagnosis Group`=='Hepatocellular' & dx_data$Group=='CR',][1,]$`Diagnosis Group`='Hepatitis'

fisher.test(table(dx_data$`Diagnosis Group`, dx_data$Group),simulate.p.value=TRUE)

###############
## DDLT/LDLT ##
###############

type_data = dem_data %>% subset(select=c(`First transplant`,Group))
fisher.test(table(type_data$`First transplant`, type_data$Group),simulate.p.value=TRUE)

###############

dem_data2 = read_xlsx("/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/Patient demographics.xlsx")
head(dem_data2)

dem_data2$Group = factor(dem_data2$Group, levels=c('NR','TCMR','CR'))

dem_data2 %>% group_by(Group) %>% dplyr::summarize(n())

####################
## Time to biopsy ##
####################

kruskal.test(`Time from LT to Biopsy/Explant (evaluated) Days` ~ Group, data=dem_data2)

#######################
## Immunosuppression ##
#######################

dem_data2 = dem_data2 %>% dplyr::mutate(Immunosuppression = case_when(
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(`Maintenance IS 2` == 'MMF')&(`Maintenance IS 3`=='Prednisone') ~ 'Tac+MMF+Pre',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(`Maintenance IS 2` == 'MMF')&(is.na(`Maintenance IS 3`)) ~ 'Tac+MMF',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(is.na(`Maintenance IS 2`))&(`Maintenance IS 3` == 'Prednisone') ~ 'Tac+Pre',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(is.na(`Maintenance IS 2`))&(is.na(`Maintenance IS 3`)) ~ 'Tac',
  (`CNI/mTOR Maintenance IS 1` == 'N/A') ~ 'NA',
  T ~ 'Other'
))

immuno = dem_data2 %>% subset(select=c(Immunosuppression,Group))
fisher.test(table(immuno$Immunosuppression, immuno$Group),simulate.p.value=TRUE)

immuno_plot = immuno %>% group_by(Group,Immunosuppression) %>% dplyr::summarize(total=n())

ggplot(immuno_plot, aes(fill=Immunosuppression, y=total, x=Group)) + 
    geom_bar(position="fill", stat="identity") + ylab(NULL) + xlab(NULL) + 
    theme(axis.text=element_text(size=18),
        axis.title=element_blank(),
        plot.title=element_text(size = 22, hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=16),
        axis.ticks.x = element_blank(),
        aspect.ratio=1,
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values=c("#C0C0C0","#de77ae","#ffffbf","#74add1","#bf812d","#ae017e"))


ggbarstats(
  immuno, rownames(immuno), Group,
  results.subtitle = FALSE,
  subtitle = paste0(
    "p = ",
     ifelse(test$p.value < 0.001, "< 0.001", round(test$p.value, 2))), size=12) + 
  theme(axis.text=element_text(size=18),
        axis.title=element_blank(),
        plot.title=element_text(size = 22, hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=16),
        axis.ticks.x = element_blank(),
        aspect.ratio=1,
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values=c("#C0C0C0","#de77ae","#ffffbf","#74add1","#bf812d","#ae017e"))


ggplot(data = immuno_plot,aes(x = Group, y = total,
                           group_by=Immunosuppression, fill=Immunosuppression)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("") + ylab("Patient percentage") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        # legend.position='none',
        panel.grid = element_blank(),
        legend.title=element_blank(),
        legend.text=element_text(size=30),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle =45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits=c(0,0.6)) +
  # coord_flip() +
  scale_fill_manual(values = c("lightgray","darkgray","black"))
```

TCMR patient subset - Cell proportion differences in Rejection Severity & Demographics

(Input files not provided for patient privacy/security reasons)

```{r}
head(dem_data2)

dem_data_TCMR = read_csv("/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/TCMR_Demographics.csv")
head(dem_data_TCMR)

unique(dem_data_TCMR$Patient)
unique(labelled_data$Patient)

dem_data_TCMR[!dem_data_TCMR$Patient %in% labelled_data$Patient,]

labelled_data$Subcluster = sce_adult_labelled$Subcluster

TCMR_demographics_data = merge(labelled_data,dem_data_TCMR,by='Patient')
unique(TCMR_demographics_data$group)

TCMR_demographics_data$Portal = TCMR_demographics_data$`Portal score`
TCMR_demographics_data$Venous = TCMR_demographics_data$`Venous score`
TCMR_demographics_data$BileDuct = TCMR_demographics_data$`Bile duct score`

head(TCMR_demographics_data)

###########################
## Severity of rejection ##
###########################

rejection_severity = TCMR_demographics_data %>% subset(select=c(Patient,RAI,`Portal score`,`Bile duct score`,`Venous score`))

rai = rejection_severity %>% group_by(RAI) %>% dplyr::summarize(total=n_distinct(Patient))
rai$RAI = factor(rai$RAI, levels=c('4','5','6','7'))

ggplot(data = rai,aes(x = RAI, y = total)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("RAI score") + ylab("Number of patients") +
  theme(axis.text=element_text(size=19),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank()) +
  scale_y_continuous(limits=c(0,25))

portal = rejection_severity %>% group_by(`Portal score`) %>% dplyr::summarize(total=n_distinct(Patient))
portal$`Portal score` = factor(portal$`Portal score`, levels=c('2','3'))

ggplot(data = portal,aes(x = `Portal score`, y = total)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("Portal score") + ylab("Number of patients") +
  theme(axis.text=element_text(size=19),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank())+
  scale_y_continuous(limits=c(0,25))

bile = rejection_severity %>% group_by(`Bile duct score`) %>% dplyr::summarize(total=n_distinct(Patient))
bile$`Bile duct score` = factor(bile$`Bile duct score`, levels=c('1','2','3'))

ggplot(data = bile,aes(x = `Bile duct score`, y = total)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("Bile duct score") + ylab("Number of patients") +
  theme(axis.text=element_text(size=19),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank()) +
  scale_y_continuous(limits=c(0,40))

venous = rejection_severity %>% group_by(`Venous score`) %>% dplyr::summarize(total=n_distinct(Patient))
venous$`Venous score` = factor(venous$`Venous score`, levels=c('0','1','2'))

ggplot(data = venous,aes(x = `Venous score`, y = total)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8) +
  theme_bw() +
  ggtitle(NULL) + xlab("Venous score") + ylab("Number of patients") +
  theme(axis.text=element_text(size=19),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank())+
  scale_y_continuous(limits=c(0,20))

################
# METACLUSTERS #
################

# RAI

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('RAI','Patient')) %>% group_by(RAI,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(RAI) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','RAI','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ RAI, data = cells_Patient, method='kruskal.test', group.by='Clusters')

# Portal score

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Portal','Patient')) %>% group_by(Portal,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Portal) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Portal','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Portal, data = cells_Patient, method='kruskal.test', group.by='Clusters')

# Bile duct score

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('BileDuct','Patient')) %>% group_by(`BileDuct`,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(`BileDuct`) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','BileDuct','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ BileDuct, data = cells_Patient, method='kruskal.test', group.by='Clusters')

# Venous score

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Venous','Patient')) %>% group_by(Venous,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Venous) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Venous','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Venous, data = cells_Patient, method='kruskal.test', group.by='Clusters')

#########################################################
# DISTANCE TO ENDOTHELIAL CELLS BY RAI AND PORTAL SCORE #
#########################################################

sce_adult_labelled$RAI = TCMR_demographics_data$RAI[match(sce_adult_labelled$Patient, TCMR_demographics_data$Patient)]
unique(sce_adult_labelled[,is.na(sce_adult_labelled$RAI)]$Patient)
unique(sce_adult_labelled$RAI)

sce_adult_labelled$Portal = TCMR_demographics_data$Portal[match(sce_adult_labelled$Patient, TCMR_demographics_data$Patient)]
unique(sce_adult_labelled[,is.na(sce_adult_labelled$Portal)]$Patient)
unique(sce_adult_labelled$Portal)

sce_adult_labelled_TCMR = sce_adult_labelled[,sce_adult_labelled$group=='TCMR']

sce_adult_labelled_TCMR = minDistToCells(sce_adult_labelled_TCMR,
               x_cells = (sce_adult_labelled_TCMR$Clusters=='Endothelial cells'),
               img_id = 'sample_id')

unique(sce_adult_labelled_TCMR$Patient)

# RAI

unique(sce_adult_labelled_TCMR$RAI)

sce_adult_labelled_TCMR$RAI = factor(sce_adult_labelled_TCMR$RAI,
                                        levels=c('4','5','6','7'))

library(ggridges)
ggplot(as.data.frame(colData(sce_adult_labelled_TCMR))) + 
    geom_density_ridges(aes(distToCells, Subcluster, fill = RAI), alpha=0.7) +
    geom_vline(xintercept = 0, color = "black", linewidth = 1.5) +
  xlab('Distance to Endothelial Cells') +
  theme_bw() +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080","black"))

# Portal score

unique(sce_adult_labelled_TCMR$Portal)

sce_adult_labelled_TCMR$Portal = factor(sce_adult_labelled_TCMR$Portal,
                                        levels=c('2','3'))

library(ggridges)
ggplot(as.data.frame(colData(sce_adult_labelled_TCMR))) + 
    geom_density_ridges(aes(distToCells, Subcluster, fill = Portal), alpha=0.7) +
    geom_vline(xintercept = 0, color = "black", linewidth = 1.5) +
  xlab('Distance to Endothelial Cells') +
  theme_bw() +
  scale_x_continuous(limits=c(-50,150)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6","#800080"))



################
# DEMOGRAPHICS #
################

# Sex

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Sex','Patient')) %>% group_by(Sex,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Sex) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Sex','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Sex, data = cells_Patient, method='wilcox.test', group.by='Clusters')

sex_proportions = cells_Patient %>% group_by(Sex,Clusters) %>% 
  dplyr::summarize(median=median(Perc_CellType_Patient),
                   qs = quantile(Perc_CellType_Patient, c(0.25, 0.75)),
                   prob = c(0.25, 0.75))

cells_Patient %>% group_by(Sex) %>% 
  dplyr::summarize(tot = n())

# Race/Ethnicity

TCMR_demographics_data = TCMR_demographics_data %>% dplyr::mutate(Race_Ethnicity = case_when(
  Ethnicity == 'hispanic' ~ 'Hispanic',
  T ~ Race
))

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Race_Ethnicity','Patient')) %>% group_by(Race_Ethnicity,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Race_Ethnicity) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Race_Ethnicity','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

unique(cells_Patient$Race_Ethnicity)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Race_Ethnicity, data = cells_Patient, method='kruskal.test', group.by='Clusters')


race_proportions = cells_Patient %>% group_by(Race_Ethnicity,Clusters) %>% 
  dplyr::summarize(median=median(Perc_CellType_Patient),
                   qs = quantile(Perc_CellType_Patient, c(0.25, 0.75)),
                   prob = c(0.25, 0.75))


cells_Patient %>% group_by(Race_Ethnicity) %>% 
  dplyr::summarize(tot = n())

# Etiology

TCMR_demographics_data$Etiology = TCMR_demographics_data$`Diagnosis Group`

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Etiology','Patient')) %>% 
  group_by(Etiology,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Etiology) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Etiology','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Etiology, data = cells_Patient, method='kruskal.test', group.by='Clusters')

cells_Patient %>% group_by(Etiology) %>% 
  dplyr::summarize(tot = n())

etiology_proportions = cells_Patient %>% group_by(Etiology,Clusters) %>% 
  dplyr::summarize(median=median(Perc_CellType_Patient),
                   qs = quantile(Perc_CellType_Patient, c(0.25, 0.75)),
                   prob = c(0.25, 0.75))

unique(TCMR_demographics_data$Patient)

TCMR_demographics_data %>% group_by(Etiology) %>% dplyr::summarize(tot=n_distinct(Patient))

#####################
# IMMUNOSUPRESSION  #
#####################

head(TCMR_demographics_data)

TCMR_demographics_data = TCMR_demographics_data %>% dplyr::mutate(Immunosuppression = case_when(
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(`Maintenance IS 2` == 'MMF')&(`Maintenance IS 3`=='Prednisone') ~ 'Tac+MMF+Pre',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(`Maintenance IS 2` == 'MMF')&(is.na(`Maintenance IS 3`)) ~ 'Tac+MMF',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(is.na(`Maintenance IS 2`))&(`Maintenance IS 3` == 'Prednisone') ~ 'Tac+Pre',
  (`CNI/mTOR Maintenance IS 1` == 'Tacro')&(is.na(`Maintenance IS 2`))&(is.na(`Maintenance IS 3`)) ~ 'Tac',
  (`CNI/mTOR Maintenance IS 1` == 'N/A') ~ 'NA',
  T ~ 'Other'
))

unique(TCMR_demographics_data$Immunosuppression)

TCMR_demographics_data %>% group_by(Immunosuppression) %>% dplyr::summarize(total=n_distinct(Patient))

TCMR_demographics_data = TCMR_demographics_data[TCMR_demographics_data$Immunosuppression!='NA',]

TCMR_demographics_data %>% group_by(Immunosuppression) %>% dplyr::summarize(total=n_distinct(Patient))

cells_per_Patient = TCMR_demographics_data %>% subset(select=c('Immunosuppression','Patient')) %>% group_by(Immunosuppression,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_demographics_data %>% group_by(Immunosuppression) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Immunosuppression','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

unique(cells_Patient$Immunosuppression)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Immunosuppression, data = cells_Patient, method='kruskal.test', group.by='Clusters')


is_proportions = cells_Patient %>% group_by(Immunosuppression,Clusters) %>% 
  dplyr::summarize(median=median(Perc_CellType_Patient),
                   qs = quantile(Perc_CellType_Patient, c(0.25, 0.75)),
                   prob = c(0.25, 0.75))

############################
# EARLY vs LATE REJECTION  #
############################

rejection_data = read_excel("Data/Final/IMC biodata_TCMR_IS.xlsx")

rejection_data[rejection_data$Patient %in% labelled_data$Patient,]

head(rejection_data)

rejection_data = rejection_data %>% dplyr::mutate(Rejection = case_when(
  `Time to rejection analyzed` <= 183 ~ 'Early',
  `Time to rejection analyzed` > 183 ~ 'Late'))

unique(rejection_data$Rejection)

TCMR_rejection_data = merge(labelled_data,rejection_data,by='Patient')
unique(TCMR_rejection_data$group)

TCMR_rejection_data %>% group_by(Rejection) %>% dplyr::summarize(total=n_distinct(Patient))

cells_per_Patient = TCMR_rejection_data %>% subset(select=c('Rejection','Patient')) %>% group_by(Rejection,Patient) %>% 
  dplyr::summarise(n = n())

cellType_per_Patient = TCMR_rejection_data %>% group_by(Rejection) %>% subset(select=c('Patient','Clusters')) %>%
  group_by(Patient,Clusters) %>% dplyr::summarise(n = n())

cells_Patient = merge(cells_per_Patient, cellType_per_Patient, all.x=TRUE, by='Patient')
head(cells_Patient)
colnames(cells_Patient) = c('Patient','Rejection','CellTotal','Clusters','Count')
cells_Patient$Perc_CellType_Patient = cells_Patient$Count / cells_Patient$CellTotal
head(cells_Patient)

unique(cells_Patient$Rejection)

shapiro.test((cells_Patient)$Perc_CellType_Patient) # Reject Ho, data is non-normal - use non-parametric test
compare_means(Perc_CellType_Patient ~ Rejection, data = cells_Patient, method='kruskal.test', group.by='Clusters')


is_proportions = cells_Patient %>% group_by(Rejection,Clusters) %>% 
  dplyr::summarize(median=median(Perc_CellType_Patient),
                   qs = quantile(Perc_CellType_Patient, c(0.25, 0.75)),
                   prob = c(0.25, 0.75))
```

# PREDICTIVE MODELING   

```{r}
plasma_neutro = cells_Patient[,c(1:6)] %>% filter(Clusters %in% c('Plasma cells','Neutrophils'))
colnames(plasma_neutro) = c('Patient','group','CellTotal','Subcluster','Count','Perc_CellType_Patient')
head(plasma_neutro)

cells_Patient_subclusters = rbind(cells_Patient_cd4,cells_Patient_cd8,cells_Patient_macrophages[,c(1:6)],
      cells_Patient_monocytes[,c(1:6)],cells_Patient_bcells,plasma_neutro,cells_Patient_hepatocytes,
      cells_Patient_endothelial,cells_Patient_chol)
head(cells_Patient_subclusters)

data_modeling = cells_Patient_subclusters[,c('Patient','group','Subcluster','Perc_CellType_Patient')]
head(data_modeling)

data_modeling_reshape = reshape::cast(data_modeling, group*Patient~Subcluster, value='Perc_CellType_Patient', fun.aggregate=sum)
head(data_modeling_reshape)

data_modeling_reshape = data_modeling_reshape[,c(1,3:43)]
head(data_modeling_reshape)

# write_csv(data_modeling_reshape, 'adult_IMC_modeling_data.csv')
# data_modeling_reshape = read_csv('adult_IMC_modeling_data.csv')



##############
# NR vs TCMR #
##############

data = data_modeling_reshape %>% filter(group != 'CR')
head(data)

data$group = recode(data$group, "NR"=0, "TCMR"=1)
data$group = as.factor(data$group)

variables = c('Activated CD4+ T-cells','B cells','CD16+ M2 macrophages','CD3+ CD4+ T-cells',
           'CD3+ CD8+ T-cells','Non-classical monocytes','HLADR+ CD4+ Tregs',
           'HLADR+ M2 macrophages','Intermediate monocytes','Naive CD4+ T-cells','PD1+ CD4+ T-cells',
           'PD1+ CD8+ T-cells','Proliferating M1 macrophages','Resident memory CD4+ T-cells',
           'Hepatocytes','Proliferating Hepatocytes','HLADR+ Hepatocytes','Cholangiocytes','HLADR+ Cholangiocytes')

# Select Lambda using 5-fold CV
set.seed(88)
cv_model <- cv.glmnet(data.matrix(data[,variables]), data$group,
                        alpha = 1, family='binomial', type.measure='deviance', nfolds=5)
best_lambda <- cv_model$lambda.min

# Feature Selection via Bootstrapping

df = data[,c('group',variables)] # Use only variables deemed as statistically significant in NR vs TCMR
topvar = list()
for (i in 1:5000) {
  
  # CV and Splitting
  ind <- sample(nrow(df), nrow(df), replace = TRUE)
  ind <- unique(ind)
  
  train <- df[ind, ]
  xtrain <- model.matrix(group~., train)[,-1]
  ytrain <- df[ind, 1]

  test <- df[-ind, ]
  xtest <- model.matrix(group~., test)[,-1]
  ytest <- df[-ind, 1]
  
  # Create Model per Loop
  model <- glmnet(xtrain, ytrain, alpha = 1, lambda = best_lambda, family='binomial') 
                     
  # Store Coeffecients per loop
  coef_las <- coef(model, s = best_lambda)[-1, ] # Remove intercept
  
  # Store all nonzero Coefficients
  topvar[[i]] <- coef_las[which(coef_las != 0)]
  
}

# Unlist 
varimp <- unlist(topvar)

# Count all predictors
novar <- table(names(varimp))

# Find the mean of all variables
meanvar <- tapply(varimp, names(varimp), mean)

# Return top 20 repeated Coefs
repvar <- novar[order(novar, decreasing = TRUE)]
repvar

# Calculate % of times a variable was selected (out of 5,000)
repvar = repvar/5000
repvar

ggplot(as.data.frame(repvar), aes(fct_rev(fct_infreq(Var1)),Freq)) + geom_col() +
  theme_bw() + ylab("Frequency") +
  theme(axis.text=element_text(size=15),
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=15),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip()

# Select variables that were selected >50%
which(repvar > 0.5)
variables = c('Resident memory CD4+ T-cells','HLADR+ M2 macrophages','CD16+ M2 macrophages','Non-classical monocytes',
              'Intermediate monocytes','PD1+ CD4+ T-cells','Proliferating Hepatocytes','Cholangiocytes')

# Train/test model and evaluate performance using CV
### Manually do CV with variables identified via bootstrapping

eval_results = data.frame()
pred_results = data.frame(c(1:65))
colnames(pred_results) = 'Observation'
var = list()
for (i in 1:1000){
  set.seed(i)
  split = sample.split(data$group, SplitRatio = 0.75)
  datatrain = subset(data, split == TRUE)
  datatest = subset(data, split == FALSE)
  
  best_model <- glmnet(datatrain[,variables], datatrain[,1], 
                     alpha = 1, lambda = best_lambda, family='binomial')
  coef_las <- coef(best_model)[-1, ] # Remove intercept and store coefficient
  var[[i]] <- coef_las
  
  prediction_test = predict(best_model, s = best_lambda, 
                     newx = data.matrix(datatest[,variables]), 
                     type = 'response')
  
  temp_pred_df = as.data.frame(prediction_test)
  colnames(temp_pred_df) = i
  temp_pred_df$Observation = c(rownames(temp_pred_df))
  pred_results = merge(pred_results,temp_pred_df,by='Observation',all.x=T)
  
  conf = table(datatest$group, prediction_test > 0.5, dnn = list("Actual", "Predicted"))
  tp = conf[2, 2]
  tn = conf[1, 1]
  fp = conf[1, 2]
  fn = conf[2, 1]
  
  eval_results[i,'Sensitivity'] =  tp / (tp + fn)
  eval_results[i,'Specificity'] = tn / (tn + fp)
  eval_results[i,'Accuracy'] = (tp + tn) / sum(conf)
  eval_results[i,'AUC'] = auc(datatest$group, prediction_test[,1])
}

# Coefficients
coefficients <- unlist(var)
mean_coef <- tapply(coefficients, names(coefficients), mean)
mean_coef

# Evaluation metrics
eval_results_avg = apply(eval_results, 2, mean)
eval_results_avg$AUC_SD = sd(eval_results$AUC)
eval_results_avg$Low_AUC = eval_results_avg$AUC - sd(eval_results$AUC)
eval_results_avg$High_AUC = eval_results_avg$AUC + sd(eval_results$AUC)
eval_results_avg$Sensitivity_SD = sd(eval_results$Sensitivity)
eval_results_avg$Specificity_SD = sd(eval_results$Specificity)
eval_results_avg$Accuracy_SD = sd(eval_results$Accuracy)
eval_results_avg

# Prediction vs actual comparison
pred_results_median = apply(pred_results[,-1], 1, median, na.rm = TRUE)
head(pred_results_median)

pred_results_median_binary = case_when(pred_results_median > 0.5 ~ 1,
                                       pred_results_median < 0.5 ~ 0)
temp_df = as.data.frame(data$group)
colnames(temp_df) = 'Group'
temp_df$Pred_results = pred_results_median_binary
temp_df$Group = as.factor(temp_df$Group)

wilcox.test(Pred_results ~ Group, data=temp_df)
cor(x=as.numeric(data$group), y=pred_results_median_binary, method = 'spearman')

temp_df2 = as.data.frame(data$group)
colnames(temp_df2) = 'Group'
temp_df2$Pred_results = pred_results_median
temp_df2 = temp_df2 %>% mutate(Group = case_when(Group == 0 ~ 'NR', 
                                                 Group == 1 ~ 'TCMR'))

ggplot(temp_df2, aes(Group, Pred_results, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  geom_point(colour = 'black', size = 2) +
  ggtitle(NULL) + xlab(NULL) + ylab("Model Prediction") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6"))

rocplot <- function(pred, truth, ...) {
  predob = prediction(pred, truth)
  perf = performance(predob, "tpr", "fpr")
  plot(perf, ...)
  segments(x0=0, y0=0, x1=1, y1=1, col="gray", lty=2)
}

par(cex.axis=1.5,cex.lab=1.5)
rocplot(pred_results_median, data$group, col="blue") +
  title("ROC Curve", cex.main=2)
par(cex.axis=1.0,cex.lab=1.0)





##############
# TCMR vs CR #
##############

data = data_modeling_reshape %>% filter(group != 'NR')
head(data)

data$group = recode(data$group, "TCMR"=0, "CR"=1)
data$group = as.factor(data$group)

variables = c('Plasma cells','CD3+ CD4+ T-cells','CD16+ CD4+ T-cells','CD3+ CD8+ T-cells',
              'Proliferating CD8+ T-cells','PD1+ CD8+ T-cells','Proliferating M1 macrophages',
              'CD16+ M1 macrophages','Intermediate monocytes','Proliferating Hepatocytes','Endothelial cells',
              'Proliferating Endothelial cells','Cholangiocytes')

# Select Lambda using 5-fold CV
set.seed(88)
cv_model <- cv.glmnet(data.matrix(data[,variables]), data$group,
                        alpha = 1, family='binomial', type.measure='deviance', nfolds=5)
best_lambda <- cv_model$lambda.min

# Feature Selection via Bootstrapping

df = data[,c('group',variables)] # Use only variables deemed as statistically significant in TCMR vs CR
topvar = list()
for (i in 1:5000) {
  
  # CV and Splitting
  ind <- sample(nrow(df), nrow(df), replace = TRUE)
  ind <- unique(ind)
  
  train <- df[ind, ]
  xtrain <- model.matrix(group~., train)[,-1]
  ytrain <- df[ind, 1]

  test <- df[-ind, ]
  xtest <- model.matrix(group~., test)[,-1]
  ytest <- df[-ind, 1]
  
  # Create Model per Loop
  model <- glmnet(xtrain, ytrain, alpha = 1, lambda = best_lambda, family='binomial') 
                     
  # Store Coeffecients per loop
  coef_las <- coef(model, s = best_lambda)[-1, ] # Remove intercept
  
  # Store all nonzero Coefficients
  topvar[[i]] <- coef_las[which(coef_las != 0)]
  
}

# Unlist 
varimp <- unlist(topvar)

# Count all predictors
novar <- table(names(varimp))

# Find the mean of all variables
meanvar <- tapply(varimp, names(varimp), mean)

# Return top 20 repeated Coefs
repvar <- novar[order(novar, decreasing = TRUE)]
repvar

# Calculate % of times a variable was selected (out of 5,000)
repvar = repvar/5000
repvar

ggplot(as.data.frame(repvar), aes(fct_rev(fct_infreq(Var1)),Freq)) + geom_col() +
  theme_bw() + ylab("Frequency") +
  theme(axis.text=element_text(size=15),
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=15),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip()

# Select variables that were selected >50%
which(repvar > 0.5)
variables = c('Plasma cells','Proliferating CD8+ T-cells','Cholangiocytes','Proliferating M1 macrophages',
              'CD16+ CD4+ T-cells','PD1+ CD8+ T-cells','CD3+ CD4+ T-cells','CD16+ M1 macrophages','CD3+ CD8+ T-cells')

# Train/test model and evaluate performance using CV
### Manually do CV with variables identified via bootstrapping

eval_results = data.frame()
pred_results = data.frame(c(1:55))
colnames(pred_results) = 'Observation'
var = list()
for (i in 1:1000){
  set.seed(i)
  split = sample.split(data$group, SplitRatio = 0.75)
  datatrain = subset(data, split == TRUE)
  datatest = subset(data, split == FALSE)
  
  best_model <- glmnet(datatrain[,variables], datatrain[,1], 
                     alpha = 1, lambda = best_lambda, family='binomial')
  coef_las <- coef(best_model)[-1, ] # Remove intercept and store coefficient
  var[[i]] <- coef_las
  
  prediction_test = predict(best_model, s = best_lambda, 
                     newx = data.matrix(datatest[,variables]), 
                     type = 'response')
  
  temp_pred_df = as.data.frame(prediction_test)
  colnames(temp_pred_df) = i
  temp_pred_df$Observation = c(rownames(temp_pred_df))
  pred_results = merge(pred_results,temp_pred_df,by='Observation',all.x=T)
  
  conf = table(datatest$group, prediction_test > 0.5, dnn = list("Actual", "Predicted"))
  tp = conf[2, 2]
  tn = conf[1, 1]
  fp = conf[1, 2]
  fn = conf[2, 1]
  
  eval_results[i,'Sensitivity'] =  tp / (tp + fn)
  eval_results[i,'Specificity'] = tn / (tn + fp)
  eval_results[i,'Accuracy'] = (tp + tn) / sum(conf)
  eval_results[i,'AUC'] = auc(datatest$group, prediction_test[,1])
}

# Coefficients
coefficients <- unlist(var)
mean_coef <- tapply(coefficients, names(coefficients), mean)
mean_coef

# Evaluation metrics
eval_results_avg = apply(eval_results, 2, mean)
eval_results_avg$AUC_SD = sd(eval_results$AUC)
eval_results_avg$Low_AUC = eval_results_avg$AUC - sd(eval_results$AUC)
eval_results_avg$High_AUC = eval_results_avg$AUC + sd(eval_results$AUC)
eval_results_avg$Sensitivity_SD = sd(eval_results$Sensitivity)
eval_results_avg$Specificity_SD = sd(eval_results$Specificity)
eval_results_avg$Accuracy_SD = sd(eval_results$Accuracy)
eval_results_avg

# Prediction vs actual comparison
pred_results_median = apply(pred_results[,-1], 1, median, na.rm = TRUE)
head(pred_results_median)

pred_results_median_binary = case_when(pred_results_median > 0.5 ~ 1,
                                       pred_results_median < 0.5 ~ 0)
temp_df = as.data.frame(data$group)
colnames(temp_df) = 'Group'
temp_df$Pred_results = pred_results_median_binary
temp_df$Group = as.factor(temp_df$Group)

wilcox.test(Pred_results ~ Group, data=temp_df)
cor(x=as.numeric(data$group), y=pred_results_median_binary, method = 'spearman')

temp_df2 = as.data.frame(data$group)
colnames(temp_df2) = 'Group'
temp_df2$Pred_results = pred_results_median
temp_df2 = temp_df2 %>% mutate(Group = case_when(Group == 0 ~ 'TCMR', 
                                                 Group == 1 ~ 'CR'))

ggplot(temp_df2, aes(Group, Pred_results, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  geom_point(colour = 'black', size = 2) +
  ggtitle(NULL) + xlab(NULL) + ylab("Model Prediction") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("#800080","#DA70D6")) +
  scale_x_discrete(limits=c('TCMR','CR')) +
  scale_y_continuous(limits=c(0,1))

rocplot <- function(pred, truth, ...) {
  predob = prediction(pred, truth)
  perf = performance(predob, "tpr", "fpr")
  plot(perf, ...)
  segments(x0=0, y0=0, x1=1, y1=1, col="gray", lty=2)
}

par(cex.axis=1.5,cex.lab=1.5)
rocplot(pred_results_median, data$group, col="blue") +
  title("ROC Curve", cex.main=2)
par(cex.axis=1.0,cex.lab=1.0)




############
# NR vs CR #
############

data = data_modeling_reshape %>% filter(group != 'TCMR')
head(data)

data$group = recode(data$group, "NR"=0, "CR"=1)
data$group = as.factor(data$group)

variables = c('Plasma cells','CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Activated CD4+ T-cells',
              'Proliferating CD8+ T-cells','Proliferating M1 macrophages','CD16+ M1 macrophages',
              'CD16+ M2 macrophages','HLADR+ M2 macrophages','Intermediate monocytes','Proliferating Hepatocytes')

# Select Lambda using 5-fold CV
set.seed(88)
cv_model <- cv.glmnet(data.matrix(data[,variables]), data$group,
                        alpha = 1, family='binomial', type.measure='deviance', nfolds=5)
best_lambda <- cv_model$lambda.min

# Feature Selection via Bootstrapping

df = data[,c('group',variables)] # Use only variables deemed as statistically significant in NR vs TCMR
topvar = list()
for (i in 1:5000) {
  
  # CV and Splitting
  ind <- sample(nrow(df), nrow(df), replace = TRUE)
  ind <- unique(ind)
  
  train <- df[ind, ]
  xtrain <- model.matrix(group~., train)[,-1]
  ytrain <- df[ind, 1]

  test <- df[-ind, ]
  xtest <- model.matrix(group~., test)[,-1]
  ytest <- df[-ind, 1]
  
  # Create Model per Loop
  model <- glmnet(xtrain, ytrain, alpha = 1, lambda = best_lambda, family='binomial') 
                     
  # Store Coeffecients per loop
  coef_las <- coef(model, s = best_lambda)[-1, ] # Remove intercept
  
  # Store all nonzero Coefficients
  topvar[[i]] <- coef_las[which(coef_las != 0)]
  
}

# Unlist 
varimp <- unlist(topvar)

# Count all predictors
novar <- table(names(varimp))

# Find the mean of all variables
meanvar <- tapply(varimp, names(varimp), mean)

# Return top 20 repeated Coefs
repvar <- novar[order(novar, decreasing = TRUE)]
repvar

# Calculate % of times a variable was selected (out of 5,000)
repvar = repvar/5000
repvar

ggplot(as.data.frame(repvar), aes(fct_rev(fct_infreq(Var1)),Freq)) + geom_col() +
  theme_bw() + ylab("Frequency") +
  theme(axis.text=element_text(size=15),
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=15),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.title=element_blank(),
        legend.text=element_text(size=25),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip()

# Select variables that were selected >50%
which(repvar > 0.5)
variables = c('CD16+ M2 macrophages','Plasma cells','Resident memory CD4+ T-cells','HLADR+ M2 macrophages',
              'CD3+ CD4+ T-cells','Proliferating M1 macrophages')

# Train/test model and evaluate performance using CV
### Manually do CV with variables identified via bootstrapping
?sample.split
eval_results = data.frame()
pred_results = data.frame(c(1:38))
colnames(pred_results) = 'Observation'
var = list()
for (i in 1:1000){
  set.seed(i)
  split = sample.split(data$group, SplitRatio = 0.75)
  datatrain = subset(data, split == TRUE)
  datatest = subset(data, split == FALSE)
  
  best_model <- glmnet(datatrain[,variables], datatrain[,1], 
                     alpha = 1, lambda = best_lambda, family='binomial')
  coef_las <- coef(best_model)[-1, ] # Remove intercept and store coefficient
  var[[i]] <- coef_las
  
  prediction_test = predict(best_model, s = best_lambda, 
                     newx = data.matrix(datatest[,variables]), 
                     type = 'response')
  
  temp_pred_df = as.data.frame(prediction_test)
  colnames(temp_pred_df) = i
  temp_pred_df$Observation = c(rownames(temp_pred_df))
  pred_results = merge(pred_results,temp_pred_df,by='Observation',all.x=T)
  
  conf = table(datatest$group, prediction_test > 0.5, dnn = list("Actual", "Predicted"))
  tp = conf[2, 2]
  tn = conf[1, 1]
  fp = conf[1, 2]
  fn = conf[2, 1]
  
  eval_results[i,'Sensitivity'] =  tp / (tp + fn)
  eval_results[i,'Specificity'] = tn / (tn + fp)
  eval_results[i,'Accuracy'] = (tp + tn) / sum(conf)
  eval_results[i,'AUC'] = auc(datatest$group, prediction_test[,1])
}

# Coefficients
coefficients <- unlist(var)
mean_coef <- tapply(coefficients, names(coefficients), mean)
mean_coef

# Evaluation metrics
eval_results_avg = apply(eval_results, 2, mean)
eval_results_avg$AUC_SD = sd(eval_results$AUC)
eval_results_avg$Low_AUC = eval_results_avg$AUC - sd(eval_results$AUC)
eval_results_avg$High_AUC = eval_results_avg$AUC + sd(eval_results$AUC)
eval_results_avg$Sensitivity_SD = sd(eval_results$Sensitivity)
eval_results_avg$Specificity_SD = sd(eval_results$Specificity)
eval_results_avg$Accuracy_SD = sd(eval_results$Accuracy)
eval_results_avg

# Prediction vs actual comparison
pred_results_median = apply(pred_results[,-1], 1, median, na.rm = TRUE)
head(pred_results_median)

pred_results_median_binary = case_when(pred_results_median > 0.5 ~ 1,
                                       pred_results_median < 0.5 ~ 0)
temp_df = as.data.frame(data$group)
colnames(temp_df) = 'Group'
temp_df$Pred_results = pred_results_median_binary
temp_df$Group = as.factor(temp_df$Group)

wilcox.test(Pred_results ~ Group, data=temp_df)
cor(x=as.numeric(data$group), y=pred_results_median_binary, method = 'spearman')

temp_df2 = as.data.frame(data$group)
colnames(temp_df2) = 'Group'
temp_df2$Pred_results = pred_results_median
temp_df2 = temp_df2 %>% mutate(Group = case_when(Group == 0 ~ 'NR', 
                                                 Group == 1 ~ 'CR'))

ggplot(temp_df2, aes(Group, Pred_results, fill=Group)) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  geom_point(colour = 'black', size = 2) +
  ggtitle(NULL) + xlab(NULL) + ylab("Model Prediction") +
  theme_bw() +
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 30, hjust = 0.5),
        legend.position='none',
        aspect.ratio=1,
        panel.grid=element_blank(),
        strip.text=element_text(size = 28, hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_fill_manual(values = c("#800080","#E0B0FF")) +
  scale_x_discrete(limits=c('NR','CR'))



rocplot <- function(pred, truth, ...) {
  predob = prediction(pred, truth)
  perf = performance(predob, "tpr", "fpr")
  plot(perf, ...)
  segments(x0=0, y0=0, x1=1, y1=1, col="gray", lty=2)
}

par(cex.axis=1.5,cex.lab=1.5)
rocplot(pred_results_median, data$group, col="blue") +
  title("ROC Curve", cex.main=2)
par(cex.axis=1.0,cex.lab=1.0)
```

Create plots with the LASSO regression coefficients (log-odds)

```{r}
# NR vs TCMR
cell_populations = as.data.frame(c('Resident memory CD4+ T-cells','HLADR+ M2 macrophages','CD16+ M2 macrophages',
                                   'Non-classical Monocytes','Intermediate monocytes','PD1+ CD4+ T-cells',
                                   'Proliferating Hepatocytes','Cholangiocytes'))
colnames(cell_populations) = 'Variable'
cell_populations$Coefficient = c(-8.54,26.26,-7.17,8.23,-5.17,17.75,47.59,-5.56)
cell_populations

cell_populations$OR = exp(cell_populations$Coefficient)
cell_populations

cell_populations = cell_populations %>% dplyr::mutate(color = case_when(Coefficient > 0 ~ 'UP',
                                                Coefficient < 0 ~ 'DOWN',
                                                T ~ 'N'))

ggplot(data = cell_populations, aes(x = Coefficient, y = Variable, fill=color)) +
  geom_col(position = position_dodge(width = 1), width=0.5) +
  theme_bw() +
  ggtitle(NULL) + ylab(NULL) + xlab("Coefficient (Log-Odds)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_continuous(limits=c(-20,50), breaks=c(-15,0,15,30,45)) +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = c("#E0B0FF","#DA70D6"))

# TCMR vs CR
cell_populations = as.data.frame(c('Plasma cells','Proliferating CD8+ T-cells','Cholangiocytes',
                                   'Proliferating M1 macrophages','CD16+ CD4+ T-cells','PD1+ CD8+ T-cells',
                                   'CD3+ CD4+ T-cells','CD16+ M1 macrophages','CD3+ CD8+ T-cells'))
colnames(cell_populations) = 'Variable'
cell_populations$Coefficient = c(-439.86,-25.01,-0.28,-68.47,-12.72,-5.95,-0.76,-5.51,2.1)
cell_populations

cell_populations$OR = exp(cell_populations$Coefficient)
cell_populations

cell_populations = cell_populations %>% dplyr::mutate(color = case_when(Coefficient > 0 ~ 'UP',
                                                Coefficient < 0 ~ 'DOWN',
                                                T ~ 'N'))

ggplot(data = cell_populations, aes(x = Coefficient, y = Variable, fill=color)) +
  geom_col(position = position_dodge(width = 1), width=0.5) +
  theme_bw() +
  ggtitle(NULL) + ylab(NULL) + xlab("Coefficient (Log-Odds)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_continuous(limits=c(-440,100),breaks=c(-300,-150,-50,0,50)) +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = c("#DA70D6","#800080"))

# NR vs CR
cell_populations = as.data.frame(c('CD16+ M2 macrophages','Plasma cells','Resident memory CD4+ T-cells',
                                   'HLADR+ M2 macrophages','CD3+ CD4+ T-cells','Proliferating M1 macrophages'))
colnames(cell_populations) = 'Variable'
cell_populations$Coefficient = c(-7.26,-169.72,-3.33,11.87,1.59,-105.61)
cell_populations

cell_populations$OR = exp(cell_populations$Coefficient)
cell_populations

cell_populations = cell_populations %>% dplyr::mutate(color = case_when(Coefficient > 0 ~ 'UP',
                                                Coefficient < 0 ~ 'DOWN',
                                                T ~ 'N'))

ggplot(data = cell_populations, aes(x = Coefficient, y = Variable, fill=color)) +
  geom_col(position = position_dodge(width = 1), width=0.5) +
  theme_bw() +
  ggtitle(NULL) + ylab(NULL) + xlab("Coefficient (Log-Odds)") +
  theme(axis.text=element_text(size=20),
        axis.title=element_text(size=30),
        plot.title=element_text(size = 34, hjust = 0.5),
        legend.position='none',
        panel.grid = element_blank(),
        aspect.ratio=1,
        strip.text=element_text(size = 34, hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5)) +
  scale_x_continuous(limits=c(-200,50),breaks=c(-150,-50,0,50)) +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = c("#E0B0FF","#800080"))
```

Tissue visuals for NR vs TCMR coefficients and TCMR vs CR coefficients

```{r}
##############
# NR vs TCMR #
##############
plotCells(mask = all_masks[c(87)],
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'), 
          colour = list(Subcluster = c("Proliferating Hepatocytes" = '#B70404', 
                                       "HLADR+ M2 macrophages" = '#FFEA00',
                                       "PD1+ CD4+ T-cells" = "hotpink", 
                                       "Non-classical monocytes" = '#F79327', 
                                       
                                       "Resident memory CD4+ T-cells" = "#526D82", 
                                       "Intermediate monocytes" = '#B799FF',
                                       "Cholangiocytes" = '#8294C4', 
                                       "CD16+ M2 macrophages" = '#19A7CE', 
                                       
                                       "CD3+ CD4+ T-cells" = "white",
                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       "CD16+ CD4+ T-cells" = "white",
                                        
                                        "CD3+ CD8+ T-cells" = 'white',
                                        "Proliferating CD8+ T-cells" = 'white',
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M1 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        "CD16+ M1 macrophages" = 'white',
                                        
                                        "Classical monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "HLADR+ Hepatocytes" = 'white',
                                       
                                        "Endothelial cells" = 'white',
                                        "Proliferating Endothelial cells" = 'white',
                                        "HLADR+ Endothelial cells" = 'white',

                                        "Proliferating Cholangiocytes" = 'white',
                                        "HLADR+ Cholangiocytes" = 'white',
                                       
                                        "Neutrophils" = 'white',
                                        "Plasma cells" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_PredModNRvsTCMR_TCMR.tiff'),
          display = "single")

##############
# TCMR vs CR #
##############
plotCells(mask = all_masks[c(9)], 
          object = sce_adult_labelled,
          cell_id = "ObjectNumber", img_id = "sample_id", 
          colour_by = 'Subcluster',
          outline_by = 'group',
          image_title = list(text=c(''), colour='darkgray'), 
          colour = list(Subcluster = c("Proliferating M1 macrophages" = '#B70404', 
                                       "Proliferating CD8+ T-cells" = '#FF6000',
                                       "Plasma cells" = 'hotpink', 
                                       "CD3+ CD4+ T-cells" = "#FFAE6D", 
                                       "CD16+ CD4+ T-cells" = "#E6B325", 
                                       "CD16+ M1 macrophages" = '#FF8FB1',
                                       "Cholangiocytes" = '#FFEA00',
                                       
                                       "CD3+ CD8+ T-cells" = '#19A7CE', 
                                       
                                       "Proliferating Hepatocytes" = 'white', 
                                       "HLADR+ M2 macrophages" = 'white', 
                                       "PD1+ CD4+ T-cells" = "white", 
                                       "Non-classical monocytes" = 'white', 
                                       "Resident memory CD4+ T-cells" = "white", 
                                       "Intermediate monocytes" = 'white', 
                                       "CD16+ M2 macrophages" = 'white', 

                                       "Activated CD4+ T-cells" = "white",
                                       "Naive CD4+ T-cells" = "white",
                                       "HLADR+ CD4+ Tregs" = "white",
                                       "HLADR- CD4+ Tregs" = "white",
                                       "Proliferating CD4+ T-cells" = "white",
                                       
                                        "Cytotoxic T-cells" = 'white',
                                        "PD1+ CD8+ T-cells" = 'white',
                                        "PD1+CD28+ CD8+ T-cells" = 'white',
                                        
                                        "M1 macrophages" = 'white',
                                        "M2 macrophages" = 'white',
                                        "Proliferating M2 macrophages" = 'white',
                                        "CD11b+ M1 macrophages" = 'white',
                                        "CD11b+ M2 macrophages" = 'white',
                                        
                                        "Classical monocytes" = 'white',
                                        "Activated monocytes" = 'white',
                                        
                                        "B cells" = 'white',
                                        "Proliferating B cells" = 'white',
                                        "PD1+ B cells" = 'white',
                          
                                        "Hepatocytes" = 'white',
                                        "HLADR+ Hepatocytes" = 'white',
                                       
                                        "Endothelial cells" = 'white',
                                        "Proliferating Endothelial cells" = 'white',
                                        "HLADR+ Endothelial cells" = 'white',

                                        "Proliferating Cholangiocytes" = 'white',
                                        "HLADR+ Cholangiocytes" = 'white',
                                       
                                        "Neutrophils" = 'white'),
                        group = c(NR = 'black', CR = 'black', TCMR = 'black')
          ),
          legend = list(colour_by.legend.cex=1.5,margin=1),
          # save_plot = list(filename='Tissue_PredModTCMRvsCR_CR.tiff'),
          display = "single")
```

```{r}
sessionInfo()
```
